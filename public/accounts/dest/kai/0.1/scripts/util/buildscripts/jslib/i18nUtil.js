define("util/buildscripts/jslib/i18nUtil",["dojo","dijit","dojox","dojo/loadInit!util/buildscripts/jslib/i18nUtil-loadInit"],function(dojo,dijit,dojox){i18nUtil={},i18nUtil.setup=function(e){"undefined"!=typeof djConfig&&"undefined"!=typeof dojo&&dojo.i18n||(djConfig={locale:"xx",extraLocale:e.localeList,baseUrl:buildScriptsPath+"../../dojo/"},load(buildScriptsPath+"../../dojo/dojo.js"),dojo.baseUrl="./",buildUtil.configPrefixes(e.profileProperties.dependencies.prefixes),dojo.require("dojo.i18n"))},i18nUtil.flattenLayerFileBundles=function(fileName,fileContents,kwArgs){var destDirName=fileName.replace(/\/[^\/]+$/,"/")+"nls",nlsNamePrefix=fileName.replace(/\.js$/,"");nlsNamePrefix=nlsNamePrefix.substring(nlsNamePrefix.lastIndexOf("/")+1,nlsNamePrefix.length),i18nUtil.setup(kwArgs);var djLoadedBundles=[],drl=dojo.requireLocalization,dupes={};dojo.requireLocalization=function(modulename,bundlename,locale){var dupName=[modulename,bundlename,locale].join(":");dupes[dupName]||(drl(modulename,bundlename,locale),djLoadedBundles.push({modulename:modulename,module:eval(modulename),bundlename:bundlename}),dupes[dupName]=1)};var requireStatements=fileContents.match(/dojo\.requireLocalization\(.*\)\;/g);if(requireStatements){eval(requireStatements.join(";"));for(var djBundlesByLocale={},jsLocale,entry,bundle,i=0;i<djLoadedBundles.length;i++){entry=djLoadedBundles[i],bundle=entry.module.nls[entry.bundlename];for(jsLocale in bundle)djBundlesByLocale[jsLocale]||(djBundlesByLocale[jsLocale]=[]),djBundlesByLocale[jsLocale].push(entry)}localeList=[];var mkdir=!1,dir=new java.io.File(destDirName),modulePrefix=buildUtil.mapPathToResourceName(fileName,kwArgs.profileProperties.dependencies.prefixes),lastDot=modulePrefix.lastIndexOf(".");if(-1==lastDot)throw"Invalid module prefix for flattened bundle: "+modulePrefix;modulePrefix=modulePrefix.substring(0,lastDot+1)+"nls."+modulePrefix.substring(lastDot+1,modulePrefix.length);for(jsLocale in djBundlesByLocale){var locale=jsLocale.replace(/\_/g,"-");mkdir||(dir.mkdir(),mkdir=!0);var outFile=new java.io.File(dir,nlsNamePrefix+"_"+locale+".js"),parentDir=outFile.getParentFile();if(!parentDir.exists()&&!parentDir.mkdirs())throw"Could not create directory: "+parentDir.getAbsolutePath();var os=new java.io.BufferedWriter(new java.io.OutputStreamWriter(new java.io.FileOutputStream(outFile),"utf-8"));try{os.write('dojo.provide("'+modulePrefix+"_"+locale+'");');for(var j=0;j<djLoadedBundles.length;j++){entry=djLoadedBundles[j];var bundlePkg=[entry.modulename,"nls",entry.bundlename].join("."),translationPkg=[bundlePkg,jsLocale].join(".");bundle=entry.module.nls[entry.bundlename],bundle[jsLocale]&&(os.write('dojo.provide("'+bundlePkg+'");'),os.write(bundlePkg+"._built=true;"),os.write('dojo.provide("'+translationPkg+'");'),os.write(translationPkg+"="+dojo.toJson(bundle[jsLocale])+";"))}}finally{os.close()}localeList.push(locale)}fileContents=fileContents.replace(/dojo\.requireLocalization\(.*\)\;/g,"");var preloadCall='\ndojo.i18n._preloadLocalizations("'+modulePrefix+'", '+dojo.toJson(localeList.sort())+");\n";i18nUtil.preloadInsertionRegExp.lastIndex=0,fileContents.match(i18nUtil.preloadInsertionRegExp)?(i18nUtil.preloadInsertionRegExp.lastIndex=0,fileContents=fileContents.replace(i18nUtil.preloadInsertionRegExp,preloadCall)):fileContents+=preloadCall}return fileContents},i18nUtil.preloadInsertionRegExp=/\/\/INSERT dojo.i18n._preloadLocalizations HERE/,i18nUtil.flattenDirBundles=function(e,l,i,n){i18nUtil.setup(i);for(var o=fileUtil.getFilteredFileList(l,/\.js$/,!0),t=i.profileProperties.dependencies.prefixes,a=0;a<o.length;a++){var r=String(o[a]),d=null;d=r.match(/\/nls\//)&&!r.match(n)?"("+i18nUtil.makeFlatBundleContents(e,l,r)+")":i18nUtil.modifyRequireLocalization(readText(r),t),d&&fileUtil.saveUtf8File(r,d)}},i18nUtil.modifyRequireLocalization=function(e,l){e=String(e);var i=e;return e.match(buildUtil.globalRequireLocalizationRegExp)&&(i=e.replace(buildUtil.globalRequireLocalizationRegExp,function(e){var i=e,n=e.match(buildUtil.requireLocalizationRegExp),o=n[1],t=n[2];if("requireLocalization"==o){var a=i18nUtil.getRequireLocalizationArgsFromString(t);if(a.moduleName){var r=i18nUtil.getLocalesForBundle(a.moduleName,a.bundleName,l);a.localeName||(t+=", null"),t+=', "'+r.join(",")+'"',i="dojo."+o+"("+t+")"}}return i})),i},i18nUtil.makeFlatBundleContents=function(e,l,i){var n=i18nUtil.getBundlePartsFromFileName(e,l,i);if(!n)return null;var o=n.moduleName,t=n.bundleName,a=n.localeName;dojo.requireLocalization(o,t,a);var r=dojo.getObject(o),d=a?a.replace(/-/g,"_"):"ROOT",u=r.nls[t][d];if(!u)throw"Cannot create flattened bundle for src file: "+i;return dojo.toJson(u)},i18nUtil.getLocalesForBundle=function(e,l,i){for(var n=buildUtil.mapResourceToPath(e,i),o=new RegExp("nls[/]?([\\w\\-]*)/"+l+".js$"),t=fileUtil.getFilteredFileList(n+"nls/",o,!0),a=[],r=0;r<t.length;r++){var d=t[r].match(o);d&&d[1]?a.push(d[1]):a.push("ROOT")}return a.sort()},i18nUtil.getRequireLocalizationArgsFromString=function(e){var l={moduleName:null,bundleName:null,localeName:null},i=e.split(/\,\s*/);return i&&i.length>1&&(l.moduleName=i[0]?i[0].replace(/\"/g,""):null,l.bundleName=i[1]?i[1].replace(/\"/g,""):null,l.localeName=i[2]),l},i18nUtil.getBundlePartsFromFileName=function(e,l,i){var l=l.replace(/\.\.\//g,""),n=i.lastIndexOf(l);if(-1!=n){var o=n+l.length;"/"!=l.charAt(l.length)&&(o+=1),i=i.substring(o,i.length)}for(var t=i.split("/"),a=[e],r=0;"nls"!=t[r];r++)a.push(t[r]);var d=a.join(".");if(t[r+1].match(/\.js$/))var u="",s=t[r+1];else var u=t[r+1],s=t[r+2];return s&&-1!=s.indexOf(".js")?(s=s.replace(/\.js/,""),{moduleName:d,bundleName:s,localeName:u}):null}});
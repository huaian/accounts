define("util/doh/robot",["doh/_browserRunner","require","dojo/aspect","dojo/Deferred","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/_base/lang","dojo/ready","dojo/_base/unload","dojo/when","dojo/_base/window","dojo/sniff","dojo/has","dojo/has!android?doh/plugins/android-webdriver-robot"],function(e,o,t,n,r,i,s,u,l,a,d,c,f,m,b){var h,p=null,_=function(){var e=Math.random();return function(o){return e}}(),v=function(e,o,t,n,r,i,s,u){p.typeKey(_(),Number(e),Number(o),Boolean(t),Boolean(n),Boolean(r),Boolean(i),Number(s||0),Boolean(u||!1))};t.before(e,"_runFixture",function(){var e=h;setTimeout(function(){e&&!e.isFulfilled()&&e.cancel(new Error("new test starting, cancelling pending & in-progress queued events from previous test"))},0),h=new n,h.resolve(!0)});var y={x:5,y:5},g=e.robot={_robotLoaded:!0,_robotInitialized:!1,_spaceReceived:!1,_primePump:!1,_killApplet:function(){},killRobot:function(){g._robotLoaded&&(g._robotLoaded=!1,r.remove(document.documentElement,"dohRobot"),g._killApplet())},_runsemaphore:{lock:["lock"],unlock:function(){try{return this.lock.shift()}catch(e){return null}}},startRobot:function(){return this._robotInitialized||(this._robotInitialized=!0,g._appletDead?g._onKeyboard():p._callLoaded(_())),this._started},_loaded:new e.Deferred,_initRobot:function(o){e._initRobotCalled||(e._initRobotCalled=!0,r.add(document.documentElement,"dohRobot"),window.scrollTo(0,0),p=o,p._setKey(_()),this._loaded.resolve(!0))},_started:new e.Deferred,_run:function(e){e.style.visibility="hidden",this._started.resolve(!0)},_initKeyboard:function(){p._initKeyboard(_())},_onKeyboard:function(){this._run({style:{visibility:""}})},_initWheel:function(){p._initWheel(_())},_setDocumentBounds:function(e,o){var t=document.getElementById("dohrobotview");p.setDocumentBounds(_(),Number(e),Number(o),Number(t.offsetLeft),Number(t.offsetTop))},_notified:function(e){p._notified(_(),e)},_appletDead:!1,_assertRobot:function(){if(g._appletDead)throw new Error("robot not available; skipping test.")},_mouseMove:function(e,o,t,n){if(t){var r={y:window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,x:window.pageXOffset||s.fixIeBiDiScrollLeft(document.documentElement.scrollLeft)||document.body.scrollLeft||0};o-=r.y,e-=r.x}p.moveMouse(_(),Number(e),Number(o),Number(0),Number(n||100))},sequence:function(e,o,t){function r(e){return function(){var o,t;return t=new n(function(){clearTimeout(o)}),o=setTimeout(function(){t.resolve(!0)},e),t}}o&&(h=h.then(r(o))),h=h.then(e),t&&(h=h.then(r(t)))},typeKeys:function(e,o,t){this._assertRobot();var n=typeof e==Number;if(t=t||(n?50:50*e.length),n)this.sequence(u.partial(v,e,e,!1,!1,!1,!1,0,0),o,t);else for(var r=0;r<e.length;r++)this.sequence(u.partial(v,e.charCodeAt(r),0,!1,!1,!1,!1,0,0),0==r?o:0,Math.max(Math.ceil(t/e.length),0))},keyPress:function(e,o,t,n){if(this._assertRobot(),t)for(var r=["alt","ctrl","shift","meta"],i=0;i<r.length;i++)t[r[i]]||(t[r[i]]=!1);else t={alt:!1,ctrl:!1,shift:!1,meta:!1};var s="string"==typeof e;return n?void v(s?e.charCodeAt(0):0,s?0:e,t.alt,t.ctrl,t.shift,t.meta,o,!0):void this.sequence(function(){v(s?e.charCodeAt(0):0,s?0:e,t.alt,t.ctrl,t.shift,t.meta,0)},o)},keyDown:function(e,o){this._assertRobot(),this.sequence(function(){var o="string"==typeof e;p.downKey(_(),o?e:0,o?0:e,0)},o)},keyUp:function(e,o){this._assertRobot(),this.sequence(function(){var o="string"==typeof e;p.upKey(_(),o?e:0,o?0:e,0)},o)},mouseClick:function(e,o){this._assertRobot(),g.mousePress(e,o),g.mouseRelease(e,1)},mousePress:function(e,o){this._assertRobot(),e&&this.sequence(function(){for(var o=["left","middle","right"],t=0;t<o.length;t++)e[o[t]]||(e[o[t]]=!1);p.pressMouse(_(),Boolean(e.left),Boolean(e.middle),Boolean(e.right),Number(0))},o)},mouseMoveTo:function(e,o,t,n){function r(e){function o(e,o,t,n){return e/=n/2,1>e?Math.round(t/2*e*e+o):(e--,Math.round(-t/2*(e*(e-2)-1)+o))}var t=e==a?l.x:o(e,i.x,l.x-i.x,a),n=e==a?l.y:o(e,i.y,l.y-i.y,a);return t==y.x&&n==y.y?!0:(p.moveMouse(_(),Number(t),Number(n),Number(0),Number(1)),void(y={x:t,y:n}))}this._assertRobot(),t=t||100;var i,l,a=1>=t?1:t/15|1,d=Math.floor(t/a);this.sequence(function(){if(i=y,n){var o={y:window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,x:window.pageXOffset||s.fixIeBiDiScrollLeft(document.documentElement.scrollLeft)||document.body.scrollLeft||0};l={y:e.y-o.y,x:e.x-o.x}}else l=e},o||0);for(var c=1;a>=c;c++)this.sequence(u.partial(r,c),0,d)},mouseMove:function(e,o,t,n,r){this.mouseMoveTo({x:e,y:o},t,n,r)},mouseRelease:function(e,o){this._assertRobot(),e&&this.sequence(function(){for(var o=["left","middle","right"],t=0;t<o.length;t++)e[o[t]]||(e[o[t]]=!1);p.releaseMouse(_(),Boolean(e.left),Boolean(e.middle),Boolean(e.right),Number(0))},o)},mouseWheelSize:1,mouseWheel:function(e,o,t){this._assertRobot(),e&&this.sequence(function(){p.wheelMouse(_(),Number(e),Number(0),Number(t||0))},o,t)},setClipboard:function(e,o){"text/html"===o?p.setClipboardHtml(_(),e):p.setClipboardText(_(),e)}};l(function(){for(var e,t=document.getElementsByTagName("script"),n=0;n<t.length;n++){var r=t[n].getAttribute("src");if(r&&"runner.js"==r.substr(r.length-9)){e=r.substr(0,r.length-9)+"Robot.html";break}}if(e||(e=o.toUrl("./Robot.html")+"?domain="+escape(document.domain)),i.place('<div id="dohrobotview" style="border:0px none; margin:0px; padding:0px; position:absolute; bottom:0px; right:0px; width:1px; height:1px; overflow:hidden; visibility:hidden; background-color:red;"></div>',c.body()),m("doh-custom-robot")){p=b;for(var s in p)g[s]&&p[s]&&(g[s]=p[s]);g._initRobot(p)}else i.place('<iframe application="true" style="border:0px none; z-index:32767; padding:0px; margin:0px; position:absolute; left:0px; top:0px; height:100px; width:200px; overflow:hidden; background-color:transparent;" tabIndex="-1" src="'+e+'" ALLOWTRANSPARENCY="true"></iframe>',c.body())}),e.registerGroup("initialize robot",[{name:"load robot",timeout:2e4,runTest:function(){return g._loaded}},{name:"start robot",timeout:2e4,runTest:function(){return g.startRobot()}}]);var x=e.run;return e.run=function(){e.registerGroup("kill robot",{name:"killRobot",timeout:1e4,runTest:function(){g.killRobot()}}),e.run=x,e.run()},g});
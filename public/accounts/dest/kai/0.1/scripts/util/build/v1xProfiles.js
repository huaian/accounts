// map from top-level mid --> copyright message (usually undefined)

// copyright is relaxed in 1.7+: it can be a string or a filename

define("util/build/v1xProfiles",["require","./buildControlBase","./fs","./fileUtils"],function(require,bc,fs,fileUtils){eval(require.scopeify("./fs, ./fileUtils"));var mix=function(e,o){e=e||{},o=o||{};for(var r in o)e[r]=o[r];return e},defaultBuildProps={staticHasFeatures:{},defaultConfig:{hasCache:{}}},processProfile=function(e,o,r,a){var s,i={},t=e.layers||[],n=e.prefixes||[];for(s in defaultBuildProps)i[s]=defaultBuildProps[s];for(s in e)if(/^(loader|xdDojoPath|scopeDjConfig|xdScopeArgs|xdDojoScopeName|expandProvide|buildLayers|query|removeDefaultNameSpaces|addGuards)$/.test(s))bc.log("inputDeprecated",["switch",s]);else if("staticHasFeatures"==s)mix(i.staticHasFeatures,e.staticHasFeatures);else if("defaultConfig"==s)for(s in e.defaultConfig)"hasCache"==s?mix(i.defaultConfig.hasCache,e.defaultConfig.hasCache):i.defaultConfig[s]=e.defaultConfig[s];else i[s]="false"==e[s]?!1:e[s];var l={},c={},d={};n.forEach(function(e){var o=e[0];l[o]=e[1],c[o]=e[2]&&(maybeRead(computePath(e[2],r))||maybeRead(computePath(e[2],a))||e[2])||"",d[o]=e[3]});var u=i.basePath=r;l.dojo||(l.dojo=o),l.dojo=computePath(l.dojo,u),l.dojo!=o&&bc.log("buildUsingDifferentDojo"),o=l.dojo;for(var f in l)"dojo"!=f&&(l[f]=computePath(l[f],o));i.releaseDir=computePath((e.releaseDir||"../../release").replace(/\\/g,"/"),u),"undefined"==typeof e.releaseName&&(e.releaseName="dojo"),e.releaseName||(e.releaseName=""),i.releaseName=e.releaseName.replace(/\\/g,"/");var p=i.packages=[];for(f in l)p.push({name:f,location:l[f],copyright:void 0!==c[f]?c[f]:bc.defaultCopyright,runtime:d[f]});var m=function(e,o){if(void 0!==e)return e;var r=c[o.split("/",1)[0]];return r?r:bc.defaultCopyright+bc.defaultBuildNotice},j=function(e){return e?e.map(function(e){return b[e=e.replace(/\./g,"/")]=1,e}):[]},g=function(e,o){return e?e.map(function(e){if(!/\//.test(e)&&!/\.js$/.test(e))return b[e.split(".")[0]]=1,e;var r;return/^\.\//.test(e)&&(e=e.substring(2)),"dojo/dojo"==e?e:"dojo.js"==e?"dojo/dojo":(r=e.match(h))?(b[r[1]]=1,r[1]):(r=e.match(y))?(bc.log("assumeLayerDependencyIsDojoModule",["layer dependency",e]),r[1]):(bc.log("cannotDeduceModuleIdFrom16LayerDependency",["layer name",o,"layer dependency name",e]),"error")}):[]},h=/^\.\.\/([^\.].*)\.js$/,y=/^([^\.].*)\.js$/,b={},v={};t.forEach(function(e){var o,r;e.resourceName?r=e.resourceName.replace(/\./g,"/"):(r=e.name,/^\.\//.test(r)&&(r=r.substring(2)),"dojo.js"==e.name?(r="dojo/dojo",e.customBase||e.dependencies.push("dojo/main"),e.boot=!0):(o=r.match(h))?r=o[1]:(o=r.match(y))?(r="dojo/"+o[1],bc.log("assumeLayerIsDojoModule",["layer name",e.name])):bc.log("cannotDeduceModuleIdFrom16LayerName",["layer name",e.name])),e.include=j(e.dependencies),e.exclude=g(e.layerDependencies,e.name),"dojo/dojo"==r||e.customBase||e.exclude.push("dojo/dojo"),e.name=r,b[r.split("/")[0]]=1,e.copyright=m(e.copyright,r),v[r]=e});for(s in b){var x=s.split("/")[0];l[x]||bc.log("missingPrefix",["top-level module",x])}return i.layers=v,i},processHtmlFiles=function(e,o,r){bc.log("processHtmlFiles",["files",e.join(", ")]);var a="",s={},i="",t={dijit:!0,dojox:!0};e.forEach(function(e){var o=[],r=function(e){s[e]?s[e]=s[e].filter(function(e){return o.indexOf(e)>-1}):s[e]=o.concat(),e.indexOf(".")>-1&&(t[e.substring(e,e.indexOf("."))]=!0),o.push(e)},n=fs.readFileSync(e,"utf8");n.replace(/<script [^>]*src=["']([^'"]+)["']/gi,function(o,s){s.indexOf("dojo/dojo.js")>-1?(i=s.substring(0,s.indexOf("dojo/dojo.js")),a||(a=fileUtils.getFilepath(e))):r(s=s.substring(i.length,s.length-3).replace(/\//g,"."))}),n.replace(/dojo\.require\(["']([^'"]+)["']\)/g,function(e,o){r(o)})});var n=[];for(i in t)n.push([i,"../"+i]);var l=[];for(var c in s)l.push({name:"../"+c.replace(/\./g,"/")+".js",dependencies:[c.replace(/\//g,".")],layerDependencies:s[c].map(function(e){return"../"+e.replace(/\./g,"/")+".js"})});var d={layers:l,prefixes:n,basePath:a};return processProfile(d,o,r)};return{processProfile:processProfile,processHtmlFiles:processHtmlFiles}});
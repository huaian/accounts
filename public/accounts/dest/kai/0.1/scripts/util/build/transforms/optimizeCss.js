define("util/build/transforms/optimizeCss",["../buildControl","../fileUtils","dojo/_base/lang"],function(e,t,r){var i=/\@import\s+(url\()?\s*([^);]+)\s*(\))?([\w, ]*)(;)?/g,n=/url\(\s*([^\)]+)\s*\)?/g,s=function(e){return e.replace(/\\/g,"/")},o=e.cssImportIgnore?e.cssImportIgnore.split(",").map(function(e){return r.trim(e)}).join(",")+",":"",c=function(e){return e=r.trim(e),("'"==e.charAt(0)||'"'==e.charAt(0))&&(e=e.substring(1,e.length-1)),e},l=function(t,r){for(var i,n=t,s=-1;-1!=(s=t.indexOf("/*"));){if(i=t.indexOf("*/",s+2),-1==i)return e.log("cssOptimizeImproperComment",["CSS file",r]),n;t=t.substring(0,s)+t.substring(i+2,t.length)}return t},p=function(e){var t=e.indexOf(":");return"/"!=e.charAt(0)&&(-1==t||t>e.indexOf("/"))},a=function(e,t){var r=e.split("/"),i=t.dest.split("/");for(r.pop();r.length&&i.length&&r[0]==i[0];)r.shift(),i.shift();for(var n=0;n<r.length;n++)i.unshift("..");return i.join("/")},u=function(t,r,i){var n=e.resources[r];return n?a(t,n):(e.log("cssOptimizeUnableToResolveURL",i),0)},f=function(g){if(!g.optimizedText){var m=g.dest,d=g.src,h=t.getFilepath(s(d)),v=g.text,O=[];v=l(v,d),v=v.replace(i,function(i,l,v,O,z){v=s(c(v));var x,S=p(v)?t.compactPath(t.catPath(h,v)):v,C=e.resources[S],I=!1;if((o&&-1!=o.indexOf(v+",")||C&&C.tag.importIgnore)&&(I=!0,e.log("cssOptimizeIgnored",["CSS file",d,"import directive",i])),z&&"all"!=r.trim(z)&&(I=!0,e.log("cssOptimizeIgnoredMultiMediaTypes",["CSS file",d,"import directive",i])),I)return p(v)&&(x=u(m,S,["CSS file",d,"import directive",i]))?'@import url("'+x+'")'+(z||"")+";":i;if(!C)return e.log("cssOptimizeIgnoredNoResource",["CSS file",d,"import directive",i]),i;f(C);var b=C.optimizedText,T=t.getFilepath(C.dest);return b.replace(n,function(r,i){var n=s(c(i)),o="",l=n.search(/[?#]/);if(l>0&&(o=n.slice(l),n=n.slice(0,l)),p(n)){var u=t.compactPath(t.catPath(T,n)),f=e.resourcesByDest[u];if(f)return'url("'+a(g.dest,f)+o+'")';e.log("cssOptimizeUnableToResolveURL",["CSS file",d,"import",C.src,"relative URL",r])}return r})}),v=v.replace(i,function(e){return O.push(e),""}),O.length&&(v=O.join("\n")+"\n"+v),v=/keepLines/i.test(e.cssOptimize)?v.replace(/(\r\n)+/g,"\r\n").replace(/\n+/g,"\n"):v.replace(/[\r\n]/g,"").replace(/\s+/g," ").replace(/\{\s/g,"{").replace(/\s\}/g,"}"),g.optimizedText=v,g.tag.noOptimize||(g.rawText=g.text,g.text=v)}};return function(t,r){try{e.cssOptimize&&!t.tag.noOptimize&&(f(t),e.log("cssOptimize",["file",t.src]))}catch(i){e.log("cssOptimizeFailed",["file",t.src,"error",i])}}});
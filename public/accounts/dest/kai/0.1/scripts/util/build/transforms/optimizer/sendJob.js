define("util/build/transforms/optimizer/sendJob",["../../buildControl","../../fileUtils","dojo/has"],function(t,i,e){var n=[],s=function(){n.forEach(function(t){try{t.runner&&t.runner.kill(),t.runner=0}catch(i){}})};global.process.on("exit",s),global.process.on("uncaughtException",function(t){s(),global.process.exit(-1)}),t.maxOptimizationProcesses<0&&(t.maxOptimizationProcesses=require.nodeRequire("os").cpus().length);var o,r,u=0,a="",c=0,p=function(i,e,s,o){n[c++].write(i,e,s,o),c%=t.maxOptimizationProcesses},l=new RegExp("^Done\\s\\(compile\\stime.+$","m"),m=require.toUrl("build/optimizeRunner.js"),f=m.match(/(.+)\/build\/optimizeRunner\.js$/)[1],h=p,g=require.nodeRequire("child_process"),d="cygwin"===global.process.platform,z=e("is-windows")?";":":",w=i.catPath(f,"closureCompiler/compiler.jar")+z+i.catPath(f,"shrinksafe/js.jar")+z+i.catPath(f,"shrinksafe/shrinksafe.jar");return d?(r=function(t){g.exec("cygpath -wp '"+w+"'",function(i,e){w=e.trim(),g.exec("cygpath -w '"+m+"'",function(i,e){m=e.trim(),t()})})},p=function(t,i,e,n){g.exec("cygpath -wp '"+t+"'",function(t,s){g.exec("cygpath -wp '"+i+"'",function(t,i){h(s.trim(),i.trim(),e,n)})})}):e("is-windows")?(r=function(t){w=i.normalize(w),m=i.normalize(m),t()},p=function(t,e,n,s){var o=i.normalize(t),r=i.normalize(e);h(o,r,n,s)}):r=function(t){t()},r(function(){for(o=0;o<t.maxOptimizationProcesses;o++)!function(){var i=g.spawn("java",["-cp",w,"org.mozilla.javascript.tools.shell.Main",m]),e={runner:i,results:"",tempResults:"",sent:[],write:function(n,s,o,r){e.sent.push(s),i.stdin.write(n+"\n"+s+"\n"+o+"\n"+JSON.stringify({copyright:r,options:t.optimizeOptions,useSourceMaps:t.useSourceMaps})+"\n")},sink:function(i){e.tempResults+=i;for(var n,s,o;n=e.tempResults.match(l);)s=n[0],/OPTIMIZER\sFAILED/.test(s)?t.log("optimizeFailed",["module identifier",e.sent.shift(),"exception",s.substring(5)]):t.log("optimizeDone",[e.sent.shift()+" "+s.substring(5)]),o=n.index+s.length,e.results+=e.tempResults.substring(0,o),e.tempResults=e.tempResults.substring(o)}};u++,i.stdout.on("data",function(t){e.sink(t+"")}),i.stderr.on("data",function(t){e.sink(t+"")}),i.on("exit",function(){e.results+=e.tempResults,a+=e.results,t.logOptimizerOutput(a),u--,u||(t.showOptimizerOutput&&t.log("optimizeMessages",[a]),t.passGate())}),n.push(e)}()}),t.gateListeners.push(function(i){"cleanup"===i&&(t.log("pacify","waiting for the optimizer runner to finish..."),t.waiting++,n.forEach(function(t){t.write(".\n")}),n=[])}),p});
define("util/build/transforms/optimizer/uglify",["../../buildControl","../../fs","./stripConsole","dojo/_base/lang","./uglify_worker","../writeAmd","require"],function(e,i,t,o,n,r,s){if(!n)throw new Error("Unknown host environment: only nodejs is supported by uglify optimizer.");if(e.maxOptimizationProcesses){var p,a=s.nodeRequire,l=[],u=a("child_process").fork,d={},m=0,c=s.toUrl("./uglify_worker.js");e.maxOptimizationProcesses<0&&(e.maxOptimizationProcesses=a("os").cpus().length);for(var f=0;f<e.maxOptimizationProcesses;f++)p=u(c),p.on("message",function(e){if(d[e.dest]){var i=d[e.dest];delete d[e.dest],i(e)}}),l.push(p)}return function(o,s,p,a,u){p=p||"";var c=e.optimizeOptions||{};if(c.filename=r.getDestFilename(o).split("/").pop(),a.indexOf(".keeplines")>-1&&(c.gen_options=c.gen_options||{},c.gen_options.beautify=!0,c.gen_options.indent_level=0),a.indexOf(".comments")>-1)throw new Error("'comments' option is not supported by uglify optimizer.");var f=function(t){try{if(t.error)throw t.error;var n=p+"//>>built"+e.newline+t.text;i.writeFile(o.dest,n,o.encoding,function(i){i&&e.log("optimizeFailedWrite",["filename",o.dest]),u(o,i)})}catch(r){e.log("optimizeFailed",["module identifier",o.mid,"exception",r+""]),u(o,0)}};return e.maxOptimizationProcesses?(d[o.dest]=f,l[m].send({text:t(s),options:c,dest:o.dest,useSourceMaps:e.useSourceMaps}),m=(m+1)%l.length):process.nextTick(function(){var i={};try{i.text=n(t(s),c,o.dest,e.useSourceMaps)}catch(r){i.error=r}f(i)}),u}});
define("dgrid/Keyboard",["dojo/_base/declare","dojo/aspect","dojo/dom-class","dojo/on","dojo/_base/lang","dojo/has","./util/misc","dojo/_base/sniff"],function(e,t,o,i,s,n,d){function r(e){e.preventDefault()}var l={checkbox:1,radio:1,button:1},a=/\bdgrid-cell\b/,c=/\bdgrid-row\b/,u=e(null,{pageSkip:10,tabIndex:0,keyMap:null,headerKeyMap:null,postMixInProperties:function(){this.inherited(arguments),this.keyMap||(this.keyMap=s.mixin({},u.defaultKeyMap)),this.headerKeyMap||(this.headerKeyMap=s.mixin({},u.defaultHeaderKeyMap))},postCreate:function(){function e(e){var t=e.target;return t.type&&(!l[t.type]||32===e.keyCode)}function o(o){function n(){if(s._focusedHeaderNode&&(s._focusedHeaderNode.tabIndex=-1),s.showHeader){if(d){for(var e,t=s.headerNode.getElementsByTagName("th"),o=0;e=t[o];++o)if(r.test(e.className)){s._focusedHeaderNode=u=e;break}}else s._focusedHeaderNode=u=s.headerNode;u&&(u.tabIndex=s.tabIndex)}}var d=s.cellNavigation,r=d?a:c,l=o===s.headerNode,u=o;l?(n(),t.after(s,"renderHeader",n,!0)):t.after(s,"renderArray",function(e){var t=s._focusedNode||u;if(r.test(t.className)&&o.contains(t))return e;for(var i,n=o.getElementsByTagName("*"),d=0;i=n[d];++d)if(r.test(i.className)){t=s._focusedNode=i;break}return t.tabIndex=s.tabIndex,e}),s._listeners.push(i(o,"mousedown",function(t){e(t)||s._focusOnNode(t.target,l,t)})),s._listeners.push(i(o,"keydown",function(t){if(!t.metaKey&&!t.altKey){var o=s[l?"headerKeyMap":"keyMap"][t.keyCode];o&&!e(t)&&o.call(s,t)}}))}this.inherited(arguments);var s=this;this.tabableHeader&&(o(this.headerNode),i(this.headerNode,"dgrid-cellfocusin",function(){s.scrollTo({x:this.scrollLeft})})),o(this.contentNode),this._debouncedEnsureScroll=d.debounce(this._ensureScroll,this)},removeRow:function(e){if(!this._focusedNode)return this.inherited(arguments);var t,o=this,i=document.activeElement===this._focusedNode,s=this[this.cellNavigation?"cell":"row"](this._focusedNode),n=s.row||s;e=e.element||e,e===n.element&&(t=this.down(n,!0),t&&t.element!==e||(t=this.up(n,!0)),this._removedFocus={active:i,rowId:n.id,columnId:s.column&&s.column.id,siblingId:t&&t.element!==e?t.id:void 0},setTimeout(function(){o._removedFocus&&o._restoreFocus(n.id)},0),this._focusedNode=null),this.inherited(arguments)},insertRow:function(){var e=this.inherited(arguments);return this._removedFocus&&!this._removedFocus.wait&&this._restoreFocus(e),e},_restoreFocus:function(e){var t,i,s=this._removedFocus;if(e=e&&this.row(e),t=e&&e.element&&e.id===s.rowId?e:"undefined"!=typeof s.siblingId&&this.row(s.siblingId),t&&t.element){if(!t.element.parentNode.parentNode)return void(s.wait=!0);"undefined"!=typeof s.columnId&&(i=this.cell(t,s.columnId),i&&i.element&&(t=i)),s.active&&0!==t.element.offsetHeight?this._focusOnNode(t,!1,null):(o.add(t.element,"dgrid-focus"),t.element.tabIndex=this.tabIndex,this._focusedNode=t.element)}delete this._removedFocus},addKeyHandler:function(e,o,i){return t.after(this[i?"headerKeyMap":"keyMap"],e,o,!0)},_ensureRowScroll:function(e){var t=this.getScrollPosition().y;t>e.offsetTop?this.scrollTo({y:e.offsetTop}):t+this.contentNode.offsetHeight<e.offsetTop+e.offsetHeight&&this.scrollTo({y:e.offsetTop-this.contentNode.offsetHeight+e.offsetHeight})},_ensureColumnScroll:function(e){var t=this.getScrollPosition().x,o=e.offsetLeft;if(t>o)this.scrollTo({x:o});else{var i=this.bodyNode.clientWidth,s=e.offsetWidth,n=o+s;n>t+i&&this.scrollTo({x:i>s?n-i:o})}},_ensureScroll:function(e,t){this.cellNavigation&&(this.columnSets||this.subRows.length>1)&&!t&&this._ensureRowScroll(e.row.element),this.bodyNode.clientWidth<this.contentNode.offsetWidth&&this._ensureColumnScroll(e.element)},_focusOnNode:function(e,t,n){var d,r,l,u,f,h="_focused"+(t?"Header":"")+"Node",m=this[h],v=this.cellNavigation?"cell":"row",g=this[v](e);if(e=g&&g.element){if(this.cellNavigation)for(d=e.getElementsByTagName("input"),f=0,l=d.length;l>f;f++)if(r=d[f],(-1!==r.tabIndex||"_dgridLastValue"in r)&&!r.disabled){r.focus(),u=!0;break}null!==n&&(n=s.mixin({grid:this},n),n.type&&(n.parentType=n.type),n.bubbles||(n.bubbles=!0)),m&&(o.remove(m,"dgrid-focus"),m.removeAttribute("tabindex"),n&&(n[v]=this[v](m),i.emit(m,"dgrid-cellfocusout",n))),m=this[h]=e,n&&(n[v]=g);var N=this.cellNavigation?a:c;!u&&N.test(e.className)&&(e.tabIndex=this.tabIndex,e.focus()),o.add(e,"dgrid-focus"),n&&i.emit(m,"dgrid-cellfocusin",n),this._debouncedEnsureScroll(g,t)}},focusHeader:function(e){this._focusOnNode(e||this._focusedHeaderNode,!0)},focus:function(e){var t=e||this._focusedNode;t?this._focusOnNode(t,!1):this.contentNode.focus()}}),f=u.moveFocusVertical=function(e,t){var o=this.cellNavigation,i=this[o?"cell":"row"](e),s=o&&i.column.id,n=this.down(this._focusedNode,t,!0);o&&(n=this.cell(n,s)),this._focusOnNode(n,!1,e),e.preventDefault()},h=u.moveFocusUp=function(e){f.call(this,e,-1)},m=u.moveFocusDown=function(e){f.call(this,e,1)},v=u.moveFocusPageUp=function(e){f.call(this,e,-this.pageSkip)},g=u.moveFocusPageDown=function(e){f.call(this,e,this.pageSkip)},N=u.moveFocusHorizontal=function(e,t){if(this.cellNavigation){var o=!this.row(e),i=this["_focused"+(o?"Header":"")+"Node"];this._focusOnNode(this.right(i,t),o,e),e.preventDefault()}},p=u.moveFocusLeft=function(e){N.call(this,e,-1)},_=u.moveFocusRight=function(e){N.call(this,e,1)},b=u.moveHeaderFocusEnd=function(e,t){var o;this.cellNavigation&&(o=this.headerNode.getElementsByTagName("th"),this._focusOnNode(o[t?0:o.length-1],!0,e)),e.preventDefault()},y=u.moveHeaderFocusHome=function(e){b.call(this,e,!0)},H=u.moveFocusEnd=function(e,o){var i,d=this.cellNavigation,r=this.contentNode,l=o?0:r.scrollHeight,a=r.scrollTop+l,c=r[o?"firstChild":"lastChild"],u=c.className.indexOf("dgrid-preload")>-1,f=u?c[(o?"next":"previous")+"Sibling"]:c,h=f.offsetTop+(o?0:f.offsetHeight);if(u){for(;f&&f.className.indexOf("dgrid-row")<0;)f=f[(o?"next":"previous")+"Sibling"];if(!f)return}!u||c.offsetHeight<1?(d&&(f=this.cell(f,this.cell(e).column.id)),this._focusOnNode(f,!1,e)):(n("dom-addeventlistener")||(e=s.mixin({},e)),i=t.after(this,"renderArray",function(t){var s=t[o?0:t.length-1];return d&&(s=this.cell(s,this.cell(e).column.id)),this._focusOnNode(s,!1,e),i.remove(),t})),a===h&&e.preventDefault()},w=u.moveFocusHome=function(e){H.call(this,e,!0)};return u.defaultKeyMap={32:r,33:v,34:g,35:H,36:w,37:p,38:h,39:_,40:m},u.defaultHeaderKeyMap={32:r,35:b,36:y,37:p,39:_},u});
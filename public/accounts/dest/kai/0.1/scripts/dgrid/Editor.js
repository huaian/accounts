define("dgrid/Editor",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/dom-construct","dojo/dom-class","dojo/on","dojo/has","dojo/query","./Grid","dojo/_base/sniff"],function(e,t,i,r,n,o,d,s,a){return e(null,{constructor:function(){this._editorInstances={},this._editorColumnListeners=[],this._editorsPendingStartup=[]},postCreate:function(){var e=this;this.inherited(arguments),this.on(".dgrid-input:focusin",function(){e._focusedEditorCell=e.cell(this)}),this._editorFocusoutHandle=o.pausable(this.domNode,".dgrid-input:focusout",function(){e._focusedEditorCell=null}),this._listeners.push(this._editorFocusoutHandle)},insertRow:function(){var e=this.inherited(arguments),t=this.row(e),i=this._previouslyFocusedEditorCell;return i&&i.row.id===t.id&&this.edit(this.cell(t,i.column.id)),e},removeRow:function(e){var t=this,i=this._focusedEditorCell;i&&i.row.id===this.row(e).id&&(this._previouslyFocusedEditorCell=i,this._editorFocusoutHandle.pause(),setTimeout(function(){t._editorFocusoutHandle.resume(),t._previouslyFocusedEditorCell=null},0));for(var r=this._alwaysOnWidgetColumns.length;r--;){var n=this.cell(e,this._alwaysOnWidgetColumns[r].id).element,o=n&&(n.contents||n).widget;o&&(this._editorFocusoutHandle.pause(),o.destroyRecursive())}return this.inherited(arguments)},renderArray:function(){var e=this.inherited(arguments);return e.length?this._startupPendingEditors():this._editorsPendingStartup=[],e},_onNotification:function(){this.inherited(arguments),this._startupPendingEditors()},_destroyColumns:function(){this._editorStructureCleanup(),this.inherited(arguments)},_editorStructureCleanup:function(){var e=this._editorInstances,t=this._editorColumnListeners;this._editTimer&&clearTimeout(this._editTimer);for(var i in e){var r=e[i];r.domNode&&r.destroyRecursive()}this._editorInstances={};for(var n=t.length;n--;)t[n].remove();this._editorColumnListeners=[],this._editorsPendingStartup=[]},_configColumns:function(){var e=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var t=0,i=e.length;i>t;t++)e[t].editor&&this._configureEditorColumn(e[t]);return e},_configureEditorColumn:function(e){var t=e.editor,i=this,r=e.renderCell||this._defaultRenderCell,n=e.editOn,d="string"!=typeof t;n?this._editorInstances[e.id]=this._createSharedEditor(e,r):d&&this._alwaysOnWidgetColumns.push(e),e.renderCell=n?function(t,d,s,a){return a&&a.alreadyHooked||i._editorColumnListeners.push(o(s,n,function(){i._activeOptions=a,i.edit(this)})),r.call(e,t,d,s,a)}:function(t,n,o,s){if(e.canEdit&&!e.canEdit(t,n))return r.call(e,t,n,o,s);var a=i._createEditor(e);i._showEditor(a,e,o,n),o[d?"widget":"input"]=a}},edit:function(e){function t(e){l._activeCell=n,l._showEditor(a,r,n,s),l._editTimer=setTimeout(function(){a.focus&&a.focus(),r._editorBlurHandle&&r._editorBlurHandle.resume(),l._editTimer=null,e.resolve(a)},0)}var r,n,o,d,s,a,u,l=this;if(e.column||(e=this.cell(e)),!e||!e.element)return null;if(r=e.column,d=r.field,n=e.element.contents||e.element,a=this._editorInstances[r.id]){if(this._activeCell!==n){var c=e.row;if(o=this.dirty&&this.dirty[c.id],s=o&&d in o?o[d]:r.get?r.get(c.data):c.data[d],!r.canEdit||r.canEdit(e.row.data,s)){u=new i;var h=a.domNode||a;return h.offsetWidth?(h.blur(),setTimeout(function(){t(u)},0)):t(u),u.promise}}}else if(r.editor&&(a=n.widget||n.input))return u=new i,a.focus&&a.focus(),u.resolve(a),u.promise;return null},_showEditor:function(e,t,i,r){var o=e.domNode;o||this._updateInputValue(e,r),i.innerHTML="",n.add(i,"dgrid-cell-editing"),i.appendChild(e.domNode||e),o&&!t.editOn?this._editorsPendingStartup.push([e,t,i,r]):this._startupEditor(e,t,i,r)},_startupEditor:function(e,t,i,r){e.domNode&&(e._started||e.startup(),e._dgridIgnoreChange=!0,e.set("value",r),setTimeout(function(){e._dgridIgnoreChange=!1},0)),e._dgridLastValue=r,this._activeCell&&(this._activeValue=r,o.emit(i,"dgrid-editor-show",{grid:this,cell:this.cell(i),column:t,editor:e,bubbles:!0,cancelable:!1}))},_startupPendingEditors:function(){for(var e=this._editorsPendingStartup,t=e.length;t--;)this._startupEditor.apply(this,e[t]);this._editorsPendingStartup=[]},_handleEditorChange:function(e,t){var i=e.target;"_dgridLastValue"in i&&i.className.indexOf("dgrid-input")>-1&&this._updatePropertyFromEditor(t||this.cell(i).column,i,e)},_createEditor:function(e){var i,n,s,a,u=e.editor,l=e.editOn,c=this,h="string"!=typeof u&&u,_={};if(i=e.editorArgs||{},"function"==typeof i&&(i=i.call(this,e)),h?(n=new h(i),s=n.focusNode||n.domNode,s.className+=" dgrid-input",n.on(l?"blur":"change",function(){n._dgridIgnoreChange||c._updatePropertyFromEditor(e,this,{type:"widget"})})):(this._hasInputListener||(this._hasInputListener=!0,this.on("change",function(e){c._handleEditorChange(e)})),"textarea"===u?a="textarea":(a="input",_.type=u),n=s=r.create(a,t.mixin(_,{className:"dgrid-input",name:e.field,tabIndex:isNaN(e.tabIndex)?-1:e.tabIndex},i)),d("ie")<9&&("radio"===u||"checkbox"===u?this._editorColumnListeners.push(o(n,"click",function(t){c._handleEditorChange(t,e)})):this._editorColumnListeners.push(o(n,"change",function(t){c._handleEditorChange(t,e)})))),e.autoSelect){var f=n.focusNode||n;f.select&&o(f,"focus",function(){setTimeout(function(){f.select()},0)})}return n},_createSharedEditor:function(e){function i(){var e=c._activeCell;f.blur(),"function"==typeof c.focus&&setTimeout(function(){c.focus(e)},h&&d("ie")<9?15:0)}function s(){var i=_.parentNode,d={alreadyHooked:!0},s=c.cell(_);o.emit(s.element,"dgrid-editor-hide",{grid:c,cell:s,column:e,editor:l,bubbles:!0,cancelable:!1}),e._editorBlurHandle.pause(),i.removeChild(_),s.row&&(n.remove(s.element,"dgrid-cell-editing"),r.empty(i),a.appendIfNode(i,e.renderCell(s.row.data,c._activeValue,i,c._activeOptions?t.delegate(d,c._activeOptions):d))),c._focusedEditorCell=c._activeCell=c._activeValue=c._activeOptions=null}function u(t){var r=t.keyCode||t.which;27===r?(p(),c._activeValue=l._dgridLastValue,i()):13===r&&e.dismissOnEnter!==!1&&i()}var l=this._createEditor(e),c=this,h=l.domNode,_=l.domNode||l,f=l.focusNode||_,p=h?function(){l.set("value",l._dgridLastValue)}:function(){c._updateInputValue(l,l._dgridLastValue),c._updatePropertyFromEditor(e,l)};return this._editorColumnListeners.push(o(f,"keydown",u)),(e._editorBlurHandle=o.pausable(l,"blur",s)).pause(),this._editorColumnListeners.push(e._editorBlurHandle),l},_updatePropertyFromEditor:function(e,t,i){var r,n,o;if((!t.isValid||t.isValid())&&(r=this._updateProperty((t.domNode||t).parentNode,this._activeCell?this._activeValue:t._dgridLastValue,this._retrieveEditorValue(e,t),i),this._activeCell?this._activeValue=r:t._dgridLastValue=r,"radio"===t.type&&t.name&&!e.editOn&&e.field)){o=this.row(t),s("input[type=radio][name="+t.name+"]",this.contentNode).forEach(function(i){var r=this.row(i);i!==t&&i._dgridLastValue&&(i._dgridLastValue=!1,this.updateDirty?this.updateDirty(r.id,e.field,!1):r.data[e.field]=!1)},this);for(n in this.dirty)o.id.toString()!==n&&this.dirty[n][e.field]&&this.updateDirty(n,e.field,!1)}},_updateProperty:function(e,t,i,r){var n=this;if((t&&t.valueOf())!==(i&&i.valueOf())){var d=this.cell(e),s=d.row,a=d.column;if(e=d.element,a.field&&s){var u={grid:this,cell:d,oldValue:t,value:i,bubbles:!0,cancelable:!0};if(r&&r.type&&(u.parentType=r.type),!o.emit(e,"dgrid-datachange",u)){var l;return(l=e.widget)?(l._dgridIgnoreChange=!0,l.set("value",t),setTimeout(function(){l._dgridIgnoreChange=!1},0)):(l=e.input)&&this._updateInputValue(l,t),t}this.updateDirty?(this.updateDirty(s.id,a.field,i),a.autoSave&&setTimeout(function(){n._trackError("save")},0)):s.data[a.field]=i}}return i},_updateInputValue:function(e,t){e.value=t,("radio"===e.type||"checkbox"===e.type)&&(e.checked=e.defaultChecked=!!t)},_retrieveEditorValue:function(e,t){return"function"==typeof t.get?this._convertEditorValue(t.get("value")):this._convertEditorValue(t["checkbox"===t.type||"radio"===t.type?"checked":"value"])},_convertEditorValue:function(e,t){if("number"==typeof t)e=isNaN(e)?e:parseFloat(e);else if("boolean"==typeof t)e="true"===e?!0:"false"===e?!1:e;else if(t instanceof Date){var i=new Date(e);e=isNaN(i.getTime())?e:i}return e}})});
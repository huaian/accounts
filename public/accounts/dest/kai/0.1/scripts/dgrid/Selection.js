define("dgrid/Selection",["dojo/_base/declare","dojo/dom-class","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","dojo/query","dojo/_base/sniff"],function(e,t,n,i,l,s,o){function c(e,t){for(var n=e.unselectable=t?"on":"",i=e.getElementsByTagName("*"),l=i.length;--l;)"INPUT"!==i[l].tagName&&"TEXTAREA"!==i[l].tagName&&(i[l].unselectable=n)}function r(e,t){var s=e.bodyNode,o=t?"text":i("ff")<21?"-moz-none":"none";a&&"msUserSelect"!==a?s.style[a]=o:i("dom-selectstart")?t||e._selectstartHandle?t&&e._selectstartHandle&&(e._selectstartHandle.remove(),delete e._selectstartHandle):e._selectstartHandle=n(s,"selectstart",function(e){var t=e.target&&e.target.tagName;"INPUT"!==t&&"TEXTAREA"!==t&&e.preventDefault()}):(c(s,!t),t||e._unselectableHandle?t&&e._unselectableHandle&&(e._unselectableHandle.remove(),delete e._unselectableHandle):e._unselectableHandle=l.after(e,"renderRow",function(e){return c(e,!0),e}))}i.add("dom-comparedocumentposition",function(e,t,n){return!!n.compareDocumentPosition}),i.add("css-user-select",function(e,t,n){var i=n.style,l=["Khtml","O","ms","Moz","Webkit"],s=l.length,o="userSelect";do if("undefined"!=typeof i[o])return o;while(s--&&(o=l[s]+"UserSelect"));return!1}),i.add("dom-selectstart","undefined"!=typeof document.onselectstart);var d=i("mac")?"metaKey":"ctrlKey",a=i("css-user-select"),h=i("pointer"),u=h&&"MS"===h.slice(0,2),f=h?h+(u?"Down":"down"):"mousedown",_=h?h+(u?"Up":"up"):"mouseup";return e(null,{selectionDelegate:".dgrid-row",selectionEvents:f+","+_+",dgrid-cellfocusin",selectionTouchEvents:i("touch")?o.tap:null,deselectOnRefresh:!0,allowSelectAll:!1,selection:{},selectionMode:"extended",allowTextSelection:void 0,_selectionTargetType:"rows",create:function(){return this.selection={},this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._initSelectionEvents();var e=this.selectionMode;this.selectionMode="",this._setSelectionMode(e)},destroy:function(){this.inherited(arguments),this._selectstartHandle&&this._selectstartHandle.remove(),this._unselectableHandle&&this._unselectableHandle.remove(),this._removeDeselectSignals&&this._removeDeselectSignals()},_setSelectionMode:function(e){e!==this.selectionMode&&(this.clearSelection(),this.selectionMode=e,this._selectionHandlerName="_"+e+"SelectionHandler",this._setAllowTextSelection(this.allowTextSelection))},_setAllowTextSelection:function(e){"undefined"!=typeof e?r(this,e):r(this,"none"===this.selectionMode),this.allowTextSelection=e},_handleSelect:function(e,t){!this[this._selectionHandlerName]||!this.allowSelect(this.row(t))||"dgrid-cellfocusin"===e.type&&"mousedown"===e.parentType||e.type===_&&t!==this._waitForMouseUp||(this._waitForMouseUp=null,this._selectionTriggerEvent=e,e.keyCode&&e.ctrlKey&&32!==e.keyCode||(!e.shiftKey&&e.type===f&&this.isSelected(t)?this._waitForMouseUp=t:this[this._selectionHandlerName](e,t)),this._selectionTriggerEvent=null)},_singleSelectionHandler:function(e,t){var n=e.keyCode?e.ctrlKey:e[d];this._lastSelected===t?this.select(t,null,!n||!this.isSelected(t)):(this.clearSelection(),this.select(t),this._lastSelected=t)},_multipleSelectionHandler:function(e,t){var n,i=this._lastSelected,l=e.keyCode?e.ctrlKey:e[d];e.shiftKey||(n=l?null:!0,i=null),this.select(t,i,n),i||(this._lastSelected=t)},_extendedSelectionHandler:function(e,t){(2===e.button?this.isSelected(t):e.keyCode?e.ctrlKey:e[d])||this.clearSelection(null,!0),this._multipleSelectionHandler(e,t)},_toggleSelectionHandler:function(e,t){this.select(t,null,null)},_initSelectionEvents:function(){var e=this,t=this.contentNode,s=this.selectionDelegate;this._selectionEventQueues={deselect:[],select:[]},i("touch")&&!i("pointer")&&this.selectionTouchEvents?(n(t,o.selector(s,this.selectionTouchEvents),function(t){e._handleSelect(t,this),e._ignoreMouseSelect=this}),n(t,n.selector(s,this.selectionEvents),function(t){e._ignoreMouseSelect!==this?e._handleSelect(t,this):t.type===_&&(e._ignoreMouseSelect=null)})):n(t,n.selector(s,this.selectionEvents),function(t){e._handleSelect(t,this)}),this.addKeyHandler&&this.addKeyHandler(32,function(t){e._handleSelect(t,t.target)}),this.allowSelectAll&&this.on("keydown",function(t){t[d]&&65===t.keyCode&&!/\bdgrid-input\b/.test(t.target.className)&&(t.preventDefault(),e[e.allSelected?"clearSelection":"selectAll"]())}),this._setCollection&&l.before(this,"_setCollection",function(t){e._updateDeselectionAspect(t)}),this._updateDeselectionAspect()},_updateDeselectionAspect:function(e){function t(e,t){var n=i.row(e),l=n&&i.selection[n.id];l&&i[t](n)}var n,i=this;this._removeDeselectSignals&&this._removeDeselectSignals(),n=e&&e.track&&this._observeCollection?[l.before(this,"_observeCollection",function(e){n.push(e.on("delete",function(e){"undefined"==typeof e.index&&t(e.id,"deselect")}))}),l.after(this,"_observeCollection",function(e){n.push(e.on("update",function(n){"undefined"!=typeof n.index&&t(e.getIdentity(n.target),"select")}))},!0)]:[l.before(this,"removeRow",function(e,t){var n;t||(n=this.row(e),n&&n.id in this.selection&&this.deselect(n))})],this._removeDeselectSignals=function(){for(var e=n.length;e--;)n[e].remove();n=[]}},allowSelect:function(){return!0},_fireSelectionEvent:function(e){var t,i=this._selectionEventQueues[e],l=this._selectionTriggerEvent;t={bubbles:!0,grid:this},l&&(t.parentType=l.type),t[this._selectionTargetType]=i,this._selectionEventQueues[e]=[],n.emit(this.contentNode,"dgrid-"+e,t)},_fireSelectionEvents:function(){var e,t=this._selectionEventQueues;for(e in t)t[e].length&&this._fireSelectionEvent(e)},_select:function(e,n,i){var l,s,o,c,r;if("undefined"==typeof i&&(i=!0),e.element||(e=this.row(e)),(i===!1||this.allowSelect(e))&&(l=this.selection,s=!!l[e.id],null===i&&(i=!s),o=e.element,i||this.allSelected?l[e.id]=i:delete this.selection[e.id],o&&(i?t.add(o,"dgrid-selected"+(this.addUiClasses?" ui-state-active":"")):t.remove(o,"dgrid-selected ui-state-active")),i!==s&&o&&this._selectionEventQueues[(i?"":"de")+"select"].push(e),n)){if(n.element||(n=this.row(n)),!n)return void(this._lastSelected=o);if(c=n.element)for(r=this._determineSelectionDirection(o,c),r||(c=document.getElementById(c.id),r=this._determineSelectionDirection(o,c));e.element!==c&&(e=this[r](e));)this._select(e,null,i)}},_determineSelectionDirection:i("dom-comparedocumentposition")?function(e,t){var n=t.compareDocumentPosition(e);return 1&n?!1:2===n?"down":"up"}:function(e,t){return t.sourceIndex<1?!1:t.sourceIndex>e.sourceIndex?"down":"up"},select:function(e,t,n){this._select(e,t,n),this._fireSelectionEvents()},deselect:function(e,t){this.select(e,t,!1)},clearSelection:function(e,t){this.allSelected=!1;for(var n in this.selection)e!==n&&this._select(n,null,!1);t||(this._lastSelected=null),this._fireSelectionEvents()},selectAll:function(){this.allSelected=!0,this.selection={};for(var e in this._rowIdToObject){var t=this.row(this._rowIdToObject[e]);this._select(t.id,null,!0)}this._fireSelectionEvents()},isSelected:function(e){return"undefined"==typeof e||null===e?!1:(e.element||(e=this.row(e)),e.id in this.selection?!!this.selection[e.id]:this.allSelected&&(!e.data||this.allowSelect(e)))},refresh:function(){return this.deselectOnRefresh&&this.clearSelection(),this._lastSelected=null,this.inherited(arguments)},renderArray:function(){var e,t,n,i=this.inherited(arguments),l=this.selection;for(e=0;e<i.length;e++)t=this.row(i[e]),n=t.id in l?l[t.id]:this.allSelected,n&&this.select(t,null,n);return this._fireSelectionEvents(),i}})});
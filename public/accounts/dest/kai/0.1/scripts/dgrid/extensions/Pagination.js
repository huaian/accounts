define("dgrid/extensions/Pagination",["../_StoreMixin","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/on","dojo/query","dojo/string","dojo/has","dojo/when","../util/misc","dojo/i18n!./nls/pagination","dojo/_base/sniff"],function(e,t,i,a,n,o,s,r,d,g,l,h,c){function u(e){e.noDataNode?(n.destroy(e.noDataNode),delete e.noDataNode):e.cleanup(),e.contentNode.innerHTML=""}function p(e){if(e.loadingNode)n.destroy(e.loadingNode),delete e.loadingNode;else if(e._oldPageNodes){for(var t in e._oldPageNodes)e.removeRow(e._oldPageNodes[t]);delete e._oldPageNodes}delete e._isLoading}return t(e,{rowsPerPage:10,pagingTextBox:!1,previousNextArrows:!0,firstLastArrows:!1,pagingLinks:2,pageSizeOptions:null,showLoadingMessage:!0,i18nPagination:c,showFooter:!0,_currentPage:1,buildRendering:function(){this.inherited(arguments);var e,t,i=this,a=this.paginationNode=n.create("div",{className:"dgrid-pagination"},this.footerNode),o=this.paginationStatusNode=n.create("div",{className:"dgrid-status"},a),r=this.i18nPagination;o.tabIndex=0,this._updatePaginationSizeSelect(),this._updateRowsPerPageOption(),this._updatePaginationStatus(this._total),e=this.paginationNavigationNode=n.create("div",{className:"dgrid-navigation"},a),this.firstLastArrows&&(t=this.paginationFirstNode=n.create("span",{"aria-label":r.gotoFirst,className:"dgrid-first dgrid-page-link",innerHTML:"«",tabIndex:0},e)),this.previousNextArrows&&(t=this.paginationPreviousNode=n.create("span",{"aria-label":r.gotoPrev,className:"dgrid-previous dgrid-page-link",innerHTML:"‹",tabIndex:0},e)),this.paginationLinksNode=n.create("span",{className:"dgrid-pagination-links"},e),this.previousNextArrows&&(t=this.paginationNextNode=n.create("span",{"aria-label":r.gotoNext,className:"dgrid-next dgrid-page-link",innerHTML:"›",tabIndex:0},e)),this.firstLastArrows&&(t=this.paginationLastNode=n.create("span",{"aria-label":r.gotoLast,className:"dgrid-last dgrid-page-link",innerHTML:"»",tabIndex:0},e)),this._listeners.push(s(e,".dgrid-page-link:click,.dgrid-page-link:keydown",function(e){if("keydown"!==e.type||13===e.keyCode){var t,a,n=this.className;i._isLoading||n.indexOf("dgrid-page-disabled")>-1||(t=i._currentPage,a=Math.ceil(i._total/i.rowsPerPage),this===i.paginationPreviousNode?i.gotoPage(t-1):this===i.paginationNextNode?i.gotoPage(t+1):this===i.paginationFirstNode?i.gotoPage(1):this===i.paginationLastNode?i.gotoPage(a):"dgrid-page-link"===n&&i.gotoPage(+this.innerHTML))}}))},destroy:function(){this.inherited(arguments),this._pagingTextBoxHandle&&this._pagingTextBoxHandle.remove()},_updatePaginationSizeSelect:function(){var e,t=this.pageSizeOptions,i=this.paginationSizeSelect;if(t&&t.length){i||(i=this.paginationSizeSelect=n.create("select",{"aria-label":this.i18nPagination.rowsPerPage,className:"dgrid-page-size"},this.paginationNode),e=this._paginationSizeChangeHandle=s(i,"change",a.hitch(this,function(){this.set("rowsPerPage",+this.paginationSizeSelect.value)})),this._listeners.push(e)),i.options.length=0;for(var o=0;o<t.length;o++)n.create("option",{innerHTML:t[o],selected:this.rowsPerPage===t[o],value:t[o]},i);this._updateRowsPerPageOption()}else t&&t.length||!i||(n.destroy(i),this.paginationSizeSelect=null,this._paginationSizeChangeHandle.remove())},_setPageSizeOptions:function(e){this.pageSizeOptions=e&&e.sort(function(e,t){return e-t}),this._updatePaginationSizeSelect()},_updateRowsPerPageOption:function(){var e=this.rowsPerPage,t=this.pageSizeOptions,a=this.paginationSizeSelect;a&&(i.indexOf(t,e)<0?this._setPageSizeOptions(t.concat([e])):a.value=""+e)},_setRowsPerPage:function(e){this.rowsPerPage=e,this._updateRowsPerPageOption(),this.gotoPage(1)},_updateNavigation:function(e){function t(e,t){var i,a;h.pagingTextBox&&e===p&&_>1?(i=n.create("input",{"aria-label":c.jumpPage,className:"dgrid-page-input",type:"text",value:p},u),h._pagingTextBoxHandle=s(i,"change",function(){var e=+this.value;!isNaN(e)&&e>0&&_>=e&&h.gotoPage(+this.value)}),v&&"INPUT"===v.tagName&&i.focus()):(a=e===p,i=n.create("span",{"aria-label":c.gotoPage,className:"dgrid-page-link"+(a?" dgrid-page-disabled":""),innerHTML:e+(t?" ":""),tabIndex:a?-1:0},u),d===e&&(a?_>e?d++:g.focus():i.focus()),a||(g=i))}function i(e,t){o.toggle(e,"dgrid-page-disabled",t),e.tabIndex=t?-1:0}function a(){n.create("span",{className:"dgrid-page-skip",innerHTML:"..."},u)}var d,g,l,h=this,c=this.i18nPagination,u=this.paginationLinksNode,p=this._currentPage,P=this.pagingLinks,N=this.paginationNavigationNode,_=Math.ceil(e/this.rowsPerPage),f=this._pagingTextBoxHandle,v=document.activeElement;if(v&&this.paginationNavigationNode.contains(v)?"dgrid-page-link"===v.className&&(d=+v.innerHTML):v=null,f&&f.remove(),u.innerHTML="",r(".dgrid-first, .dgrid-previous",N).forEach(function(e){i(e,1===p)}),r(".dgrid-last, .dgrid-next",N).forEach(function(e){i(e,p>=_)}),P&&_>0){t(1,!0);var m=p-P;m>2?a():m=2;for(var x=m;x<Math.min(p+P+1,_);x++)t(x,!0);_>p+P+1&&a(),_>1&&t(_)}else h.pagingTextBox&&t(p);v&&-1===v.tabIndex&&(l=r('[tabindex="0"]',this.paginationNavigationNode),v===this.paginationPreviousNode||v===this.paginationFirstNode?v=l[0]:l.length&&(v=l[l.length-1]),v&&v.focus())},_updatePaginationStatus:function(e){var t=this.rowsPerPage,i=Math.min(e,(this._currentPage-1)*t+1);this.paginationStatusNode.innerHTML=d.substitute(this.i18nPagination.status,{start:i,end:Math.min(e,i+t-1),total:e})},refresh:function(e){var t=this,i=e&&e.keepCurrentPage?Math.min(this._currentPage,Math.ceil(this._total/this.rowsPerPage)):1;return this.inherited(arguments),this.gotoPage(i).then(function(e){return setTimeout(function(){s.emit(t.domNode,"dgrid-refresh-complete",{bubbles:!0,cancelable:!1,grid:t})},0),e})},_onNotification:function(e,t,i){var a=this.rowsPerPage,n=this._currentPage*a,o="add"===t.type&&t.index<n||"delete"===t.type&&t.previousIndex<n||"update"===t.type&&Math.floor(t.index/a)!==Math.floor(t.previousIndex/a);o?this.gotoPage(Math.min(this._currentPage,Math.ceil(t.totalLength/this.rowsPerPage))):i===this._renderedCollection&&t.totalLength!==this._total&&(this._updatePaginationStatus(t.totalLength),this._updateNavigation(t.totalLength))},renderQueryResults:function(e,t){var i=this,a=this.inherited(arguments);return t||(this._topLevelRequest&&(this._topLevelRequest.cancel(),delete this._topLevelRequest),"function"==typeof a.cancel&&(this._topLevelRequest=a),a.then(function(){i._topLevelRequest&&delete i._topLevelRequest})),a},insertRow:function(){var e=this._oldPageNodes,t=this.inherited(arguments);return e&&t===e[t.id]&&delete e[t.id],t},gotoPage:function(e){var t=this,i=(this._currentPage-1)*this.rowsPerPage;return this._renderedCollection?(this._renderedCollection.releaseRange&&this._renderedCollection.releaseRange(i,i+this.rowsPerPage),this._trackError(function(){var i,a,o,s,r,d,g=t.rowsPerPage,l=(e-1)*g,h={start:l,count:g},c=t.contentNode;if(t.showLoadingMessage)u(t),a=t.loadingNode=n.create("div",{className:"dgrid-loading",innerHTML:t.loadingMessage},c);else for(t._oldPageNodes=o={},s=c.children,r=0,d=s.length;d>r;r++)o[s[r].id]=s[r];return t._isLoading=!0,i=t._renderedCollection.fetchRange({start:l,end:l+g}),t.renderQueryResults(i,null,h).then(function(a){return p(t),t.scrollTo({y:0}),t._rows&&(t._rows.min=l,t._rows.max=l+g-1),i.totalLength.then(function(i){i||(t.noDataNode&&(n.destroy(t.noDataNode),delete t.noDataNode),t.noDataNode=n.create("div",{className:"dgrid-no-data",innerHTML:t.noDataMessage},t.contentNode)),t._total=i,t._currentPage=e,t._rowsOnPage=a.length,t._updatePaginationStatus(i),t._updateNavigation(i)}),i},function(e){throw p(t),e})})):l([])}})});
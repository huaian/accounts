define("dgrid/extensions/DnD",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/dom-class","dojo/on","dojo/topic","dojo/has","dojo/when","dojo/dnd/Source","dojo/dnd/Manager","dojo/_base/NodeList","../Selection","dojo/has!touch?../util/touch","dojo/has!touch?./_DnD-touch-autoscroll"],function(e,t,n,o,i,r,d,c,s,h,u,a,l,g){var f=e(h,{grid:null,getObject:function(e){var t=this.grid;return t._trackError(function(){return t.collection.get(e.id.slice(t.id.length+5))})},_legalMouseDown:function(e){var t=this.inherited(arguments);return t&&e.target!==this.grid.bodyNode},onDrop:function(e,t,n){var o=this,i=this._targetAnchor=this.targetAnchor,r=this.grid,d=r.collection;!this.before&&i&&(i=i.nextSibling),i=i&&r.row(i),s(i&&d.get(i.id),function(i){o!==e?o.onDropExternal(e,t,n,i):o.onDropInternal(t,n,i),r.refresh()})},onDropInternal:function(e,t,n){var o,i,r=this.grid,d=r.collection,c=this,h=c._targetAnchor;h&&(o=this.before?h.previousSibling:h.nextSibling),i=r.row(e[0]),(t||o!==e[0]&&(n||!i||r.down(i).element!==e[0]))&&e.forEach(function(e){s(c.getObject(e),function(e){var o=d.getIdentity(e);r._trackError(function(){return d[t&&d.copy?"copy":"put"](e,{beforeId:n?d.getIdentity(n):null}).then(function(){c._selectedNodes[o]&&(c._selectedNodes[o]=r.row(o).element)})})})})},onDropExternal:function(e,t,n,o){var i=this.grid,r=this.grid.collection,d=e.grid;t.forEach(function(t,c){s(e.getObject(t),function(s){i._trackError(function(){return r[r.copy?"copy":"put"](s,{beforeId:o?r.getIdentity(o):null}).then(function(){if(!n){if(d){var o=d.collection.getIdentity(s);return!c&&e.selectNone(),e.delItem(t.id),d.collection.remove(o)}e.deleteSelectedNodes()}})})})})},onDndStart:function(e){this.inherited(arguments),e===this&&(this.grid.cancelTouchScroll&&this.grid.cancelTouchScroll(),u.manager().avatar.node.style.width=this.grid.domNode.offsetWidth/2+"px")},onMouseDown:function(e){c("touch")&&this.isDragging&&g.countCurrentTouches(e,this.grid.touchNode)>1?(d.publish("/dnd/cancel"),u.manager().stopDrag()):this.inherited(arguments)},onMouseMove:function(e){(!c("touch")||g.countCurrentTouches(e,this.grid.touchNode)<=1)&&this.inherited(arguments)},checkAcceptance:function(e){return e.getObject&&h.prototype.checkAcceptance.apply(this,arguments)},getSelectedNodes:function(){if(!this.grid.selection)return this.inherited(arguments);var e,t=new a;for(e in this.grid.selection)t.push(this._selectedNodes[e]);return t}}),p=e(l,{dndSourceType:"dgrid-row",dndParams:null,dndConstructor:f,postMixInProperties:function(){this.inherited(arguments),this.dndParams=t.mixin({accept:[this.dndSourceType]},this.dndParams)},postCreate:function(){function e(e){c[e.id]=e.element}function r(e){delete c[e.id],i.remove(e.element,"dojoDndItemSelected dojoDndItemAnchor")}this.inherited(arguments);var d=this.dndConstructor||f;this.dndSource=new d(this.bodyNode,t.mixin(this.dndParams,{grid:this,dropParent:this.contentNode}));var c=this.dndSource._selectedNodes={};this.on("dgrid-select",function(t){n.forEach(t.rows,e)}),this.on("dgrid-deselect",function(e){n.forEach(e.rows,r)}),o.after(this,"destroy",function(){delete this.dndSource._selectedNodes,c=null,this.dndSource.destroy()},!0)},insertRow:function(e){var t=this.inherited(arguments),n="function"==typeof this.getObjectDndType?this.getObjectDndType(e):[this.dndSourceType];return i.add(t,"dojoDndItem"),this.dndSource.setItem(t.id,{data:e,type:n instanceof Array?n:[n]}),t},removeRow:function(e){this.dndSource.delItem(this.row(e)),this.inherited(arguments)}});return p.GridSource=f,p});
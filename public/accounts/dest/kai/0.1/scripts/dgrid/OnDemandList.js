define("dgrid/OnDemandList",["./List","./_StoreMixin","dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/on","dojo/when","./util/misc"],function(e,o,t,n,r,i,s,a){return t([e,o],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:1/0,bufferRows:10,farOffRemoval:2e3,queryRowsOverlap:0,pagingMethod:"debounce",pagingDelay:a.defaultDelay,keepScrollPosition:!1,rowHeight:0,postCreate:function(){this.inherited(arguments);var e=this;i(this.bodyNode,"scroll",a[this.pagingMethod](function(o){e._processScroll(o)},null,this.pagingDelay))},destroy:function(){this.inherited(arguments),this._refreshTimeout&&clearTimeout(this._refreshTimeout)},renderQuery:function(e,o){var t,i=this,a=o&&o.container||this.contentNode,l={query:e,count:0},d=this.preload,u={node:r.create("div",{className:"dgrid-preload",style:{height:"0"}},a),count:0,query:e,next:l};u.node.rowIndex=0,l.node=t=r.create("div",{className:"dgrid-preload"},a),l.previous=u,t.rowIndex=this.minRowsPerPage,d?((l.next=d.next)&&t.offsetTop>=d.node.offsetTop?l.previous=d:(l.next=d,l.previous=d.previous),l.previous.next=l,l.next.previous=l):this.preload=l;var c=r.create("div",{className:"dgrid-loading"},t,"before"),h=r.create("div",{className:"dgrid-below"},c);return h.innerHTML=this.loadingMessage,o=n.mixin({start:0,count:this.minRowsPerPage},"level"in e?{queryLevel:e.level}:null),this._trackError(function(){var n=e(o);return i.renderQueryResults(n,t,o).then(function(e){return n.totalLength.then(function(n){var a=e.length,d=t.parentNode,u=i.noDataNode;i._rows&&(i._rows.min=0,i._rows.max=a===n?1/0:a-1),r.destroy(c),"queryLevel"in o||(i._total=n),0===n&&d&&(u&&(r.destroy(u),delete i.noDataNode),i.noDataNode=u=r.create("div",{className:"dgrid-no-data",innerHTML:i.noDataMessage}),d.insertBefore(u,i._getFirstRowSibling(d)));for(var h=0,f=0;a>f;f++)h+=i._calcRowHeight(e[f]);return a&&h&&(i.rowHeight=h/a),n-=a,l.count=n,t.rowIndex=a,n?t.style.height=Math.min(n*i.rowHeight,i.maxEmptySpace)+"px":t.style.display="none",i._previousScrollPosition&&(i.scrollTo(i._previousScrollPosition),delete i._previousScrollPosition),s(i._processScroll()).then(function(){return e})})}).otherwise(function(e){throw r.destroy(c),e})})},refresh:function(e){var o=this,t=e&&e.keepScrollPosition;return"undefined"==typeof t&&(t=this.keepScrollPosition),t&&(this._previousScrollPosition=this.getScrollPosition()),this.inherited(arguments),this._renderedCollection?this.renderQuery(function(e){return o._renderedCollection.fetchRange({start:e.start,end:e.start+e.count})}).then(function(){o._refreshTimeout=setTimeout(function(){i.emit(o.domNode,"dgrid-refresh-complete",{bubbles:!0,cancelable:!1,grid:o}),o._refreshTimeout=null},0)}):void 0},resize:function(){this.inherited(arguments),this._processScroll()},cleanup:function(){this.inherited(arguments),this.preload=null},renderQueryResults:function(e){var o=this.inherited(arguments),t=this._renderedCollection;return t&&t.releaseRange&&o.then(function(o){o[0]&&!o[0].parentNode.tagName&&e.totalLength.then(function(){t.releaseRange(o[0].rowIndex,o[o.length-1].rowIndex+1)})}),o},_getFirstRowSibling:function(e){return e.lastChild},_calcRowHeight:function(e){var o=e.nextSibling;return o&&!/\bdgrid-preload\b/.test(o.className)?o.offsetTop-e.offsetTop:e.offsetHeight},lastScrollTop:0,_processScroll:function(e){function o(e,o,n,i){var s=l.farOffRemoval,a=e.node;if(o>2*s){for(var d,u,c=a[n],h=0,f=0,g=[],m=c&&c.rowIndex;d=c;){var p=l._calcRowHeight(d);if(h+p+s>o||c.className.indexOf("dgrid-row")<0&&c.className.indexOf("dgrid-loading")<0)break;c=d[n],h+=p,f+=d.count||1,l.removeRow(d,!0),g.push(d),"rowIndex"in d&&(u=d.rowIndex)}l._renderedCollection.releaseRange&&"number"==typeof m&&"number"==typeof u&&(i?l._renderedCollection.releaseRange(u,m+1):l._renderedCollection.releaseRange(m,u+1),l._rows[i?"max":"min"]=u,l._rows.max>=l._total-1&&(l._rows.max=1/0)),e.count+=f,i?(a.rowIndex-=f,t(e)):a.style.height=a.offsetHeight+h+"px";for(var x=document.createElement("div"),w=g.length;w--;)x.appendChild(g[w]);setTimeout(function(){r.destroy(x)},1)}}function t(e,o){e.node.style.height=Math.min(e.count*l.rowHeight,o?1/0:l.maxEmptySpace)+"px"}function n(e,o){do e=o?e.next:e.previous;while(e&&!e.node.offsetWidth);return e}if(this.rowHeight){var i,s,a,l=this,d=l.bodyNode,u=e&&e.scrollTop||this.getScrollPosition().y,c=d.offsetHeight+u,h=l.preload,f=l.lastScrollTop,g=l.bufferRows*l.rowHeight,m=g-l.rowHeight,p=!0,x=1;for(l.lastScrollTop=u;h&&!h.node.offsetWidth;)h=h.previous;for(;h&&h!==i;){i=l.preload,l.preload=h,s=h.node;var w,v=s.offsetTop;if(v>c+x+m)h=n(h,p=!1);else if(u-x-m>v+(w=s.offsetHeight))h=n(h,p=!0);else{var y=((s.rowIndex?u-g:c)-v)/l.rowHeight,_=(c-u+2*g)/l.rowHeight,P=Math.max(Math.min((u-f)*l.rowHeight,l.maxRowsPerPage/2),l.maxRowsPerPage/-2);if(_+=Math.min(Math.abs(P),10),0===s.rowIndex&&(y-=_),y=Math.max(y,0),10>y&&y>0&&_+y<l.maxRowsPerPage&&(_+=Math.max(0,y),y=0),_=Math.min(Math.max(_,l.minRowsPerPage),l.maxRowsPerPage,h.count),0===_){h=n(h,p);continue}_=Math.ceil(_),y=Math.min(Math.floor(y),h.count-_);var R={};h.count-=_;var b,S=s,M=l.queryRowsOverlap,T=(s.rowIndex>0||s.offsetTop>u)&&h;if(T){var H=h.previous;H&&(o(H,u-(H.node.offsetTop+H.node.offsetHeight),"nextSibling"),y>0&&H.node===s.previousSibling?(y=Math.min(h.count,y),h.previous.count+=y,t(h.previous,!0),s.rowIndex+=y,M=0):_+=y,h.count-=y),R.start=s.rowIndex-M,R.count=Math.min(_+M,l.maxRowsPerPage),s.rowIndex=R.start+R.count}else h.next&&(o(h.next,h.next.node.offsetTop-c,"previousSibling",!0),S=s.nextSibling,S===h.next.node?(h.next.count+=h.count-y,h.next.node.rowIndex=y+_,t(h.next),h.count=y,M=0):b=!0),R.start=h.count,R.count=Math.min(_+M,l.maxRowsPerPage);if(b&&S&&S.offsetWidth&&(b=S.offsetTop),t(h),"level"in h.query&&(R.queryLevel=h.query.level),!("queryLevel"in R)&&(R.start>l._total||R.count<0))continue;var I=r.create("div",{className:"dgrid-loading",style:{height:_*l.rowHeight+"px"}},S,"before");r.create("div",{className:"dgrid-"+(T?"below":"above"),innerHTML:l.loadingMessage},I),I.count=_,l._trackError(function(){!function(e,o,n){var i=h.query(R);a=l.renderQueryResults(i,e,R).then(function(s){var a=l._rows;if(!a||"queryLevel"in R||!s.length||(o?(a.max<=a.min&&(a.min=s[0].rowIndex),a.max=s[s.length-1].rowIndex):(a.max<=a.min&&(a.max=s[s.length-1].rowIndex),a.min=s[0].rowIndex)),S=e.nextSibling,r.destroy(e),n&&S&&S.offsetWidth){var d=l.getScrollPosition();l.scrollTo({x:d.x,y:d.y+S.offsetTop-n,preserveMomentum:!0})}return i.totalLength.then(function(e){"queryLevel"in R||(l._total=e,l._rows&&l._rows.max>=l._total-1&&(l._rows.max=1/0)),o&&(o.count=e-o.node.rowIndex,t(o))}),l._processScroll(),s},function(o){throw r.destroy(e),o})}(I,T,b)}),h=h.previous}}return a}}})});
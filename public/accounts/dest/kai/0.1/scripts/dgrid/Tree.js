define("dgrid/Tree",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/dom-construct","dojo/dom-class","dojo/on","dojo/query","dojo/when","./util/has-css3","./Grid","dojo/has!touch?./util/touch"],function(e,n,t,i,r,o,d,s,a,l,c,h){return e(null,{collapseOnRefresh:!1,enableTreeTransitions:!0,treeIndentWidth:9,constructor:function(){this._treeColumnListeners=[]},shouldExpand:function(e,n,t){return t},expand:function(e,t,i){if(this._treeColumn){var c,h=this,u=e.element?e:this.row(e),g=!!this._expanded[u.id],f=l("transitionend");if(e=u.element,e=e.className.indexOf("dgrid-expando-icon")>-1?e:s(".dgrid-expando-icon",e)[0],i=i||!this.enableTreeTransitions,e&&e.mayHaveChildren&&(i||t!==g)){var p=void 0===t?!this._expanded[u.id]:t;o.replace(e,"ui-icon-triangle-1-"+(p?"se":"e"),"ui-icon-triangle-1-"+(p?"e":"se")),o.toggle(u.element,"dgrid-row-expanded",p);var m,v,_=u.element,x=_.connected,y={};if(!x){x=y.container=_.connected=r.create("div",{className:"dgrid-tree-container"},_,"after");var C=function(e){var n,t=h._renderedCollection.getChildren(u.data);if(h.sort&&h.sort.length>0&&(t=t.sort(h.sort)),t.track&&h.shouldTrackCollection&&(x._rows=e.rows=[],t=t.track(),x._handles=[t.tracking,h._observeCollection(t,x,e)]),"start"in e){var i={start:e.start,end:e.start+e.count};n=t.fetchRange(i)}else n=t.fetch();return n};if("level"in e&&(C.level=e.level),this.renderQuery)c=this.renderQuery(C,y);else{var w=r.create("div",null,x);c=this._trackError(function(){return h.renderQueryResults(C(y),w,n.mixin({rows:y.rows},"level"in C?{queryLevel:C.level}:null)).then(function(e){return r.destroy(w),e})})}f&&!i?d.once(x,f,this._onTreeTransitionEnd):this._onTreeTransitionEnd.call(x)}x.hidden=!p,m=x.style,!f||i?(m.display=p?"block":"none",m.height=""):(p?(m.display="block",v=x.scrollHeight,m.height="0px"):(o.add(x,"dgrid-tree-resetting"),m.height=x.scrollHeight+"px"),setTimeout(function(){o.remove(x,"dgrid-tree-resetting"),m.height=p?v?v+"px":"auto":"0px"},0)),p?this._expanded[u.id]=!0:delete this._expanded[u.id]}return a(c)}},_configColumns:function(){var e=this.inherited(arguments);this._expanded={};for(var n=0,t=e.length;t>n;n++)if(e[n].renderExpando){this._configureTreeColumn(e[n]);break}return e},insertRow:function(e){var n=this.inherited(arguments),t=this.row(n),i=this.shouldExpand(t,this._currentLevel,this._expanded[t.id]);return i&&this.expand(n,!0,!0),(i||!this.collection.mayHaveChildren||this.collection.mayHaveChildren(e))&&o.add(n,"dgrid-row-expandable"),n},removeRow:function(e,n){var i=e.connected,o={};i&&(i._handles&&(t.forEach(i._handles,function(e){e.remove()}),delete i._handles),i._rows&&(o.rows=i._rows),s(">.dgrid-row",i).forEach(function(e){this.removeRow(e,!0,o)},this),i._rows&&(i._rows.length=0,delete i._rows),n||r.destroy(i)),this.inherited(arguments)},cleanup:function(){this.inherited(arguments),this.collapseOnRefresh&&(this._expanded={})},_destroyColumns:function(){for(var e=this._treeColumnListeners,n=e.length;n--;)e[n].remove();this._treeColumnListeners=[],this._treeColumn=null},_calcRowHeight:function(e){var n=e.connected;return this.inherited(arguments)+(n?n.offsetHeight:0)},_configureTreeColumn:function(e){var n,t=e.renderCell||this._defaultRenderCell;this._treeColumn=e;var i=this,r=".dgrid-content .dgrid-column-"+e.id;if(!i.collection)throw new Error("dgrid Tree mixin requires a collection to operate.");"function"!=typeof e.renderExpando&&(e.renderExpando=this._defaultRenderExpando),this._treeColumnListeners.push(this.on(e.expandOn||".dgrid-expando-icon:click,"+r+":dblclick,"+r+":keydown",function(e){var t=i.row(e);i.collection.mayHaveChildren&&!i.collection.mayHaveChildren(t.data)||"keydown"===e.type&&32!==e.keyCode||"dblclick"===e.type&&n&&n.count>1&&t.id===n.id&&e.target.className.indexOf("dgrid-expando-icon")>-1||i.expand(t),e.target.className.indexOf("dgrid-expando-icon")>-1&&(n&&n.id===i.row(e).id?n.count++:n={id:i.row(e).id,count:1})})),l("touch")&&this._treeColumnListeners.push(this.on(h.selector(r,h.dbltap),function(){i.expand(this)})),e.renderCell=function(n,i,r,o){var d,s,a=e.grid,l=Number(o&&o.queryLevel)+1,c=!a.collection.mayHaveChildren||a.collection.mayHaveChildren(n);l=a._currentLevel=isNaN(l)?0:l,d=e.renderExpando(l,c,a._expanded[a.collection.getIdentity(n)],n),d.level=l,d.mayHaveChildren=c,s=t.call(e,n,i,r,o),s&&s.nodeType?(r.appendChild(d),r.appendChild(s)):r.insertBefore(d,r.firstChild)}},_defaultRenderExpando:function(e,n,t){var i=this.grid.isRTL?"right":"left",o="dgrid-expando-icon";return n&&(o+=" ui-icon ui-icon-triangle-1-"+(t?"se":"e")),r.create("div",{className:o,innerHTML:"&nbsp;",style:"margin-"+i+": "+e*this.grid.treeIndentWidth+"px; float: "+i+";"})},_onTreeTransitionEnd:function(e){var n=this,t=this.style.height;t&&(this.style.display="0px"===t?"none":"block"),e&&(o.add(this,"dgrid-tree-resetting"),setTimeout(function(){o.remove(n,"dgrid-tree-resetting")},0)),this.style.height=""}})});
define("dgrid/_StoreMixin",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/aspect","dojo/dom-construct","dojo/has","dojo/on","dojo/when"],function(e,t,n,o,i,r,s,d){function l(e){if("object"!=typeof e)e=new Error(e);else if("cancel"===e.dojoType)return;s.emit(this.domNode,"dgrid-error",{grid:this,error:e,cancelable:!0,bubbles:!0})}return e(null,{collection:null,_renderedCollection:null,_rows:null,_observerHandle:null,shouldTrackCollection:!0,getBeforePut:!0,noDataMessage:"",loadingMessage:"",_total:0,constructor:function(){this.dirty={},this._updating={},this._columnsWithSet={},o.before(this,"configStructure",t.hitch(this,function(){this._columnsWithSet={}}))},destroy:function(){this.inherited(arguments),this._renderedCollection&&this._cleanupCollection()},_configColumn:function(e){e.set&&(this._columnsWithSet[e.field]=e),this.inherited(arguments)},_setCollection:function(e){if(this._renderedCollection&&(this.cleanup(),this._cleanupCollection({shouldRevert:!e||e.storage!==this._renderedCollection.storage})),e){var t=e;this.sort&&this.sort.length>0&&(t=e.sort(this.sort)),t.track&&this.shouldTrackCollection&&(t=t.track(),this._rows=[],this._observerHandle=this._observeCollection(t,this.contentNode,{rows:this._rows})),this._renderedCollection=t}this.collection=e,this._started&&this.refresh()},_setStore:function(){!this.collection},_getTotal:function(){return this._total},_cleanupCollection:function(e){e=e||{},this._renderedCollection.tracking&&this._renderedCollection.tracking.remove(),this._observerHandle&&(this._observerHandle.remove(),this._observerHandle=this._rows=null),e.shouldRevert!==!1&&(this.dirty={}),this._renderedCollection=this.collection=null},_applySort:function(){this.collection?this.set("collection",this.collection):this.store},row:function(){var e=this.inherited(arguments);return e&&e.data&&"undefined"!=typeof e.id&&(e.id=this.collection.getIdentity(e.data)),e},refresh:function(){var e=this.inherited(arguments);return this.collection||(this.noDataNode=i.create("div",{className:"dgrid-no-data",innerHTML:this.noDataMessage},this.contentNode)),e},renderArray:function(){var e=this.inherited(arguments);return this.collection||e.length&&this.noDataNode&&i.destroy(this.noDataNode),e},insertRow:function(e,n,o,r,s){var d,l,a=this.collection,c=this.dirty,h=a&&a.getIdentity(e);return h in c&&!(h in this._updating)&&(d=c[h]),d&&(e=t.delegate(e,d)),l=this.inherited(arguments),s&&s.rows&&(s.rows[r]=l),this.noDataNode&&(i.destroy(this.noDataNode),this.noDataNode=null),l},updateDirty:function(e,t,n){var o=this.dirty,i=o[e];i||(i=o[e]={}),i[t]=n},save:function(){function e(e,n){return function(r){var d,l,a=t._columnsWithSet,c=t._updating;if("function"==typeof r.set)r.set(n);else for(d in n)r[d]=n[d];for(d in a)l=a[d].set(r),void 0!==l&&(r[d]=l);return c[e]=!0,o.put(r).then(function(t){return delete i[e],delete c[e],s[e]=t,s})}}var t=this,o=this.collection,i=this.dirty,r=new n,s={},d=function(e){var n;return t.getBeforePut||!(n=t.row(e).data)?function(){return o.get(e)}:function(){return n}},l=r.then(function(){return s});for(var a in i){var c=e(a,i[a]);l=l.then(d(a)).then(c)}return r.resolve(),l},revert:function(){this.dirty={},this.refresh()},_trackError:function(e){"string"==typeof e&&(e=t.hitch(this,e));var o,i=this;try{o=d(e())}catch(r){var s=new n;s.reject(r),o=s.promise}return o.otherwise(function(e){l.call(i,e)}),o},removeRow:function(e,t,n){var o={element:e};!t&&this.noDataMessage&&this.up(o).element===e&&this.down(o).element===e&&(this.noDataNode=i.create("div",{className:"dgrid-no-data",innerHTML:this.noDataMessage},this.contentNode));var r=n&&n.rows||this._rows;return r&&delete r[e.rowIndex],this.inherited(arguments)},renderQueryResults:function(e,n,o){o=t.mixin({rows:this._rows},o);var i=this;return e.then(function(e){var t=i.renderArray(e,n,o);return delete i._lastCollection,t})},_observeCollection:function(e,t,n){var o,i=this,r=n.rows,s=[e.on("delete, update",function(e){var s=e.previousIndex,d=e.index;void 0!==s&&r[s]&&("max"in r&&(void 0===d||d<r.min||d>r.max)&&r.max--,o=r[s],o.parentNode===t&&i.removeRow(o,!1,n),r.splice(s,1),("delete"===e.type||"update"===e.type&&(d>s||void 0===d))&&r[s]&&r[s].rowIndex--,i._processScroll&&i._processScroll()),"delete"===e.type&&(o=null)}),e.on("add, update",function(e){function s(){d=(d.connected||d).nextSibling}var d,l=e.previousIndex,a=e.index;void 0===a||"max"in r&&!(a>=r.min&&a<=r.max)||("max"in r&&(void 0===l||l<r.min||l>r.max)&&r.max++,r.length?(d=r[a],d||(d=r[a-1],d&&s())):d=i._getFirstRowSibling&&i._getFirstRowSibling(t),o&&d&&o.id===d.id&&s(),d&&!d.parentNode&&(d=document.getElementById(d.id)),r.splice(a,0,void 0),o=i.insertRow(e.target,t,d,a,n),i.highlightRow(o)),o=null}),e.on("add, delete, update",function(t){var n="undefined"!=typeof t.previousIndex?t.previousIndex:1/0,o="undefined"!=typeof t.index?t.index:1/0,s=Math.min(n,o);n!==o&&r[s]&&i.adjustRowIndices(r[s]),i._onNotification(r,t,e),e===i._renderedCollection&&"totalLength"in t&&(i._total=t.totalLength)})];return{remove:function(){for(;s.length>0;)s.pop().remove()}}},_onNotification:function(){}})});
define("common/c.geo",["cHybridShell","_","$"],function(t){"use strict";function e(t){if(t instanceof e)return t;t||(t={}),d.isScalar(t.id)&&(this.id=t.id+""),_.isString(t.name)&&(this.name=t.name),t.parent instanceof e&&(this.parent=t.parent);var r;t.coordinate instanceof n&&(r=t.coordinate)}function n(t){if(t instanceof n)return t;if(!(this instanceof n))return w.construct(n,arguments);this.system=n.SYSTEM.EARTH;var e=[[Number,Number,function(t,e){this.longitude=t,this.latitude=e}],[Array,function(t){this.longitude=t[0],this.latitude=t[1]}],[[s,a],function(t){return d.clone(t.coordinate)}],[String,function(t){t.match(/^([\d.]+),([\d.]+)$/)&&(this.longitude=RegExp.$1,this.latitude=RegExp.$2)}],[d.overload.Type(function(t){return t&&"number"==typeof t.lat&&"number"==typeof t.lng}),function(t){this.longitude=t.lng,this.latitude=t.lat}],[d.overload.Type(function(t){return t&&t.coords}),function(t){_.extend(this,_.pick(t.coords,"longitude","latitude"))}]];return d.overload(e,arguments,this)}function r(t){var e,n=this,r=new m(this);return n.run=function(i){return i=d.times2ms(i,{timeout:"35s",maximumAge:"10m"}),e=E[t](r.resolve,r.reject,i),n},n.abort=function(){return e&&e.abort(),n},n}function i(t,e,n,i){new r(t).done(e).fail(n).run(i)}function o(){var t=this,e=S(t);t.children=new A,e.attachTo=function(e){t.map=e,t.children.forEach(function(t){S(t).attachTo(e)})},e.detach=function(){t.map&&(t.children.forEach(function(t){S(t).detach()}),delete this.map)}}function a(){var t=this,e=S(t),r=[[s,function(t){this.coordinate=t.coordinate,this.title=t.name}],[Object,function(t){t.poi&&(this.coordinate=t.poi.coordinate,this.title=t.poi.name),t.coordinate&&(this.coordinate=new n(t.coordinate)),t.icon&&(this.icon=u(t.icon)),_.extend(this,_.pick(t,["title","href"]))}]];d.overload(r,arguments,t),e.attachTo=function(e){t.map=e,e.attach(t)},e.detach=function(e){t.map&&(e.detach(t),delete t.map)},t.appendTo=function(e){e.append(t)},t.remove=function(){t.parent&&t.parent.remove(t)}}function u(){var t=[[d.overload.Type(function(t){return new RegExp("^<").test(t)}),function(t){return $(t).get(0)}],[[String,HTMLElement],function(t){return t}],[Object,function(t){var e,n=function(t){return _.isString(t)?t=t.split(/\s|,/):t.constructor==Object&&(t=[t.x||t.width,t.y||t.height]),[parseFloat(t[0])+"px",parseFloat(t[1])+"px"]},r="",i=t.size,o=t.image,a=_.isString(o)?o:o.url;return o?(i&&(e=n(i),r+="; width:"+e[0],r+="; height:"+e[1]),a&&(r+=";-image:url("+a+")"),o.size&&(r+=";-size:"+n(o.size).join(" ")),o.offset&&(r+=";-position:"+n(o.offset).join(" ")),$('<div style="'+r.replace(/;-/g,";background-")+'"/>').get(0)):null}]];return d.overload(t,arguments)}function c(t){t=_.extend({},t);var e,n=t.marks;if(n)for(var r=0;r<n.length;r++)n[r]=new a(n[r]);Kai.app.vendor.is("CTRIP")&&Kai.app.code.is("MASTER")?e=new x(t):(delete t.marks,e=new L(t),n&&(_.each(n,function(t){t.appendTo(e)}),window.setTimeout(function(){e.autoFit()},10*n.length)))}function s(t){return t instanceof s?t:(t||(t={}),t.address&&(this.address=new O(t.address)),t.coordinate&&(this.coordinate=new n(t.coordinate)),_.extend(this,_.pick(t,["name","desc"])),this.phones=d.Array(t.phones),void(this.tags=d.Array(t.tags)))}var f={AMAP:{KEY:"0b895f63ca21c9e82eb158f46fe7f502"},GOOGLE:{KEY:void 0}},d={Array:function(t){var e=[];return t instanceof A&&t.forEach(function(t){e.push(t)}),t instanceof Array&&(e=t),"string"==typeof t&&t.length&&(e=t.split(/[,;]/)),e},clone:function N(t,e){var n=new t.constructor;return _.each(t,function(t,r){e&&!d.isScalar(t)?n[r]=N(t,e):n[r]=t}),n},create:function(t,e){return _.extend(new t,e)},createPrivateRegister:function(){var t=[],e=[];return function(n){var r=t.indexOf(n);return 0>r&&(t.push(n),e.push({}),r=t.length-1),e[r]}},genUid:function(){var t=(new Date).getTime();return function(){return"_$^$_"+t++}}(),ifEmpty:function(){for(var t=0,e=arguments;t<e.length-1;t++)if(e[t])return e[t];return e[t]},ifUndefined:function(){for(var t=0,e=arguments;t<e.length-1;t++)if(void 0!==e[t])return e[t];return e[t]},ifElse:function(t,e,n){return n(t)?t:e},invoke:function(){return arguments[0]=d.Array(arguments[0]),_.invoke.apply(_,arguments)},isScalar:function(t){return["object","function"].indexOf(typeof t)<0},loadJS:function(){var t={};return function(e,n){var r=t[e];r||(r={loaded:0,callbacks:[]},document.write=l.documentWrite,document.write('<script src="'+e+'"></script>'),document.write("",null,function(){r.loaded=1,r.callbacks.forEach(function(t){t()})})),n&&(r.loaded?n():r.callbacks.push(n))}}(),onerror:function(t,e){t&&t(new h(e))},overload:function(){function t(r,i){if(!(r instanceof e)){if(r.constructor==Function)return i&&i.constructor==r;if("function"==typeof r)return i instanceof r;if(r instanceof Array){var o=!1;return _.find(r,function(e){return o=t(e,i)}),o}if(d.isScalar(r))return i===r;throw n}try{return r.match(i)}catch(a){return!1}}var e=function(t){return this instanceof e?void(this.match=function(e){return t(e)}):new e(t)},n=new Error("Incorrect overload defintion."),r=function(e,r,i){var o;return _.find(e,function(e){var a,u=!0;if(_.isFunction(e))a=e;else{if(!_.isArray(e))throw n;a=_.last(e);var c=e.length-1;if(r.length!=c)return!1;for(var s=0;c>s&&u;s++)u=t(e[s],r[s])}return u?(o=a.apply(i,r),!0):void 0}),o};return _.extend(r,{Type:e,Function:function(t){return arguments.length>1&&(t=arguments),function(){return r(t,arguments)}}}),r}(),time:function(){return(new Date).getTime()},time2ms:function M(t,e){if("string"==typeof t&&t.match(/^(\d+(\.\d+)?)([a-z]+)$/)){var n={ms:1,s:1e3,m:6e4,h:36e4,d:864e5};t=window.parseFloat(RegExp.$1)*d.ifEmpty(n[RegExp.$3],1)}return t!=window.Infinity&&(t=window.parseInt(t)),window.isNaN(t)?e?M(e):0:t},times2ms:function(t,e){return t=d.ifEmpty(t,{}),_.each(e,function(e,n){t[n]=d.time2ms(t[n],e)}),t},end:1},l={documentWrite:function(){var t,e,n=[],r=function(t){for(var e,n=[];e=t.childNodes[0];)t.removeChild(e),n.push(e);return n},i=function o(t,e,n){for(var i,a,u=!1,c=function(){o(t,e,n)};i=e.shift();){if(i.children&&i.children.length)u=!0,a=r(i);else if("SCRIPT"==i.nodeName){var s=document.createElement("SCRIPT");i.src?(u=!0,s.onload=c,s.src=i.src):s.textContent=i.textContent,i=s}if(t.appendChild(i),a&&o(i,a,c),u)return}n&&n()};return function a(o,u,c){if(t){var s=document.currentScript,f={html:o,callback:c};n.length&&s==e||n.unshift([]),e=s,s&&(f.container=s.parentNode),n[0].push(f)}else{t=1;var d=document.createElement("div");d.innerHTML=o,i(u||document.currentScript&&document.currentScript.parentNode||document.body,r(d),function(){if(t=0,c&&c(),n[0]){var e=n[0].shift();n[0].length||n.shift(),a(e.html,e.container,e.callback)}})}}}(),setting:function(t,e){}},m=function(t){var e=this,n={},r=function(t,e){var r=n[t];return r&&r.apply(null,e),this};e.done=function(t){return n.done=t,this},e.fail=function(t){return n.fail=t,this},e.resolve=function(){return r.call(null,"done",arguments),e},e.reject=function(){return r.call(null,"fail",arguments),e},t&&(t.done=e.done,t.fail=e.fail)},p={remove:function(t){t.parentNode.removeChild(t)}},h=function(){var t={0:"unknown",1:"denied",2:"unavailable",3:"timeout",4:"abort"},e=function(e){return e instanceof Error?e:_.isNumber(e)?new Error(t[e]):new Error(e)};return _.extend(e,{Ajax:function(t){switch(t){case"error":return e(2);case"timeout":return e(3);default:return e(0)}},Position:function(n){return e(t[n.code])},AppLocate:function(t){}}),e}(),v={coordinate:function(t,e,r){r=d.times2ms(r,{timeout:"35s",maximumAge:"10m"}),r.enableHighAccuracy=d.ifUndefined(r.enableHighAccuracy,!0);try{var i=window.navigator.geolocation,o=function(){i.clearWatch(u)},a=function(){o(),d.onerror(e,4)},u=i.watchPosition(function(e){o(),t&&t(new n(e))},function(t){o(),d.onerror(e,h.Position(t))},r);return{abort:a}}catch(c){return d.onerror(e,h(2)),{abort:function(){}}}},address:function(t,e,n){n=d.times2ms(n,{timeout:"35s",maximumAge:"10m"});var r=new T(n.timeout),i=this.coordinate(function(n){i=y("REVERT_GEOCODING",{coordinate:n},t,e,{timeout:r.ttl})},e,n);return{abort:function(){i.abort()}}},city:function(t,e,n){n=d.times2ms(n,{timeout:"35s",maximumAge:"10m"});var r=new T(n.timeout),i=this.coordinate(function(n){i=n.queryCity(t,e,{timeout:r.ttl})},e,n);return{abort:function(){i.abort()}}}},g={coordinate:function(e,r,i){if(i=d.ifEmpty(i,{}),i.timeout=d.time2ms(i.timeout,"35s"),i.maximumAge=d.time2ms(i.maximumAge,"10m"),i.timeout<=1e3||i.timeout>6e4)throw"Service.cGeo._.coordinate failed: timeout exceeds (1 ~ 59 seconds allowed)";t.Fn("locate").once(function(t,i){i?d.onerror(r,i):["geo","address"].indexOf(t.type)>=0&&e(new n(parseFloat(t.value.lng),parseFloat(t.value.lat)))}).run(i.timeout/1e3,!1,0===i.maximumAge)},address:function(e,n,r){if(r=d.ifEmpty(r,{}),r.timeout=d.time2ms(r.timeout,"35s"),r.maximumAge=d.time2ms(r.maximumAge,"10m"),r.timeout<=1e3||r.timeout>6e4)throw"Service.cGeo._.address failed: timeout exceeds (1 ~ 59 seconds allowed)";t.Fn("locate").on(function(t,r){if(r)d.onerror(n,r);else if("address"==t.type){var i={};i[O.SCALE.PROVINCE]=t.value.province,i[O.SCALE.CITY]=t.value.city,i[O.SCALE.DISTRICT]=t.value.district,i[O.SCALE.UNKNOWN]=t.value.addrs.replace(),e(new O(i))}}).run(r.timeout/1e3,!1,0===r.maximumAge)},city:function(t,e,n){}},E=Kai.app.code.is("MASTER")||Kai.app.code.is("YOUTH")?g:v,w=function(){var t={},e={},n={},r=function(t,e){function n(){return t.apply(this,e)}return n.prototype=t.prototype,new n},i={construct:r,scaffold:function(i,o,a){var u=!1;return t[i]=[],e[i]=function(){if(u||(u=!0,a&&a(i)),n[i])return r(n[i],arguments);var e=this,c={handler:void 0,args:arguments,invokes:[]};return _.each(o,function(t){e[t]=function(){var e=c.handler&&c.handler[t];return e?c.handler[t].apply(c.handler,arguments):c.invokes.push({name:t,args:arguments}),this}}),t[i].push(c),e},e[i]},flesh:function(i,o,a){if(!e[i])throw new Error("Klass should be SCAFFOLD-ed before be FLESH-ed.");if(n[i])throw new Error("Klass should NOT be FLESH-ed repeatedly.");n[i]=o,_.extend(o.prototype,a),t[i].forEach(function(t){var e=r(o,t.args);t.invokes.forEach(function(t){var n=t.name;e[n]&&e[n].apply(e,t.args)}),t.handler=e})},create:function(t,e,n){n||(n=[]),_.extend(n,e.prototype);var r=d.genUid(),o=function(){var n=function(){i.flesh(r,e)};"function"==typeof t?t(n):d.loadJS(t,n)};return i.scaffold(r,n,o)}};return i}(),S=d.createPrivateRegister(),y=function P(t,e,n,r,i){var o,a;if(_.find(P._VENDOR_EX,function(n){return o=n,a=o.method?o.method(t,e,i):o.METHODS[t]}),!a)return void r(h(2));var u=function(t,e,i){try{return n(a.parser.call(o,t))}catch(u){d.onerror(r,2)}},c=function(t,e){r&&r(h.Ajax(e))},s=_.extend({},o.PARAMS,a.params);if(_.each(e,function(t,e){var n=o.convert[e];n?_.extend(s,n.call(o,t)):s[e]=t}),i=d.ifEmpty(i,{}),i.timeout=d.time2ms(i.timeout,"8s"),i.timeout)var f={url:o.BASE+a.path,type:o.TYPE,data:s,dataType:o.DATATYPE,success:u,error:c,timeout:i.timeout},l=$.ajax(f);else r(h(3));return{abort:function(){l&&(l.abort(),d.onerror(r,4))}}};y._VENDOR_EX={CTRIP:{BASE:"http://m.ctrip.com/restapi/soa2/",DATATYPE:"json",TYPE:"POST",METHODS:{CITYCODING:{path:"10398/json/LBSLocateCity",params:{},parser:function(t){return this.revert.city(t)}}},convert:{coordinate:function(t,e){return{Longitude:t.longitude,Latitude:t.latitude}}},revert:{city:function(t){var n,r;if(t&&t.CityEntities)for(;r=t.CityEntities.pop();)n=new e({id:r.CityID,name:r.CityName,parent:n});if(!n)throw".";return n}}},AMAP:{BASE:"http://restapi.amap.com/v3/",DATATYPE:"jsonp",PARAMS:{key:f.AMAP.KEY},METHODS:{REVERT_GEOCODING:{path:"geocode/regeo",params:{radius:0,extensions:"all"},parser:function(t){return this.revert.regeocode2address(t.regeocode)}},COORDINATE_TRANSFORM:{path:"assistant/coordinate/convert",parser:function(t){if(1==t.status)throw".";var e=new n(t.locations);return e.system=n.SYSTEM.MARS,e}},POIS_SEARCH_AROUND:{path:"place/around",params:{offset:10,page:1,radius:500,extensions:"all"},parser:function(t){for(var e,n=[],r=0;e=t.pois[r++];)n.push(this.revert.poi(e));return n}},POIS_SEARCH_LOCAL:{path:"place/text",params:{offset:10,page:1,extensions:"all"},parser:function(t){return this.METHODS.POIS_SEARCH_AROUND.parser.call(this,t)}}},method:function(t,e,n){return"POIS_SEARCH"==t&&(e.city&&(t="POIS_SEARCH_LOCAL"),e.coordinate&&(t="POIS_SEARCH_AROUND")),this.METHODS[t]},convert:{coordinate:function(t,e){var r={};return r[n.SYSTEM.EARTH]="gps",{location:t.toString(),locations:t.toString(),coordsys:r[t.system]}},name:function(t,e){return{keywords:t}}},revert:{poi:function(t){var e={},r={};r[O.SCALE.UNKNOWN]=d.ifElse(t.address,"",_.isString),r[O.SCALE.DISTRICT]=d.ifElse(t.adname,"",_.isString),r[O.SCALE.CITY]=d.ifElse(t.cityname,"",_.isString),r[O.SCALE.PROVINCE]=d.ifElse(t.pname,"",_.isString);var i=new O(r);return i.valid&&(e.address=i),t.location&&(e.coordinate=new n(t.location)),_.extend(e,{name:t.name,phones:t.tel.length?t.tel.split(";"):[],tags:t.type.split(";")}),new s(e)},regeocode2poi:function(t){return t.pois&&t.pois.length?this.poi(t.pois[0]):void 0},regeocode2address:function(t){var e={};return e[O.SCALE.PROVINCE]=d.ifElse(t.addressComponent.province,"",_.isString),e[O.SCALE.CITY]=d.ifElse(t.addressComponent.city,"",_.isString),e[O.SCALE.DISTRICT]=d.ifElse(t.addressComponent.district,"",_.isString),e[O.SCALE.TOWN]=d.ifElse(t.addressComponent.township,"",_.isString),e[O.SCALE.STREET]=d.ifElse(t.addressComponent.streetNumber.street,"",_.isString),e[O.SCALE.HOUSE]=_.isString(t.addressComponent.streetNumber.number)?t.addressComponent.streetNumber.number+"号":"",new O(e)}}}};var A=window.Set?window.Set:function(){var t=this,e=[];t.add=function(n){return e.indexOf(n)<0&&e.push(n),t},t["delete"]=function(n){return e=_.without(e,n),t},t.forEach=function(n){return e.forEach(function(e){n(e,e,t)}),t},Object.defineProperty(t,"size",{get:function(){return e.length}})},T=function(t){this.origin=d.time(),this.TTL=d.time2ms(t,window.Infinity)};Object.defineProperties(T.prototype,{age:{get:function(){return d.time()-this.origin}},ttl:{get:function(){return Math.max(0,this.TTL-this.age)}}});var C=window.WeakMap?window.WeakMap:function(){var t=this,e=[],n=[];this.get=function(t){return n[e.indexOf(t)]},this.set=function(r,i){var o=e.indexOf(r);return 0>o&&(o=e.length),e[o]=r,n[o]=i,t}},O=function(t){if(t instanceof O)return t;var e=[[String,function(t){this.name=t}],[Number,String,function(t,e){this.scale=t,this.name=e}],[Object,function(t){var e=[];_.each(t,function(t,n){t&&e.push(new O(window.parseInt(n),t))}),e.sort(function(t,e){return t.comprise(e)});for(var n=e.length-1;n>0;n--)e[n-1].parent=e[n];return e[0]}]];return d.overload(e,arguments,this)};O.SCALE=O.prototype.SCALE={UNKNOWN:0,ROOM:1,HOUSE:2,STREET:3,VILLIAGE:4,TOWN:5,COUNTY:6.1,DISTRICT:6.2,CITY:7,PROVINCE:8,COUNTRY:9},_.extend(O.prototype,{toString:function(){for(var t=[],e=this;e;)t.unshift(e.name),e=e.parent;return t.join("…").replace(/(\w)…(\w)/g,"$1 $2").replace(/…/g,"")},get:function(t){var e=0,n=this;"number"==typeof t||"string"==typeof t&&(t.match(/name$/i)&&(e=1,t=RegExp.leftContext),t=O.SCALE[t.toUpperCase()]);do if(n.scale==t)return e?n.name:n;while(n=n.parent)},comprise:function(t){return this.scale&&this.scale>t.scale},add:function(t){return this},accurateThan:function(t){var e=this,n=t;return e.valid?n?e.scale&&n.scale&&e.scale<n.scale?!0:e.depth>n.depth:!0:!1}}),Object.defineProperties(O.prototype,{scaleName:{get:function(){for(var t in O.SCALE)if(O.SCALE[t]==this.scale)return t}},depth:{get:function(){for(var t=1,e=this;e=e.parent;)t++;return t}},valid:{get:function(){return!!this.name}}}),n.SYSTEM={EARTH:1,MARS:2},n.prototype.toString=function(t){return"en_US"==t?this.latitude+","+this.longitude:this.longitude+","+this.latitude},n.prototype.transform=function(t){throw"Unable to transform coordinate system."},n.prototype.queryCity=function(t,e,n){y("CITYCODING",{coordinate:this},t,e,n)};var b=["moveTo","zoomTo","attach","detach","destroy","autoFit"],x=function(e){var n=[];e.marks&&_.each(e.marks,function(t){n.push({latitude:t.coordinate.latitude,longitude:t.coordinate.longitude,title:t.title})}),t.Fn("show_map_with_POI_list").run(n)},R=function(){var t=new C,e={LngLat:function(t){return new AMap.LngLat(t.longitude,t.latitude)},Marker:function(n){var r=t.get(n);return r||(r=new AMap.Marker({position:e.LngLat(n.coordinate),title:n.title,draggable:!0}),n.href&&(r.setClickable(!0),AMap.event.addListener(r,"click",function(){window.location.href=n.href})),n.icon&&r.setContent(n.icon),t.set(n,r)),r}};return w.create(function(t){var e=d.genUid();window[e]=t,d.loadJS("http://webapi.amap.com/maps?v=1.3&key="+f.AMAP.KEY+"&callback="+e)},function(t){var n=this,r=new A,i=new AMap.View2D({center:e.LngLat(t.center),zoom:t.zoom}),o=new AMap.Map(t.container,{view:i,dragEnable:!0,rotateEnable:!0,zoomEnable:!0});_.extend(n,{autoFit:function(){o.setFitView()},moveTo:function(t){o.setCenter(e.LngLat(t))},zoomTo:function(t){o.setZoom(t)},attach:function(t){var i=e.Marker(t);return i.setMap(o),r.add(i),n},detach:function(t){var i=e.Marker(t);return i.getMap()===o&&(i.setMap(null),r["delete"](i)),n},destroy:function(){o.destroy()}})},b)}(),L=function(t){var e,r,o=this,a=S(o),u=!1;if(a.element=$('<div style="width:100%;height:100%;"/>').get(0),o.children=new A,t=_.extend({zoom:15},t),o.appendTo(t.container),t.container=a.element,!t.center){var c=t.zoom;t.zoom=4,t.center=[113.5,29.6],i("coordinate",function(t){u||r.moveTo(t).zoomTo(c)})}t.center=new n(t.center),e=R,r=new e(t);var s={destroy:function(){p.remove(a.element)},moveTo:function(){return u=!0,[w.construct(n,arguments)]},zoomTo:function(){return u=!0,arguments}};_.each(b,function(t){o[t]=function(){var e=arguments,n=s[t];return n&&(e=n.apply(o,arguments)),r[t].apply(r,e),o}})};_.extend(L.prototype,{appendTo:function(t){var e,n=S(this).element,r=!t,i={};r?(e=document.body,i={position:"absolute",top:0}):(e=$(t).get(0),i={position:""}),$(n).css(i),e.appendChild(n)},append:function k(){var t=[[[o,a],function(t){if(t!==this&&t.parent!==this){t.remove(),t.parent=this,this.children.add(t);var e=this instanceof L?this:this.map;e&&S(t).attachTo(e)}}],[[Array,A],function(t){_.each(d.Array(t),k,this)}]];return d.overload(t,arguments,this),this},remove:function D(){var t=[[function(){this instanceof o&&this.parent&&this.parent.remove(this),this instanceof L&&p.remove(S(this).element)}],[[o,a],function(t){t.parent==this&&(this.children["delete"](t),delete t.parent,S(t).detach())}],[[Array,A],function(t){_.each(d.Array(t),D,this)}]];return d.overload(t,arguments,this),this}}),_.extend(o.prototype,{appendTo:function(t){return t.append(this),this},append:L.prototype.append,remove:L.prototype.remove}),L.Layer=o,L.Mark=a;var I=function(){var t,e=this,n=new m(this),r={};this.where=function(t,n){return r[t]=n,e},this.run=function(e){return e=d.time2ms(e,{timeout:"8s"}),t=y("POIS_SEARCH",r,n.resolve,n.reject,e),this},this.abort=function(){t&&t.abort()}};return window.geo={Address:O,City:e,Coordinate:n,Geolocation:r,locate:i,Map:L,POI:s,POIQuery:I,SMap:c},window.geo});
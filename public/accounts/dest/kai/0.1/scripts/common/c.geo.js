define("common/c.geo",["_","$"],function(){"use strict";function t(n){if(n instanceof t)return n;n||(n={}),f.isScalar(n.id)&&(this.id=n.id+""),_.isString(n.name)&&(this.name=n.name),n.parent instanceof t&&(this.parent=n.parent);var r;n.coordinate instanceof e&&(r=n.coordinate)}function e(t){if(t instanceof e)return t;if(!(this instanceof e))return E.construct(e,arguments);this.system=e.SYSTEM.EARTH;var n=[[Number,Number,function(t,e){this.longitude=t,this.latitude=e}],[Array,function(t){this.longitude=t[0],this.latitude=t[1]}],[[c,o],function(t){return f.clone(t.coordinate)}],[String,function(t){t.match(/^([\d.]+),([\d.]+)$/)&&(this.longitude=RegExp.$1,this.latitude=RegExp.$2)}],[f.overload.Type(function(t){return t&&"number"==typeof t.lat&&"number"==typeof t.lng}),function(t){this.longitude=t.lng,this.latitude=t.lat}],[f.overload.Type(function(t){return t&&t.coords}),function(t){_.extend(this,_.pick(t.coords,"longitude","latitude"))}]];return f.overload(n,arguments,this)}function n(t){var e,n=this,r=new l(this);return n.run=function(i){return i=f.times2ms(i,{timeout:"35s",maximumAge:"10m"}),e=g[t](r.resolve,r.reject,i),n},n.abort=function(){return e&&e.abort(),n},n}function r(t,e,r,i){new n(t).done(e).fail(r).run(i)}function i(){var t=this,e=w(t);t.children=new y,e.attachTo=function(e){t.map=e,t.children.forEach(function(t){w(t).attachTo(e)})},e.detach=function(){t.map&&(t.children.forEach(function(t){w(t).detach()}),delete this.map)}}function o(){var t=this,n=w(t),r=[[c,function(t){this.coordinate=t.coordinate,this.title=t.name}],[Object,function(t){t.poi&&(this.coordinate=t.poi.coordinate,this.title=t.poi.name),t.coordinate&&(this.coordinate=new e(t.coordinate)),t.icon&&(this.icon=a(t.icon)),_.extend(this,_.pick(t,["title","href"]))}]];f.overload(r,arguments,t),n.attachTo=function(e){t.map=e,e.attach(t)},n.detach=function(e){t.map&&(e.detach(t),delete t.map)},t.appendTo=function(e){e.append(t)},t.remove=function(){t.parent&&t.parent.remove(t)}}function a(){var t=[[f.overload.Type(function(t){return new RegExp("^<").test(t)}),function(t){return $(t).get(0)}],[[String,HTMLElement],function(t){return t}],[Object,function(t){var e,n=function(t){return _.isString(t)?t=t.split(/\s|,/):t.constructor==Object&&(t=[t.x||t.width,t.y||t.height]),[parseFloat(t[0])+"px",parseFloat(t[1])+"px"]},r="",i=t.size,o=t.image,a=_.isString(o)?o:o.url;return o?(i&&(e=n(i),r+="; width:"+e[0],r+="; height:"+e[1]),a&&(r+=";-image:url("+a+")"),o.size&&(r+=";-size:"+n(o.size).join(" ")),o.offset&&(r+=";-position:"+n(o.offset).join(" ")),$('<div style="'+r.replace(/;-/g,";background-")+'"/>').get(0)):null}]];return f.overload(t,arguments)}function u(t){t=_.extend({},t);var e,n=t.marks;if(n)for(var r=0;r<n.length;r++)n[r]=new o(n[r]);Kai.app.vendor.is("CTRIP")&&Kai.app.code.is("MASTER")?e=new b(t):(delete t.marks,e=new R(t),n&&(_.each(n,function(t){t.appendTo(e)}),window.setTimeout(function(){e.autoFit()},10*n.length)))}function c(t){return t instanceof c?t:(t||(t={}),t.address&&(this.address=new C(t.address)),t.coordinate&&(this.coordinate=new e(t.coordinate)),_.extend(this,_.pick(t,["name","desc"])),this.phones=f.Array(t.phones),void(this.tags=f.Array(t.tags)))}var s={AMAP:{KEY:"0b895f63ca21c9e82eb158f46fe7f502"},GOOGLE:{KEY:void 0}},f={Array:function(t){var e=[];return t instanceof y&&t.forEach(function(t){e.push(t)}),t instanceof Array&&(e=t),"string"==typeof t&&t.length&&(e=t.split(/[,;]/)),e},clone:function I(t,e){var n=new t.constructor;return _.each(t,function(t,r){e&&!f.isScalar(t)?n[r]=I(t,e):n[r]=t}),n},create:function(t,e){return _.extend(new t,e)},createPrivateRegister:function(){var t=[],e=[];return function(n){var r=t.indexOf(n);return 0>r&&(t.push(n),e.push({}),r=t.length-1),e[r]}},genUid:function(){var t=(new Date).getTime();return function(){return"_$^$_"+t++}}(),ifEmpty:function(){for(var t=0,e=arguments;t<e.length-1;t++)if(e[t])return e[t];return e[t]},ifUndefined:function(){for(var t=0,e=arguments;t<e.length-1;t++)if(void 0!==e[t])return e[t];return e[t]},ifElse:function(t,e,n){return n(t)?t:e},invoke:function(){return arguments[0]=f.Array(arguments[0]),_.invoke.apply(_,arguments)},isScalar:function(t){return["object","function"].indexOf(typeof t)<0},loadJS:function(){var t={};return function(e,n){var r=t[e];r||(r={loaded:0,callbacks:[]},document.write=d.documentWrite,document.write('<script src="'+e+'"></script>'),document.write("",null,function(){r.loaded=1,r.callbacks.forEach(function(t){t()})})),n&&(r.loaded?n():r.callbacks.push(n))}}(),onerror:function(t,e){t&&t(new h(e))},overload:function(){function t(r,i){if(!(r instanceof e)){if(r.constructor==Function)return i&&i.constructor==r;if("function"==typeof r)return i instanceof r;if(r instanceof Array){var o=!1;return _.find(r,function(e){return o=t(e,i)}),o}if(f.isScalar(r))return i===r;throw n}try{return r.match(i)}catch(a){return!1}}var e=function(t){return this instanceof e?void(this.match=function(e){return t(e)}):new e(t)},n=new Error("Incorrect overload defintion."),r=function(e,r,i){var o;return _.find(e,function(e){var a,u=!0;if(_.isFunction(e))a=e;else{if(!_.isArray(e))throw n;a=_.last(e);var c=e.length-1;if(r.length!=c)return!1;for(var s=0;c>s&&u;s++)u=t(e[s],r[s])}return u?(o=a.apply(i,r),!0):void 0}),o};return _.extend(r,{Type:e,Function:function(t){return arguments.length>1&&(t=arguments),function(){return r(t,arguments)}}}),r}(),time:function(){return(new Date).getTime()},time2ms:function N(t,e){if("string"==typeof t&&t.match(/^(\d+(\.\d+)?)([a-z]+)$/)){var n={ms:1,s:1e3,m:6e4,h:36e4,d:864e5};t=window.parseFloat(RegExp.$1)*f.ifEmpty(n[RegExp.$3],1)}return t!=window.Infinity&&(t=window.parseInt(t)),window.isNaN(t)?e?N(e):0:t},times2ms:function(t,e){return t=f.ifEmpty(t,{}),_.each(e,function(e,n){t[n]=f.time2ms(t[n],e)}),t},end:1},d={documentWrite:function(){var t,e,n=[],r=function(t){for(var e,n=[];e=t.childNodes[0];)t.removeChild(e),n.push(e);return n},i=function o(t,e,n){for(var i,a,u=!1,c=function(){o(t,e,n)};i=e.shift();){if(i.children&&i.children.length)u=!0,a=r(i);else if("SCRIPT"==i.nodeName){var s=document.createElement("SCRIPT");i.src?(u=!0,s.onload=c,s.src=i.src):s.textContent=i.textContent,i=s}if(t.appendChild(i),a&&o(i,a,c),u)return}n&&n()};return function a(o,u,c){if(t){var s=document.currentScript,f={html:o,callback:c};n.length&&s==e||n.unshift([]),e=s,s&&(f.container=s.parentNode),n[0].push(f)}else{t=1;var d=document.createElement("div");d.innerHTML=o,i(u||document.currentScript&&document.currentScript.parentNode||document.body,r(d),function(){if(t=0,c&&c(),n[0]){var e=n[0].shift();n[0].length||n.shift(),a(e.html,e.container,e.callback)}})}}}(),setting:function(t,e){}},l=function(t){var e=this,n={},r=function(t,e){var r=n[t];return r&&r.apply(null,e),this};e.done=function(t){return n.done=t,this},e.fail=function(t){return n.fail=t,this},e.resolve=function(){return r.call(null,"done",arguments),e},e.reject=function(){return r.call(null,"fail",arguments),e},t&&(t.done=e.done,t.fail=e.fail)},m={remove:function(t){t.parentNode.removeChild(t)}},h=function(){var t={0:"unknown",1:"denied",2:"unavailable",3:"timeout",4:"abort"},e=function(e){return e instanceof Error?e:_.isNumber(e)?new Error(t[e]):new Error(e)};return _.extend(e,{Ajax:function(t){switch(t){case"error":return e(2);case"timeout":return e(3);default:return e(0)}},Position:function(n){return e(t[n.code])},AppLocate:function(t){}}),e}(),p={coordinate:function(t,n,r){r=f.times2ms(r,{timeout:"35s",maximumAge:"10m"}),r.enableHighAccuracy=f.ifUndefined(r.enableHighAccuracy,!0);try{var i=window.navigator.geolocation,o=function(){i.clearWatch(u)},a=function(){o(),f.onerror(n,4)},u=i.watchPosition(function(n){o(),t&&t(new e(n))},function(t){o(),f.onerror(n,h.Position(t))},r);return{abort:a}}catch(c){return f.onerror(n,h(2)),{abort:function(){}}}},address:function(t,e,n){n=f.times2ms(n,{timeout:"35s",maximumAge:"10m"});var r=new A(n.timeout),i=this.coordinate(function(n){i=S("REVERT_GEOCODING",{coordinate:n},t,e,{timeout:r.ttl})},e,n);return{abort:function(){i.abort()}}},city:function(t,e,n){n=f.times2ms(n,{timeout:"35s",maximumAge:"10m"});var r=new A(n.timeout),i=this.coordinate(function(n){i=n.queryCity(t,e,{timeout:r.ttl})},e,n);return{abort:function(){i.abort()}}}},v={coordinate:function(t,n,r){if(r=f.ifEmpty(r,{}),r.timeout=f.time2ms(r.timeout,"35s"),r.maximumAge=f.time2ms(r.maximumAge,"10m"),r.timeout<=1e3||r.timeout>6e4)throw"Service.cGeo._.coordinate failed: timeout exceeds (1 ~ 59 seconds allowed)";Hish.Fn("locate").once(function(r,i){i?f.onerror(n,i):["geo","address"].indexOf(r.type)>=0&&t(new e(parseFloat(r.value.lng),parseFloat(r.value.lat)))}).run(r.timeout/1e3,!1,0===r.maximumAge)},address:function(t,e,n){if(n=f.ifEmpty(n,{}),n.timeout=f.time2ms(n.timeout,"35s"),n.maximumAge=f.time2ms(n.maximumAge,"10m"),n.timeout<=1e3||n.timeout>6e4)throw"Service.cGeo._.address failed: timeout exceeds (1 ~ 59 seconds allowed)";Hish.Fn("locate").on(function(n,r){if(r)f.onerror(e,r);else if("address"==n.type){var i={};i[C.SCALE.PROVINCE]=n.value.province,i[C.SCALE.CITY]=n.value.city,i[C.SCALE.DISTRICT]=n.value.district,i[C.SCALE.UNKNOWN]=n.value.addrs.replace(),t(new C(i))}}).run(n.timeout/1e3,!1,0===n.maximumAge)},city:function(t,e,n){}},g=Kai.app.code.is("MASTER")||Kai.app.code.is("YOUTH")?v:p,E=function(){var t={},e={},n={},r=function(t,e){function n(){return t.apply(this,e)}return n.prototype=t.prototype,new n},i={construct:r,scaffold:function(i,o,a){var u=!1;return t[i]=[],e[i]=function(){if(u||(u=!0,a&&a(i)),n[i])return r(n[i],arguments);var e=this,c={handler:void 0,args:arguments,invokes:[]};return _.each(o,function(t){e[t]=function(){var e=c.handler&&c.handler[t];return e?c.handler[t].apply(c.handler,arguments):c.invokes.push({name:t,args:arguments}),this}}),t[i].push(c),e},e[i]},flesh:function(i,o,a){if(!e[i])throw new Error("Klass should be SCAFFOLD-ed before be FLESH-ed.");if(n[i])throw new Error("Klass should NOT be FLESH-ed repeatedly.");n[i]=o,_.extend(o.prototype,a),t[i].forEach(function(t){var e=r(o,t.args);t.invokes.forEach(function(t){var n=t.name;e[n]&&e[n].apply(e,t.args)}),t.handler=e})},create:function(t,e,n){n||(n=[]),_.extend(n,e.prototype);var r=f.genUid(),o=function(){var n=function(){i.flesh(r,e)};"function"==typeof t?t(n):f.loadJS(t,n)};return i.scaffold(r,n,o)}};return i}(),w=f.createPrivateRegister(),S=function M(t,e,n,r,i){var o,a;if(_.find(M._VENDOR_EX,function(n){return o=n,a=o.method?o.method(t,e,i):o.METHODS[t]}),!a)return void r(h(2));var u=function(t,e,i){try{return n(a.parser.call(o,t))}catch(u){f.onerror(r,2)}},c=function(t,e){r&&r(h.Ajax(e))},s=_.extend({},o.PARAMS,a.params);if(_.each(e,function(t,e){var n=o.convert[e];n?_.extend(s,n.call(o,t)):s[e]=t}),i=f.ifEmpty(i,{}),i.timeout=f.time2ms(i.timeout,"8s"),i.timeout)var d={url:o.BASE+a.path,type:o.TYPE,data:s,dataType:o.DATATYPE,success:u,error:c,timeout:i.timeout},l=$.ajax(d);else r(h(3));return{abort:function(){l&&(l.abort(),f.onerror(r,4))}}};S._VENDOR_EX={CTRIP:{BASE:"http://m.ctrip.com/restapi/soa2/",DATATYPE:"json",TYPE:"POST",METHODS:{CITYCODING:{path:"10398/json/LBSLocateCity",params:{},parser:function(t){return this.revert.city(t)}}},convert:{coordinate:function(t,e){return{Longitude:t.longitude,Latitude:t.latitude}}},revert:{city:function(e){var n,r;if(e&&e.CityEntities)for(;r=e.CityEntities.pop();)n=new t({id:r.CityID,name:r.CityName,parent:n});if(!n)throw".";return n}}},AMAP:{BASE:"http://restapi.amap.com/v3/",DATATYPE:"jsonp",PARAMS:{key:s.AMAP.KEY},METHODS:{REVERT_GEOCODING:{path:"geocode/regeo",params:{radius:0,extensions:"all"},parser:function(t){return this.revert.regeocode2address(t.regeocode)}},COORDINATE_TRANSFORM:{path:"assistant/coordinate/convert",parser:function(t){if(1==t.status)throw".";var n=new e(t.locations);return n.system=e.SYSTEM.MARS,n}},POIS_SEARCH_AROUND:{path:"place/around",params:{offset:10,page:1,radius:500,extensions:"all"},parser:function(t){for(var e,n=[],r=0;e=t.pois[r++];)n.push(this.revert.poi(e));return n}},POIS_SEARCH_LOCAL:{path:"place/text",params:{offset:10,page:1,extensions:"all"},parser:function(t){return this.METHODS.POIS_SEARCH_AROUND.parser.call(this,t)}}},method:function(t,e,n){return"POIS_SEARCH"==t&&(e.city&&(t="POIS_SEARCH_LOCAL"),e.coordinate&&(t="POIS_SEARCH_AROUND")),this.METHODS[t]},convert:{coordinate:function(t,n){var r={};return r[e.SYSTEM.EARTH]="gps",{location:t.toString(),locations:t.toString(),coordsys:r[t.system]}},name:function(t,e){return{keywords:t}}},revert:{poi:function(t){var n={},r={};r[C.SCALE.UNKNOWN]=f.ifElse(t.address,"",_.isString),r[C.SCALE.DISTRICT]=f.ifElse(t.adname,"",_.isString),r[C.SCALE.CITY]=f.ifElse(t.cityname,"",_.isString),r[C.SCALE.PROVINCE]=f.ifElse(t.pname,"",_.isString);var i=new C(r);return i.valid&&(n.address=i),t.location&&(n.coordinate=new e(t.location)),_.extend(n,{name:t.name,phones:t.tel.length?t.tel.split(";"):[],tags:t.type.split(";")}),new c(n)},regeocode2poi:function(t){return t.pois&&t.pois.length?this.poi(t.pois[0]):void 0},regeocode2address:function(t){var e={};return e[C.SCALE.PROVINCE]=f.ifElse(t.addressComponent.province,"",_.isString),e[C.SCALE.CITY]=f.ifElse(t.addressComponent.city,"",_.isString),e[C.SCALE.DISTRICT]=f.ifElse(t.addressComponent.district,"",_.isString),e[C.SCALE.TOWN]=f.ifElse(t.addressComponent.township,"",_.isString),e[C.SCALE.STREET]=f.ifElse(t.addressComponent.streetNumber.street,"",_.isString),e[C.SCALE.HOUSE]=_.isString(t.addressComponent.streetNumber.number)?t.addressComponent.streetNumber.number+"号":"",new C(e)}}}};var y=window.Set?window.Set:function(){var t=this,e=[];t.add=function(n){return e.indexOf(n)<0&&e.push(n),t},t["delete"]=function(n){return e=_.without(e,n),t},t.forEach=function(n){return e.forEach(function(e){n(e,e,t)}),t},Object.defineProperty(t,"size",{get:function(){return e.length}})},A=function(t){this.origin=f.time(),this.TTL=f.time2ms(t,window.Infinity)};Object.defineProperties(A.prototype,{age:{get:function(){return f.time()-this.origin}},ttl:{get:function(){return Math.max(0,this.TTL-this.age)}}});var T=window.WeakMap?window.WeakMap:function(){var t=this,e=[],n=[];this.get=function(t){return n[e.indexOf(t)]},this.set=function(r,i){var o=e.indexOf(r);return 0>o&&(o=e.length),e[o]=r,n[o]=i,t}},C=function(t){if(t instanceof C)return t;var e=[[String,function(t){this.name=t}],[Number,String,function(t,e){this.scale=t,this.name=e}],[Object,function(t){var e=[];_.each(t,function(t,n){t&&e.push(new C(window.parseInt(n),t))}),e.sort(function(t,e){return t.comprise(e)});for(var n=e.length-1;n>0;n--)e[n-1].parent=e[n];return e[0]}]];return f.overload(e,arguments,this)};C.SCALE=C.prototype.SCALE={UNKNOWN:0,ROOM:1,HOUSE:2,STREET:3,VILLIAGE:4,TOWN:5,COUNTY:6.1,DISTRICT:6.2,CITY:7,PROVINCE:8,COUNTRY:9},_.extend(C.prototype,{toString:function(){for(var t=[],e=this;e;)t.unshift(e.name),e=e.parent;return t.join("…").replace(/(\w)…(\w)/g,"$1 $2").replace(/…/g,"")},get:function(t){var e=0,n=this;"number"==typeof t||"string"==typeof t&&(t.match(/name$/i)&&(e=1,t=RegExp.leftContext),t=C.SCALE[t.toUpperCase()]);do if(n.scale==t)return e?n.name:n;while(n=n.parent)},comprise:function(t){return this.scale&&this.scale>t.scale},add:function(t){return this},accurateThan:function(t){var e=this,n=t;return e.valid?n?e.scale&&n.scale&&e.scale<n.scale?!0:e.depth>n.depth:!0:!1}}),Object.defineProperties(C.prototype,{scaleName:{get:function(){for(var t in C.SCALE)if(C.SCALE[t]==this.scale)return t}},depth:{get:function(){for(var t=1,e=this;e=e.parent;)t++;return t}},valid:{get:function(){return!!this.name}}}),e.SYSTEM={EARTH:1,MARS:2},e.prototype.toString=function(t){return"en_US"==t?this.latitude+","+this.longitude:this.longitude+","+this.latitude},e.prototype.transform=function(t){throw"Unable to transform coordinate system."},e.prototype.queryCity=function(t,e,n){S("CITYCODING",{coordinate:this},t,e,n)};var O=["moveTo","zoomTo","attach","detach","destroy","autoFit"],b=function(t){var e=[];t.marks&&_.each(t.marks,function(t){e.push({latitude:t.coordinate.latitude,longitude:t.coordinate.longitude,title:t.title})}),Hish.Fn("show_map_with_POI_list").run(e)},x=function(){var t=new T,e={LngLat:function(t){return new AMap.LngLat(t.longitude,t.latitude)},Marker:function(n){var r=t.get(n);return r||(r=new AMap.Marker({position:e.LngLat(n.coordinate),title:n.title,draggable:!0}),n.href&&(r.setClickable(!0),AMap.event.addListener(r,"click",function(){window.location.href=n.href})),n.icon&&r.setContent(n.icon),t.set(n,r)),r}};return E.create(function(t){var e=f.genUid();window[e]=t,f.loadJS("http://webapi.amap.com/maps?v=1.3&key="+s.AMAP.KEY+"&callback="+e)},function(t){var n=this,r=new y,i=new AMap.View2D({center:e.LngLat(t.center),zoom:t.zoom}),o=new AMap.Map(t.container,{view:i,dragEnable:!0,rotateEnable:!0,zoomEnable:!0});_.extend(n,{autoFit:function(){o.setFitView()},moveTo:function(t){o.setCenter(e.LngLat(t))},zoomTo:function(t){o.setZoom(t)},attach:function(t){var i=e.Marker(t);return i.setMap(o),r.add(i),n},detach:function(t){var i=e.Marker(t);return i.getMap()===o&&(i.setMap(null),r["delete"](i)),n},destroy:function(){o.destroy()}})},O)}(),R=function(t){var n,i,o=this,a=w(o),u=!1;if(a.element=$('<div style="width:100%;height:100%;"/>').get(0),o.children=new y,t=_.extend({zoom:15},t),o.appendTo(t.container),t.container=a.element,!t.center){var c=t.zoom;t.zoom=4,t.center=[113.5,29.6],r("coordinate",function(t){u||i.moveTo(t).zoomTo(c)})}t.center=new e(t.center),n=x,i=new n(t);var s={destroy:function(){m.remove(a.element)},moveTo:function(){return u=!0,[E.construct(e,arguments)]},zoomTo:function(){return u=!0,arguments}};_.each(O,function(t){o[t]=function(){var e=arguments,n=s[t];return n&&(e=n.apply(o,arguments)),i[t].apply(i,e),o}})};_.extend(R.prototype,{appendTo:function(t){var e,n=w(this).element,r=!t,i={};r?(e=document.body,i={position:"absolute",top:0}):(e=$(t).get(0),i={position:""}),$(n).css(i),e.appendChild(n)},append:function P(){var t=[[[i,o],function(t){if(t!==this&&t.parent!==this){t.remove(),t.parent=this,this.children.add(t);var e=this instanceof R?this:this.map;e&&w(t).attachTo(e)}}],[[Array,y],function(t){_.each(f.Array(t),P,this)}]];return f.overload(t,arguments,this),this},remove:function k(){var t=[[function(){this instanceof i&&this.parent&&this.parent.remove(this),this instanceof R&&m.remove(w(this).element)}],[[i,o],function(t){t.parent==this&&(this.children["delete"](t),delete t.parent,w(t).detach())}],[[Array,y],function(t){_.each(f.Array(t),k,this)}]];return f.overload(t,arguments,this),this}}),_.extend(i.prototype,{appendTo:function(t){return t.append(this),this},append:R.prototype.append,remove:R.prototype.remove}),R.Layer=i,R.Mark=o;var L=function(){var t,e=this,n=new l(this),r={};this.where=function(t,n){return r[t]=n,e},this.run=function(e){return e=f.time2ms(e,{timeout:"8s"}),t=S("POIS_SEARCH",r,n.resolve,n.reject,e),this},this.abort=function(){t&&t.abort()}};return window.geo={Address:C,City:t,Coordinate:e,Geolocation:n,locate:r,Map:R,POI:c,POIQuery:L,SMap:u},window.geo});
define("data/storage/c.abstract.storage",["cutil/c.util.date","common/c.class.inherit"],function(e,t){var r=window.JSON,a=new t.Class({__propertys__:function(){this.proxy=null,this.overdueClearKey="C_CLEAR_OVERDUE_CATCH"},initialize:function($super,e){},removeOverdueCathch:function(){var t=(new e).getTime(),r=this.proxy.getItem(this.overdueClearKey),a=[],i=[];if(r){a=JSON.parse(r);for(var o,n=0;n<a.length;n++)o=a[n],new Date(o.timeout).getTime()<=t?this.proxy.removeItem(o.key):i.push(o);this.proxy.setItem(this.overdueClearKey,JSON.stringify(i))}},_removeOdCLately:function(e){e=e||5;var t=this.proxy.getItem(this.overdueClearKey),r=[];if(t){r=JSON.parse(t),r.sort(function(e,t){var r=new Date(e.timeout).getTime(),a=new Date(t.timeout).getTime();return r-a});for(var a=r.splice(0,e)||[],i=0;i<a.length;i++)this.proxy.removeItem(a[i].key);this.proxy.removeItem(this.overdueClearKey),r.length>0&&this.proxy.setItem(this.overdueClearKey,JSON.stringify(r))}},_setOverdueCathch:function(t,r){if(t&&r&&!(e.parse(r,!0)<new Date)){var a={},i=[],o=this.proxy.getItem(this.overdueClearKey);a.key=t,a.timeout=r,o&&(i=JSON.parse(o));for(var n,s=!1,u=0;u<i.length;u++)n=i[u],n.key==t&&(i[u]=a,s=!0);s||i.push(a),this.proxy.setItem(this.overdueClearKey,JSON.stringify(i))}},_buildStorageObj:function(e,t,r,a,i){var o={value:e,timeout:t,tag:r,savedate:a};return i&&(o.oldvalue=i),o},set:function(t,a,i,o,n,s){n=n||(new e).format("Y/m/d H:i:s"),i=i?new e(i):(new e).addDay(30);var u=i.format("Y/m/d H:i:s");this._setOverdueCathch(t,u);var h=this._buildStorageObj(a,u,o,n,s);try{return this.proxy.setItem(t,r.stringify(h)),!0}catch(l){"QuotaExceededError"==l.name&&(this._removeOdCLately(),this.set(t,a,i,o,n,s)),console}return!1},get:function(t,a,i){var o,n=null;try{o=this.proxy.getItem(t),o&&(o=r.parse(o),e.parse(o.timeout,!0)>=new Date&&(a?a===o.tag&&(n=i?o.oldvalue:o.value):n=i?o.oldvalue:o.value))}catch(s){console}return n},getTag:function(e){var t,a=null;try{t=this.proxy.getItem(e),t&&(t=r.parse(t),a=t&&t.tag)}catch(i){console}return a},getSaveDate:function(t,a){var i,o=null;try{i=this.proxy.getItem(t),i&&(i=r.parse(i),i.savedate&&(o=e.parse(i.savedate),a||(o=o.valueOf())))}catch(n){console}return o},getExpireTime:function(e){var t=null,a=null;try{t=this.proxy.getItem(e),t&&(t=r.parse(t),a=Date.parse(t.timeout))}catch(i){console}return a},remove:function(e){return this.proxy.removeItem(e)},getAll:function(){for(var e=this.proxy.length,t=[],r=0;e>r;r++){var a=this.proxy.key(r),i={key:a,value:this.get(a)};t.push(i)}return t},clear:function(){this.proxy.clear()},gc:function(){for(var e=this.proxy,t=this.proxy.length,r=0;t>r;r++){var a=e.key(r);if("GUID"==a)break;try{this.get(a)||this.remove(a)}catch(i){}}}});return a});
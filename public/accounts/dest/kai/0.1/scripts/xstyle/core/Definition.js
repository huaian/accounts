define("xstyle/core/Definition",["xstyle/core/utils","xstyle/core/observe"],function(e,t){function n(e){this.computeValue=e,e&&e.reverse&&this.setReverseCompute(e.reverse)}function r(e,n,r){return n&&n.forElement?{forElement:function(u){u=n.selectElement?n.selectElement(u):u;var o=["_cache_"+e.id];if(o in u){var c=u[o+"observe"];return c.addKey&&c.addKey(r),u[o][r]}var a=u[o]=n.forElement(u),s=u[o+"observe"]=i(e,a,r,{elements:[u]});return u.xcleanup=function(e){e&&t.unobserve(a,s)},a[r]}}:void 0}function i(e,n,r,i){var u,o=e._properties;return"object"==typeof n&&(u=function(e){for(var t=0;t<e.length;t++){var n=o[e[t].name];n&&n.invalidate&&n.invalidate(i)}},t.observe(n,u),u.addKey&&u.addKey(r)),u}var u={},o=1;return n.prototype={id:"x-variable-"+o++,cache:u,valueOf:function(){var e=this.dependents;if(e&&this.cache!==u)return this.cache;var t=this,n=this.computeValue;if(n.then)return this.cache=n.then(function(e){t.computeValue=e;var n=t.cache=e();return n&&n.then&&n.then(function(e){t.cache=e}),n});var r=t.cache=n();return r&&r.then&&r.then(function(e){t.cache=e}),r},property:function(t){var u=this._properties||(this._properties={}),o=u[t];if(!o){var c=this;o=u[t]=new n(function(){return e.when(c.valueOf(),function(e){if(e&&e.forRule)return{forRule:function(n){n=e.selectRule?e.selectRule(n):n;var u,o=["_cache_"+c.id];if(u=o in n?n[o]:n[o]=e.forRule(n),u&&u.forElement)return r(c,u,t);var a=n[o+"observe"];return a&&(a.addKey?a.addKey(t):n[o+"observe"]=i(c,u,t,{rules:[n]})),u[t]}};if(e&&e.forElement)return r(c,e,t);var n=c.cacheObserve;return n?n.addKey&&n.addKey(t):n=c.cacheObserve=i(c,e,t),e[t]})}),o.key=t,o.parent=this,o.put=function(n){return e.when(c.valueOf(),function(e){function r(e){return e.forElement?{forElement:function(r){e.forElement(r)[t]=n}}:void(e[t]=n)}return e.forRule?{forRule:function(t){return r(e.forRule(t))}}:void r(e)})},o.id=this.id+"-"+t}return o},invalidate:function(e){var n=this.cacheObserve;n&&(t.unobserve(this.cache,n),this.cacheObserve=null),this.cache=u;var r,i,o=this._properties;for(r in o)o[r].invalidate(e);var c=this.dependents||0;for(r=0,i=c.length;i>r;r++)try{c[r].invalidate(e)}catch(a){}},depend:function(e){(this.dependents||(this.dependents=[])).push(e)},setReverseCompute:function(e){this.put=function(t){e(t),this.invalidate()}},setCompute:function(e){this.computeValue=e,e&&e.reverse&&this.setReverseCompute(e.reverse),this.invalidate()},setSource:function(e){this.computeValue=function(){return e},this.invalidate()},observe:function(e){this.computeValue&&e(this.valueOf());var t=this;return this.depend({invalidate:function(){e(t.valueOf())}})},newElement:function(){return e.when(this.valueOf(),function(e){return e&&e.newElement&&e.newElement()})}},n});
define("xstyle/core/parser",["xstyle/core/utils"],function(e){function t(){this.push.apply(this,arguments)}function r(e){this.value=e}function n(){var e,t=this.args[0];if("string"==typeof t)e=t.split(/\s*,\s*/);else{if(!t)return[];e=[];for(var r=0,n=0;n<t.length+1;n++){var s=t[n];if("string"==typeof s||void 0===s){var a=s&&s.split(/\s*,\s*/);if(e.length>1||void 0===a){var c=t.slice(r,n);r>0&&c.unshift(e.pop()),r=n+1,e.push(c),a&&e.push.apply(e,a.slice(1))}}}}return e}function s(f,p,g){function h(p,g){function y(e){A=!1;var t=d.lastIndex;e.then(function(){A=!0,r&&(d.lastIndex=t,m())});var r=!0}function m(){function i(e){e&&"string"==typeof e&&C&&(e=C+e),D?D.push?"string"==typeof D[D.length-1]&&"string"==typeof e?D[D.length-1]+=e:e&&D.push(e):"string"==typeof D&&"string"==typeof e?D+=e:D=new t(D,e):D=e}for(A=!0;A;){var f=d.exec(p);if(!f)return;var m,k,D,b,q=f[5],C=f[1],O=f[2],F=f[3],N=f[4];switch(N=N&&u(N),O=O&&u(O),$?(F?(k=O,m=F.charAt(0),b="?"==F.charAt(1),F.indexOf("\n")>-1&&(N=F.slice(1))):N=O,D=N,$=!1):(N=F?O+F:O,i(N)),"{"!=q&&(T+=f[0]),q){case"'":case'"':var V="'"==q?a:c;V.lastIndex=d.lastIndex;var j=V.exec(p);j||w("unterminated string");var L=j[1].replace(/\\([a-fA-F\d]{0,5}[ a-fA-F\d]?)/g,function(e,t){return t?String.fromCharCode(parseInt(t,16)):void 0});d.lastIndex=V.lastIndex,i(new r(L)),T+=j[0];continue;case"\\":var U=V.lastIndex++;i(p.charAt(U));continue;case"(":case"{":case"[":var W,z=!1;if("{"==q){$=!0,":"==m&&F&&(O+=F),T=u((T+O).replace(/\s+/g," ")),i(W=I.newRule(T)),"="==m&&(R=!1,D.creating=!0,N&&N.match(/^\w/)&&(z=!0)),":"!=m||I.root||(D.creating=!0);var B,E=null,G=S;if(f[6]&&(B=g.cssRules||g.rules,(W.cssRule=E=B[f[6].slice(1)])&&(T=E.selectorText)),I.root&&R)for(B=g.cssRules||g.rules;E=B[S++];)if(E.selectorText==T||E.selectorText&&E.selectorText.replace(/::/g,":").replace(/'/g,'"')==T.replace(/::/g,":").replace(/'/g,'"')){W.cssRule=E;break}E||(W.ruleIndex=S=G),W.styleSheet=g,D.creating?(W.selector="."+("="==m?O.match(/[\w-]*$/g,"")[0]:"")+"-x-"+o++,W.creating=!0,z=!0):W.selector=I.root?T:I.selector+" "+T,T=""}else{var H=N.match(/(.*?)([\w-]*)$/);i(W=I.newCall(H[2],D,I)),W.ref=I.getDefinition(H[2]),W.getArgs=n,(D.calls||(D.calls=[])).push(W)}z&&N.replace(/(?:^|\s+)([\w-\.]+)\s*$/g,function(t,r){var n=e.extend(W,r,w);n&&n.then&&y(n)}),I.currentName=k,I.currentSequence=D,I.assignmentOperator=m;var J;if("{"==q&&(J=W.selector.match(/[@:]\w+/))){J=J[0];var K=I.getDefinition(J);K&&K.selector&&K.selector(W)}x.push(I=W),I.operator=q,I.start=d.lastIndex,k=null,D=null;continue}if(D){var O="string"==typeof D?D:D[0];if(O.charAt&&"@"==O.charAt(0)){var M=O.match(/\w+/)[0];if("import"==M){var P=s.getStyleSheet((g.cssRules||g.imports)[S++],D,g),Q=d.lastIndex;h(P.localSource,P),d.lastIndex=Q}else if("xstyle"==M){if("start"==O.slice(8,13)){var W=I?I.newRule(""):X;W.root=I.root,x.push(I=W)}else{var X=I||X;x.pop(),I=x[x.length-1]}d=I?v:/(@[\w\s])/g}}else if(m)try{var Y=I[":"==m?"setValue":"declareDefinition"](k,D,b);Y&&Y.then&&y(Y)}catch(Z){w(Z)}}switch(q){case":":"="==m?($=!0,m=":"):i(":");break;case"}":case")":case"]":l[I.operator]!=q&&w("Incorrect opening operator "+I.operator+" with closing operator "+q),k=null;var _=p.slice(I.start,d.lastIndex-1);if(I.cssText=I.cssText?I.cssText+";"+_:_,"}"==q){if("}"==te){var ee=I.parent.selector;ee&&"@"==!ee.charAt(0)&&w("A nested rule must end with a semicolon")}if(I.root)w("Unmatched "+q);else{try{I.onRule(I.selector,I)}catch(Z){w(Z)}R=!0}T=""}if(")"==q&&!m){I.args=[D];try{var Y=x[x.length-2].onArguments(I)}catch(Z){w(Z)}Y&&Y.then&&y(Y)}if(x.pop(),I=x[x.length-1],D=I.currentSequence,k=I.currentName,m=I.assignmentOperator,I.root&&"}"==q){if(m)try{I[":"==m?"setValue":"declareDefinition"](k,D[1]||D,b)}catch(Z){w(Z)}$=!0,m=!1}break;case"":case void 0:return;case";":D=null,$=!0,R=!1,m=!1,T=""}var te=q}}function w(e){var t=(g.href||"in-page stylesheet")+":"+p.slice(0,d.lastIndex).split("\n").length;h.onerror&&h.onerror(e,t),e.stack}p=p.replace(i,function(e){return e.replace(/[^\n]/g,"")});var I=f;d.lastIndex=0;var A,S=0,R=!0,T="",$=!0;m()}g=g||{addRule:function(){},cssRules:[]};var v,d=v=/(\s*)((?:[^{\}\[\]\(\)\\'":=;]|\[(?:[^\]'"]|'(?:\\.|[^'])*'|"(?:\\.|[^"])*")\])*)([=:]\??\s*([^{\}\[\]\(\)\\'":;]*))?(?:([{\}\[\]\(\)\\'":;])(\/\d+)?|$)/g,x=[f];f.parse=h,h(p,g)}var a=/((?:\\.|[^'])*)'/g,c=/((?:\\.|[^"])*)"/g,i=/\/\*[\w\W]*?\*\//g,l={"{":"}","[":"]","(":")"},o=0,u="".trim?function(e){return e.trim()}:function(e){return e.replace(/^\s+|\s+$/g,"")},f=t.prototype=[];return f.toString=function(){return this.join("")},f.isSequence=!0,r.prototype.toString=function(){return'"'+this.value.replace(/["\\\n\r]/g,"\\$&")+'"'},r.prototype.isLiteralString=!0,s});
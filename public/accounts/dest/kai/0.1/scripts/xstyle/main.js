define("xstyle/main",["require","xstyle/core/parser","xstyle/core/base","xstyle/core/elemental","xstyle/core/generate"],function(require,parser,ruleModel,elemental,generate){"use strict";function search(e){for(var s=document.getElementsByTagName(e),t=0;t<s.length;t++)checkImports(s[t])}function searchAll(){search("link"),search("style")}function checkImports(element,callback,fixedImports){function fixImports(){require(["xstyle/core/load-imports"],function(e){e(element,function(){checkImports(element,callback,!0)})})}function checkForInlinedExtensions(sheet){for(var cssRules=sheet.cssRules,i=0;i<cssRules.length;i++){var rule=cssRules[i];if(rule.selectorText&&"x-"==rule.selectorText.substring(0,2)&&(needsParsing=!0,/^'/.test(rule.style.content)))return parse(eval(rule.style.content),sheet,callback),!0}}var sheet=element.sheet||element.styleSheet;if(sheet&&(!sheet.processed||fixedImports)){sheet.processed=!0;var needsParsing=sheet.needsParsing,cssRules=sheet.rules||sheet.cssRules;if((sheet.href||sheet.imports&&sheet.imports.length)&&!fixedImports)return fixImports();if(!needsParsing)for(var i=0;i<cssRules.length;i++){var rule=cssRules[i];if(rule.href&&!fixedImports){if(!checkForInlinedExtensions(rule.styleSheet))return fixImports();return}}parse(sheet.localSource||(sheet.ownerNode||sheet.owningElement).innerHTML,sheet,callback)}}function parse(e,s,t){function r(){0==--l&&t&&t(s)}s.addRule||(s.addRule=function(e,s,t){return this.insertRule(e+"{"+s+"}",t>=0?t:this.cssRules.length)}),s.deleteRule||(s.deleteRule=s.removeRule);var l=1;(s.href||location.href).replace(/[^\/]+$/,"");return ruleModel.css=e,parser(ruleModel,e,s),r(ruleModel),ruleModel}elemental.ready(searchAll),parser.getStyleSheet=function(e,s){return e.styleSheet||e};var xstyle={process:checkImports,processAll:searchAll,parse:parse,generate:generate,update:elemental.update,load:function(e,s,t,r){s(["xstyle/css"],function(l){l.load(e,s,function(e){e?checkImports({sheet:e},t):(searchAll(),t())},r)})}};return xstyle});
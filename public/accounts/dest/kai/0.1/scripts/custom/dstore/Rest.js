define("custom/dstore/Rest",["dojo/_base/Deferred","dojo/request","dojo/when","dojo/_base/lang","dojo/json","dojo/io-query","dojo/_base/declare","custom/dstore/Request","data/store/c.common.store","dojo/_base/array","dstore/QueryResults"],function(e,t,r,n,a,s,o,i,d,u,h){var c=[].push,g=function(e){if(!window.localStorage){var t={body:null,responseStatus:{code:"000000-client",msg:"客户端不支持localstorage"}};return t[Kai.responseStatusKey].rejectObj.responseStatus,e.reject(t),!1}var r=d.HeadStore.getInstance(),n=d.UserStore.getInstance(),a=r.get(),s=n.get();if(!(dojoConfig.isH5?a&&a.auth:s)){var t={body:null,responseStatus:{code:"000000-client",msg:"当前未登录，请重新登录"}};return t[Kai.responseStatusKey]=t.responseStatus,e.reject(t),Kai.forward(Kai.loginUrl,{keepURL:!1}),!1}if(_.isObject(a)&&_.isObject(s)&&s.auth!==a.auth){Kai.showMessage({datamodel:{content:"您已在其他标签中登录本系统(或当前登录信息已过期)，请保存已编辑的内容后重新登录"},okAction:function(){this.hide(),Kai.forward(Kai.loginUrl,{keepURL:!1})}}),Kai.hideLoading(),n.remove();var t={body:null,responseStatus:{code:"000000-client",msg:"您已在其他标签中登录本系统(或当前登录信息已过期)，请保存已编辑的内容后重新登录"}};return t[Kai.responseStatusKey].rejectObj.responseStatus,e.reject(t),!1}return e.resolve(),!0},p=function(e){return Kai.hideLoading(),200!=e.response.status&&(403==e.response.status&&Kai.forward(Kai.loginUrl,{keepURL:!1}),Kai.showToast({text:e.response.text||"网络错误"})),e};return o(i,{stringify:a.stringify,get:function(r,a){a=a||{},Kai.showLoading();var s={},o={};if(window.localStorage){var i=d.HeadStore.getInstance(),u=d.UserStore.getInstance();s=u.get(),o=i.get()}var h=n.mixin({Accept:this.accepts,"Content-Type":"application/json","X-Sso-Token":o?o.auth:""},this.headers,a.headers||a),c=this,f=this.target;_.isObject(r)?(f+="?",_.each(r,function(e,t){f+=t+"="+encodeURIComponent(e)+"&"}),f=f.substr(0,f.length-1)):f+=r;var l=new e;return this.authRequired===!1||g(l)?t(f,{headers:h}).then(function(e){return Kai.hideLoading(),c._restore(c.parse(e),!0)},function(e){return p(e)}):l},autoEmitEvents:!1,put:function(a,s){var o={};if(Kai.showLoading(),s=s||{},window.localStorage){var i=d.HeadStore.getInstance();d.UserStore.getInstance();o=i.get()}else o={};var u="id"in s?s.id:this.getIdentity(a),h="undefined"!=typeof u,c=this,f="beforeId"in s?null===s.beforeId?{"Put-Default-Position":"end"}:{"Put-Before":s.beforeId}:h&&s.overwrite!==!1?null:{"Put-Default-Position":this.defaultNewToStart?"start":"end"},l=t(h&&!s.forcePost?this.target+u:this.target,{method:!h||s.forcePost||s.incremental?"POST":"PUT",data:this.stringify(a),headers:n.mixin({"Content-Type":"application/json","X-Sso-Token":o?o.auth:"",Accept:this.accepts,"If-Match":s.overwrite===!0?"*":null,"If-None-Match":s.overwrite===!1?"*":null},f,this.headers,s.headers)}),m=new e;return this.authRequired===!1||g(m)?l.then(function(e){var t={};"beforeId"in s&&(t.beforeId=s.beforeId);var n=t.target=c._restore(c.parse(e),!0)||a;return r(l.response,function(e){c.emit(201===e.status?"add":"update",t)}),Kai.hideLoading(),n},function(e){return p(e)}):m},add:function(t,r){Kai.showLoading(),r=r||{},r.overwrite=!1;var n=new e;return this.authRequired===!1||g(n)?this.put(t,r):n},remove:function(r,a){Kai.showLoading(),a=a||{};var s,o=this;if(window.localStorage){var i=d.HeadStore.getInstance();d.UserStore.getInstance();s=i.get()}else s={};this.headers["X-Sso-Token"]=s?s.auth:"";var u=new e;return this.authRequired===!1||g(u)?t(this.target+r,{method:"DELETE",headers:n.mixin({},this.headers,a.headers)}).then(function(e){var t=e&&o.parse(e);return o.emit("delete",{id:r,target:t}),Kai.hideLoading(),e?t:!0},function(e){return p(e)}):u},fetch:function(){var t=this._request(),r=new e;return this.authRequired===!1||g(r)?new h(t.data,{response:t.response}):r},query:function(){return this.get("")},fetchRange:function(t){var r=t.start,n=t.end,a={};this.useRangeHeaders?a.headers=this._renderRangeHeaders(r,n):a.queryParams=this._renderRangeParams(r,n),a.start=r,a.end=n;var s=this._request(a),o=new e;return this.authRequired===!1||g(o)?new h(s.data,{totalLength:s.total,response:s.response}):o},_request:function(r){r=r||{};var s=d.HeadStore.getInstance(),o=d.UserStore.getInstance(),i=s.get(),u=(o.get(),n.delegate(this.headers,{Accept:this.accepts,"Content-Type":"application/json","X-Sso-Token":i?i.auth:""}));"headers"in r&&n.mixin(u,r.headers);var h=this._renderQueryParams(),p=this.target;"queryParams"in r&&c.apply(h,r.queryParams),h.length>0&&(p+=(this._targetContainsQueryString?"&":"?")+h.join("&"));var f=this,l={};l=this.target._avoidEncapsulationBody?{pagenation:{startIndex:r.start+1,endIndex:r.end},page:{start:r.start,end:r.end},filter:f.filter}:{body:{pagenation:{startIndex:r.start+1,endIndex:r.end},page:{start:r.start,end:r.end},filter:f.filter}};var m=t(p,{method:Kai.useRest?f.method?f.method:"GET":"POST",data:a.stringify(l),headers:u}),v=new e;return this.authRequired===!1||g(v)?{data:m.then(function(e){for(var t=(a.parse(e),f.parse(e)),r=0,n=t.length;n>r;r++)t[r]=f._restore(t[r],!0);return t}),total:m.then(function(e){var t=f.parse(e),e=a.parse(e);if(_.isObject(e.body)){var r=0;if(_.isArray(e.body.content)?r=e.body.totalElements:_.isObject(e.body.obj)&&(r=e.body.obj.page.dataCount),r>-1)return r;var n=e.getHeader("Content-Range");return n&&(n=n.match(/\/(.*)/))&&+n[1]}return t.total||0}),response:m.response}:v},_renderFilterParams:function(e){var t=e.type,r=e.args;return t?"string"===t?[r[0]]:"and"===t||"or"===t?[u.map(e.args,function(e){var r=this._renderFilterParams(e);return"and"!==e.type&&"or"!==e.type||e.type===t?r:"("+r+")"},this).join("and"===t?"&":"|")]:[encodeURIComponent(r[0])+"="+("eq"===t?"":t+"=")+encodeURIComponent(r[1])]:[""]},_renderSortParams:function(e){var t=u.map(e,function(e){var t=e.descending?this.descendingPrefix:this.ascendingPrefix;return t+encodeURIComponent(e.property)},this),r=[];return t&&r.push(this.sortParam?encodeURIComponent(this.sortParam)+"="+t:"sort("+t+")"),r},_renderRangeParams:function(e,t){var r=[];return this.rangeStartParam?r.push(this.rangeStartParam+"="+e,this.rangeCountParam+"="+(t-e)):r.push("limit("+(t-e)+(e?","+e:"")+")"),r},_renderQueryParams:function(){var e=[];return u.forEach(this.queryLog,function(t){var r=t.type,n="_render"+r[0].toUpperCase()+r.substr(1)+"Params";this[n]&&c.apply(e,this[n].apply(this,t.normalizedArguments))},this),e},_renderUrl:function(){var e=this._renderQueryParams(),t=this.target;return e.length>0&&(t+="?"+e.join("&")),t},_renderRangeHeaders:function(e,t){var r="items="+e+"-"+(t-1);return{Range:r,"X-Range":r}}})});
define("custom/dstore/Trackable",["dojo/_base/lang","dojo/_base/declare","dojo/aspect","dojo/when","dojo/promise/all","dojo/_base/array","dojo/on","dstore/QueryResults"],function(t,e,n,r,a,i,o,s){function u(t,e){return{start:t,count:e-t}}function l(t,e,n){for(var r=t.length-1;r>=0;--r){var a=t[r],i=a.start,o=i+a.count;if(e>o)return void t.splice(r+1,0,u(e,n));n>=i&&(e=Math.min(e,i),n=Math.max(n,o),t.splice(r,1))}t.unshift(u(e,n))}function f(t,e,n){for(var r,a=0;r=t[a];++a){var i=r.start,o=i+r.count;if(i>=e){if(!(n>=o))return r.start=n,void(r.count=o-r.start);t.splice(a,1)}else if(o>e){if(n>i)return void t.splice(a,1,u(i,e),u(n,o));r.count=e-r.start}}}var c=0,d={track:function(){function a(){return function(){var t=this,e=this.inherited(arguments);return new s(r(e,function(e){return e=t._results=e.slice(),t._ranges=[],l(t._ranges,0,e.length),e}),{totalLength:e.totalLength})}}function u(){return function(t){var e=this,n=t.start,a=t.end,i=this.inherited(arguments);return r(i,function(t){return r(t.totalLength,function(r){var i=e._partialResults||(e._partialResults=[]);a=Math.min(a,n+t.length),i.length=r||0;var o=[n,a-n].concat(t);return i.splice.apply(i,o),l(e._ranges,n,a),t})}),i}}function d(e,n){c++;var a=n.target;n=t.delegate(n,I[e]),r(_._results||_._partialResults,function(t){function r(){var t=_["on_tracked"+e];t&&t.call(_,n)}if(!t)return void r();var o,s,u,l,f=_._ranges,c="id"in n?n.id:h.getIdentity(a),d=-1,g=-1,v=-1,p=-1;if("delete"===e||"update"===e)for(o=0;-1===d&&o<f.length;++o)for(l=f[o],s=l.start,u=s+l.count;u>s;++s){var I=t[s];if(h.getIdentity(I)==c){for(d=n.previousIndex=s,g=o,t.splice(d,1),l.count--,s=o+1;s<f.length;++s)f[s].start--;break}}if("add"===e||"update"===e){if(x){if(x([a]).length)for(var b,y,M,R=0,j=f.length-1,k=-1;j>=R&&-1===v;)o=R+Math.round((j-R)/2),l=f[o],b=t.slice(l.start,l.start+l.count),"beforeId"in n&&(k=null===n.beforeId?b.length:m(b,n.beforeId)),-1===k&&(k=d>=Math.max(0,l.start-1)&&d<=l.start+l.count?d:h.defaultNewToStart?0:b.length),b.splice(k,0,a),y=i.indexOf(x(b),a),M=l.start+y,0===y&&0!==l.start?j=o-1:y>=b.length-1&&M<t.length?R=o+1:(v=M,p=o)}else{var l,L=-1;if("beforeId"in n)if(null===n.beforeId)v=t.length,L=f.length-1;else for(o=0,u=f.length;-1===p&&u>o;++o)l=f[o],v=m(t,n.beforeId,l.start,l.start+l.count),-1!==v&&(p=o);else"update"===e?(v=d,p=g):h.defaultNewToStart?(v=0,L=0):(v=t.length,L=f.length-1);-1!==L&&-1===p&&(l=f[L],l&&l.start<=v&&v<=l.start+l.count&&(p=L))}if(v>-1&&p>-1)for(n.index=v,t.splice(v,0,a),f[p].count++,o=p+1;o<f.length;++o)f[o].start++}n.totalLength=t.length,r()})}var h=this.store||this,g=[],v={add:1,update:1,"delete":1};for(var p in v)g.push(this.on(p,function(t){return function(e){d(t,e)}}(p)));var _=e.safeMixin(t.delegate(this),{_ranges:[],fetch:a(),fetchRange:u(),releaseRange:function(t,e){if(this._partialResults){f(this._ranges,t,e);for(var n=t;e>n;++n)delete this._partialResults[n]}},on:function(t,e){var r=this,a=this.getInherited(arguments);return o.parse(_,t,e,function(t,i){return i in v?n.after(_,"on_tracked"+i,e,!0):a.call(r,i,e)})},tracking:{remove:function(){for(;g.length>0;)g.pop().remove();this.remove=function(){}}},track:null});this.fetchSync&&e.safeMixin(_,{fetchSync:a(),fetchRangeSync:u()});var x;i.forEach(this.queryLog,function(t){var e=x,n=t.querier;n&&(x=e?function(t){return n(e(t))}:n)});var I={add:{index:void 0},update:{previousIndex:void 0,index:void 0},"delete":{previousIndex:void 0}},m=function(t,e,n,r){n=void 0!==n?n:0,r=void 0!==r?r:t.length;for(var a=n;r>a;++a)if(h.getIdentity(t[a])===e)return a;return-1};return _}},h=e(null,d);return h.create=function(n,r){return n=e.safeMixin(t.delegate(n),d),e.safeMixin(n,r),n},h});
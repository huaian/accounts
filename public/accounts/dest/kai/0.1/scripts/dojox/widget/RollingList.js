define("dojox/widget/RollingList",["dojo","dijit","dojox","dojo/i18n!dijit/nls/common","dojo/require!dojo/window,dijit/layout/ContentPane,dijit/_Templated,dijit/_Contained,dijit/layout/_LayoutWidget,dijit/Menu,dijit/form/Button,dijit/focus,dijit/_base/focus,dojox/html/metrics,dojo/i18n"],function(t,e,i){t.provide("dojox.widget.RollingList"),t.experimental("dojox.widget.RollingList"),t.require("dojo.window"),t.require("dijit.layout.ContentPane"),t.require("dijit._Templated"),t.require("dijit._Contained"),t.require("dijit.layout._LayoutWidget"),t.require("dijit.Menu"),t.require("dijit.form.Button"),t.require("dijit.focus"),t.require("dijit._base.focus"),t.require("dojox.html.metrics"),t.require("dojo.i18n"),t.requireLocalization("dijit","common"),t.declare("dojox.widget._RollingListPane",[e.layout.ContentPane,e._Templated,e._Contained],{templateString:'<div class="dojoxRollingListPane"><table><tbody><tr><td dojoAttachPoint="containerNode"></td></tr></tbody></div>',parentWidget:null,parentPane:null,store:null,items:null,query:null,queryOptions:null,_focusByNode:!0,minWidth:0,_setContentAndScroll:function(t,e){this._setContent(t,e),this.parentWidget.scrollIntoView(this)},_updateNodeWidth:function(e,i){e.style.width="";var s=t.marginBox(e).w;i>s&&t.marginBox(e,{w:i})},_onMinWidthChange:function(t){this._updateNodeWidth(this.domNode,t)},_setMinWidthAttr:function(t){t!==this.minWidth&&(this.minWidth=t,this._onMinWidthChange(t))},startup:function(){this._started||(this.store&&this.store.getFeatures()["dojo.data.api.Notification"]&&window.setTimeout(t.hitch(this,function(){this.connect(this.store,"onSet","_onSetItem"),this.connect(this.store,"onNew","_onNewItem"),this.connect(this.store,"onDelete","_onDeleteItem")}),1),this.connect(this.focusNode||this.domNode,"onkeypress","_focusKey"),this.parentWidget._updateClass(this.domNode,"Pane"),this.inherited(arguments),this._onMinWidthChange(this.minWidth))},_focusKey:function(e){return e.charOrCode==t.keys.BACKSPACE?void t.stopEvent(e):void(e.charOrCode==t.keys.LEFT_ARROW&&this.parentPane?(this.parentPane.focus(),this.parentWidget.scrollIntoView(this.parentPane)):e.charOrCode==t.keys.ENTER&&this.parentWidget._onExecute())},focus:function(t){if(this.parentWidget._focusedPane!=this&&(this.parentWidget._focusedPane=this,this.parentWidget.scrollIntoView(this),this._focusByNode&&(!this.parentWidget._savedFocus||t)))try{(this.focusNode||this.domNode).focus()}catch(e){}},_onShow:function(){this.inherited(arguments),(this.store||this.items)&&(this.refreshOnShow&&this.domNode||!this.isLoaded&&this.domNode)&&this.refresh()},_load:function(){this.isLoaded=!1,this.items?(this._setContentAndScroll(this.onLoadStart(),!0),window.setTimeout(t.hitch(this,"_doQuery"),1)):this._doQuery()},_doLoadItems:function(e,i){var s=0,n=this.store;if(t.forEach(e,function(t){n.isItemLoaded(t)||s++}),0===s)i();else{var o=function(t){s--,0===s&&i()};t.forEach(e,function(t){n.isItemLoaded(t)||n.loadItem({item:t,onItem:o})})}},_doQuery:function(){if(this.domNode){var e=this.parentWidget.preloadItems;e=e===!0||this.items&&this.items.length<=Number(e),this.items&&e?this._doLoadItems(this.items,t.hitch(this,"onItems")):this.items?this.onItems():(this._setContentAndScroll(this.onFetchStart(),!0),this.store.fetch({query:this.query,onComplete:function(t){this.items=t,this.onItems()},onError:function(t){this._onError("Fetch",t)},scope:this}))}},_hasItem:function(t){for(var e,i=this.items||[],s=0;e=i[s];s++)if(this.parentWidget._itemsMatch(e,t))return!0;return!1},_onSetItem:function(t,e,i,s){this._hasItem(t)&&this.refresh()},_onNewItem:function(t,e){var i;!e&&!this.parentPane||e&&this.parentPane&&this.parentPane._hasItem(e.item)&&(i=this.parentPane._getSelected())&&this.parentWidget._itemsMatch(i.item,e.item)?(this.items.push(t),this.refresh()):e&&this.parentPane&&this._hasItem(e.item)&&this.refresh()},_onDeleteItem:function(e){this._hasItem(e)&&(this.items=t.filter(this.items,function(t){return t!=e}),this.refresh())},onFetchStart:function(){return this.loadingMessage},onFetchError:function(t){return this.errorMessage},onLoadStart:function(){return this.loadingMessage},onLoadError:function(t){return this.errorMessage},onItems:function(){this.onLoadDeferred||(this.cancel(),this.onLoadDeferred=new t.Deferred(t.hitch(this,"cancel"))),this._onLoadHandler()}}),t.declare("dojox.widget._RollingListGroupPane",[i.widget._RollingListPane],{templateString:'<div><div dojoAttachPoint="containerNode"></div><div dojoAttachPoint="menuContainer"><div dojoAttachPoint="menuNode"></div></div></div>',_menu:null,_setContent:function(t){this._menu||this.inherited(arguments)},_onMinWidthChange:function(e){if(this._menu){var i=t.marginBox(this.domNode).w,s=t.marginBox(this._menu.domNode).w;this._updateNodeWidth(this._menu.domNode,e-(i-s))}},onItems:function(){var e;this._menu&&(e=this._getSelected(),this._menu.destroyRecursive()),this._menu=this._getMenu();var i,s;if(this.items.length?t.forEach(this.items,function(t){i=this.parentWidget._getMenuItemForItem(t,this),i&&(e&&this.parentWidget._itemsMatch(i.item,e.item)&&(s=i),this._menu.addChild(i))},this):(i=this.parentWidget._getMenuItemForItem(null,this),i&&this._menu.addChild(i)),s){if(this._setSelected(s),e&&!e.children&&s.children||e&&e.children&&!s.children){var n=this.parentWidget._getPaneForItem(s.item,this,s.children);n?this.parentWidget.addChild(n,this.getIndexInParent()+1):(this.parentWidget._removeAfter(this),this.parentWidget._onItemClick(null,this,s.item,s.children))}}else e&&this.parentWidget._removeAfter(this);this.containerNode.innerHTML="",this.containerNode.appendChild(this._menu.domNode),this.parentWidget.scrollIntoView(this),this._checkScrollConnection(!0),this.inherited(arguments),this._onMinWidthChange(this.minWidth)},_checkScrollConnection:function(e){var i=this.store;this._scrollConn&&this.disconnect(this._scrollConn),delete this._scrollConn,t.every(this.items,function(t){return i.isItemLoaded(t)})||(e&&this._loadVisibleItems(),this._scrollConn=this.connect(this.domNode,"onscroll","_onScrollPane"))},startup:function(){this.inherited(arguments),this.parentWidget._updateClass(this.domNode,"GroupPane")},focus:function(i){if(this._menu){this._pendingFocus&&this.disconnect(this._pendingFocus),delete this._pendingFocus;var s=this._menu.focusedChild;if(!s){var n=t.query(".dojoxRollingListItemSelected",this.domNode)[0];n&&(s=e.byNode(n))}if(s||(s=this._menu.getChildren()[0]||this._menu),this._focusByNode=!1,s.focusNode){if(!this.parentWidget._savedFocus||i)try{s.focusNode.focus()}catch(o){}window.setTimeout(function(){try{t.window.scrollIntoView(s.focusNode)}catch(e){}},1)}else s.focus?(!this.parentWidget._savedFocus||i)&&s.focus():this._focusByNode=!0;this.inherited(arguments)}else this._pendingFocus||(this._pendingFocus=this.connect(this,"onItems","focus"))},_getMenu:function(){var i=this,s=new e.Menu({parentMenu:this.parentPane?this.parentPane._menu:null,onCancel:function(t){i.parentPane&&i.parentPane.focus(!0)},_moveToPopup:function(t){this.focusedChild&&!this.focusedChild.disabled&&this.onItemClick(this.focusedChild,t)}},this.menuNode);return this.connect(s,"onItemClick",function(e,i){if(!e.disabled)if(i.alreadySelected=t.hasClass(e.domNode,"dojoxRollingListItemSelected"),i.alreadySelected&&("keypress"==i.type&&i.charOrCode!=t.keys.ENTER||"internal"==i.type)){var n=this.parentWidget.getChildren()[this.getIndexInParent()+1];n&&(n.focus(!0),this.parentWidget.scrollIntoView(n))}else this._setSelected(e,s),this.parentWidget._onItemClick(i,this,e.item,e.children),"keypress"==i.type&&i.charOrCode==t.keys.ENTER&&this.parentWidget._onExecute()}),s._started||s.startup(),s},_onScrollPane:function(){this._visibleLoadPending&&window.clearTimeout(this._visibleLoadPending),this._visibleLoadPending=window.setTimeout(t.hitch(this,"_loadVisibleItems"),500)},_loadVisibleItems:function(){delete this._visibleLoadPending;var e=this._menu;if(e){var i=e.getChildren();if(i&&i.length){var s=function(e,i,s){var n=t.getComputedStyle(e),o=0;return i&&(o+=t._getMarginExtents(e,n).t),s&&(o+=t._getPadBorderExtents(e,n).t),o},n=s(this.domNode,!1,!0)+s(this.containerNode,!0,!0)+s(e.domNode,!0,!0)+s(i[0].domNode,!0,!1),o=t.contentBox(this.domNode).h,h=this.domNode.scrollTop-n-o/2,d=h+3*o/2,r=t.filter(i,function(t){var e=t.domNode.offsetTop,i=t.store,s=t.item;return e>=h&&d>=e&&!i.isItemLoaded(s)}),a=t.map(r,function(t){return t.item}),l=t.hitch(this,function(){var i,s=this._getSelected();t.forEach(a,function(t,n){var o=this.parentWidget._getMenuItemForItem(t,this),h=r[n],d=h.getIndexInParent();e.removeChild(h),o&&(s&&this.parentWidget._itemsMatch(o.item,s.item)&&(i=o),e.addChild(o,d),e.focusedChild==h&&e.focusChild(o)),h.destroy()},this),this._checkScrollConnection(!1)});this._doLoadItems(a,l)}}},_getSelected:function(e){if(e||(e=this._menu),e)for(var i,s=this._menu.getChildren(),n=0;i=s[n];n++)if(t.hasClass(i.domNode,"dojoxRollingListItemSelected"))return i;return null},_setSelected:function(e,i){i||(i=this._menu),i&&t.forEach(i.getChildren(),function(t){this.parentWidget._updateClass(t.domNode,"Item",{Selected:e&&t==e&&!t.disabled})},this)}}),t.declare("dojox.widget.RollingList",[e._Widget,e._Templated,e._Container],{templateString:t.cache("dojox.widget","RollingList/RollingList.html",'<div class="dojoxRollingList ${className}"\n	><div class="dojoxRollingListContainer" dojoAttachPoint="containerNode" dojoAttachEvent="onkeypress:_onKey"\n	></div\n	><div class="dojoxRollingListButtons" dojoAttachPoint="buttonsNode"\n        ><button dojoType="dijit.form.Button" dojoAttachPoint="okButton"\n				dojoAttachEvent="onClick:_onExecute">${okButtonLabel}</button\n        ><button dojoType="dijit.form.Button" dojoAttachPoint="cancelButton"\n				dojoAttachEvent="onClick:_onCancel">${cancelButtonLabel}</button\n	></div\n></div>\n'),widgetsInTemplate:!0,className:"",store:null,query:null,queryOptions:null,childrenAttrs:["children"],parentAttr:"",value:null,executeOnDblClick:!0,preloadItems:!1,showButtons:!1,okButtonLabel:"",cancelButtonLabel:"",minPaneWidth:0,postMixInProperties:function(){this.inherited(arguments);var e=t.i18n.getLocalization("dijit","common");this.okButtonLabel=this.okButtonLabel||e.buttonOk,this.cancelButtonLabel=this.cancelButtonLabel||e.buttonCancel},_setShowButtonsAttr:function(e){var i=!1;(this.showButtons!=e&&this._started||this.showButtons==e&&!this.started)&&(i=!0),t.toggleClass(this.domNode,"dojoxRollingListButtonsHidden",!e),this.showButtons=e,i&&(this._started?this.layout():window.setTimeout(t.hitch(this,"layout"),0))},_itemsMatch:function(t,e){return t||e?t&&e?t==e||this._isIdentity&&this.store.getIdentity(t)==this.store.getIdentity(e):!1:!0},_removeAfter:function(e){"number"!=typeof e&&(e=this.getIndexOfChild(e)),e>=0&&t.forEach(this.getChildren(),function(t,i){i>e&&(this.removeChild(t),t.destroyRecursive())},this);for(var i=this.getChildren(),s=i[i.length-1],n=null;s&&!n;){var o=s._getSelected?s._getSelected():null;o&&(n=o.item),s=s.parentPane}this._setInProgress||this._setValue(n)},addChild:function(t,e){e>0&&this._removeAfter(e-1),this.inherited(arguments),t._started||t.startup(),t.attr("minWidth",this.minPaneWidth),this.layout(),this._savedFocus||t.focus()},_setMinPaneWidthAttr:function(e){e!==this.minPaneWidth&&(this.minPaneWidth=e,t.forEach(this.getChildren(),function(t){t.attr("minWidth",e)}))},_updateClass:function(e,i,s){this._declaredClasses||(this._declaredClasses=("dojoxRollingList "+this.className).split(" ")),t.forEach(this._declaredClasses,function(n){if(n){t.addClass(e,n+i);for(var o in s||{})t.toggleClass(e,n+i+o,s[o]);t.toggleClass(e,n+i+"FocusSelected",t.hasClass(e,n+i+"Focus")&&t.hasClass(e,n+i+"Selected")),t.toggleClass(e,n+i+"HoverSelected",t.hasClass(e,n+i+"Hover")&&t.hasClass(e,n+i+"Selected"))}})},scrollIntoView:function(e){this._scrollingTimeout&&window.clearTimeout(this._scrollingTimeout),delete this._scrollingTimeout,this._scrollingTimeout=window.setTimeout(t.hitch(this,function(){e.domNode&&t.window.scrollIntoView(e.domNode),delete this._scrollingTimeout}),1)},resize:function(t){e.layout._LayoutWidget.prototype.resize.call(this,t)},layout:function(){var e=this.getChildren();if(this._contentBox){var s=this.buttonsNode,n=this._contentBox.h-t.marginBox(s).h-i.html.metrics.getScrollbar().h;t.forEach(e,function(e){t.marginBox(e.domNode,{h:n})})}if(this._focusedPane){var o=this._focusedPane;delete this._focusedPane,this._savedFocus||o.focus()}else e&&e.length&&(this._savedFocus||e[0].focus())},_onChange:function(t){this.onChange(t)},_setValue:function(t){delete this._setInProgress,this._itemsMatch(this.value,t)||(this.value=t,this._onChange(t))},_setValueAttr:function(e){if((!this._itemsMatch(this.value,e)||e)&&(!this._setInProgress||this._setInProgress!==e)){if(this._setInProgress=e,!e||!this.store.isItem(e)){var i=this.getChildren()[0];return i._setSelected(null),void this._onItemClick(null,i,null,null)}var s=t.hitch(this,function(i,s){var n,o=this.store;if(this.parentAttr&&o.getFeatures()["dojo.data.api.Identity"]&&((n=this.store.getValue(i,this.parentAttr))||""===n)){var h=function(t){s(o.getIdentity(t)==o.getIdentity(i)?null:[t])};""===n?s(null):"string"==typeof n?o.fetchItemByIdentity({identity:n,onItem:h}):o.isItem(n)&&h(n)}else{var d=this.childrenAttrs.length,r=[];t.forEach(this.childrenAttrs,function(t){var n={};n[t]=i,o.fetch({query:n,scope:this,onComplete:function(t){this._setInProgress===e&&(r=r.concat(t),d--,0===d&&s(r))}})},this)}}),n=t.hitch(this,function(i,s){var o,h=i[s],d=this.getChildren()[s];if(h&&d){var r=t.hitch(this,function(){if(o&&this.disconnect(o),delete o,this._setInProgress===e){var r=t.filter(d._menu.getChildren(),function(t){return this._itemsMatch(t.item,h)},this)[0];r&&(s++,d._menu.onItemClick(r,{type:"internal",stopPropagation:function(){},preventDefault:function(){}}),i[s]?n(i,s):(this._setValue(h),this.onItemClick(h,d,this.getChildItems(h))))}});d.isLoaded?r():o=this.connect(d,"onLoad",r)}else 0===s&&this.set("value",null)}),o=[],h=t.hitch(this,function(t){t&&t.length?(o.push(t[0]),s(t[0],h)):(t||o.pop(),o.reverse(),n(o,0))}),d=this.domNode.style;"none"==d.display||"hidden"==d.visibility?this._setValue(e):this._itemsMatch(e,this._visibleItem)||h([e])}},_onItemClick:function(t,e,i,s){if(t){var n=this._getPaneForItem(i,e,s),o="click"==t.type&&t.alreadySelected;if(o&&n){this._removeAfter(e.getIndexInParent()+1);var h=e.getNextSibling();h&&h._setSelected&&h._setSelected(null),this.scrollIntoView(h)}else n?(this.addChild(n,e.getIndexInParent()+1),this._savedFocus&&n.focus(!0)):(this._removeAfter(e),this.scrollIntoView(e))}else e&&(this._removeAfter(e),this.scrollIntoView(e));t&&"internal"==t.type||(this._setValue(i),this.onItemClick(i,e,s)),this._visibleItem=i},_getPaneForItem:function(t,e,i){var s=this.getPaneForItem(t,e,i);return s.store=this.store,s.parentWidget=this,s.parentPane=e||null,t?i?s.items=i:s.items=[t]:(s.query=this.query,s.queryOptions=this.queryOptions),s},_getMenuItemForItem:function(i,s){var n=this.store;if(i&&n&&n.isItem(i)){var o,h=n.isItemLoaded(i),d=h?this.getChildItems(i):void 0;if(d)if(o=this.getMenuItemForItem(i,s,d),o.children=d,this._updateClass(o.domNode,"Item",{Expanding:!0}),o._started)t.style(o.arrowWrapper,"visibility","");else var r=o.connect(o,"startup",function(){this.disconnect(r),t.style(this.arrowWrapper,"visibility","")});else o=this.getMenuItemForItem(i,s,null),h?this._updateClass(o.domNode,"Item",{Single:!0}):(this._updateClass(o.domNode,"Item",{Unloaded:!0}),o.attr("disabled",!0));if(o.store=this.store,o.item=i,o.label||o.attr("label",this.store.getLabel(i).replace(/</,"&lt;")),o.focusNode){var a=this;o.focus=function(){if(!this.disabled)try{this.focusNode.focus()}catch(t){}},o.connect(o.focusNode,"onmouseenter",function(){this.disabled||a._updateClass(this.domNode,"Item",{Hover:!0})}),o.connect(o.focusNode,"onmouseleave",function(){this.disabled||a._updateClass(this.domNode,"Item",{Hover:!1})}),o.connect(o.focusNode,"blur",function(){a._updateClass(this.domNode,"Item",{Focus:!1,Hover:!1})}),o.connect(o.focusNode,"focus",function(){a._updateClass(this.domNode,"Item",{Focus:!0}),a._focusedPane=s}),this.executeOnDblClick&&o.connect(o.focusNode,"ondblclick",function(){a._onExecute()})}return o}var l=new e.MenuItem({label:"---",disabled:!0,iconClass:"dojoxEmpty",focus:function(){}});return this._updateClass(l.domNode,"Item"),l},_setStore:function(t){if(t!==this.store||!this._started){this.store=t,this._isIdentity=t.getFeatures()["dojo.data.api.Identity"];var e=this._getPaneForItem();this.addChild(e,0)}},_onKey:function(i){if(i.charOrCode==t.keys.BACKSPACE)return void t.stopEvent(i);if(i.charOrCode==t.keys.ESCAPE&&this._savedFocus){try{e.focus(this._savedFocus)}catch(i){}return void t.stopEvent(i)}return i.charOrCode==t.keys.LEFT_ARROW||i.charOrCode==t.keys.RIGHT_ARROW?void t.stopEvent(i):void 0},_resetValue:function(){this.set("value",this._lastExecutedValue)},_onCancel:function(){this._resetValue(),this.onCancel()},_onExecute:function(){this._lastExecutedValue=this.get("value"),this.onExecute()},focus:function(){var t=this._savedFocus;if(this._savedFocus=e.getFocus(this),this._savedFocus.node||delete this._savedFocus,this._focusedPane){this._savedFocus=e.getFocus(this);var i=this._focusedPane;delete this._focusedPane,t||i.focus(!0)}else{var s=this.getChildren()[0];s&&!t&&s.focus(!0)}},handleKey:function(e){return e.keyCode==t.keys.DOWN_ARROW?(delete this._savedFocus,this.focus(),!1):e.keyCode==t.keys.ESCAPE?(this._onCancel(),!1):!0},_updateChildClasses:function(){var e=this.getChildren(),i=e.length;t.forEach(e,function(e,s){t.toggleClass(e.domNode,"dojoxRollingListPaneCurrentChild",s==i-1),t.toggleClass(e.domNode,"dojoxRollingListPaneCurrentSelected",s==i-2)})},startup:function(){this._started||(this.getParent&&this.getParent()||(this.resize(),this.connect(t.global,"onresize","resize")),this.connect(this,"addChild","_updateChildClasses"),this.connect(this,"removeChild","_updateChildClasses"),this._setStore(this.store),this.set("showButtons",this.showButtons),this.inherited(arguments),this._lastExecutedValue=this.get("value"))},getChildItems:function(e){var i,s=this.store;return t.forEach(this.childrenAttrs,function(t){var n=s.getValues(e,t);n&&n.length&&(i=(i||[]).concat(n))}),i},getMenuItemForItem:function(t,i,s){return new e.MenuItem({})},getPaneForItem:function(t,e,s){return!t||s?new i.widget._RollingListGroupPane({}):null},onItemClick:function(t,e,i){},onExecute:function(){},onCancel:function(){},onChange:function(t){}})});
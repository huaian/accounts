define("dojox/drawing/tools/TextBlock",["dojo","dijit/registry","../util/oo","../manager/_registry","../stencil/Text"],function(t,e,i,o,n){var s;t.addOnLoad(function(){s=t.byId("conEdit"),s&&s.parentNode.removeChild(s)});var h=i.declare(n,function(e){if(e.data){var i=e.data,o=i.text?this.typesetter(i.text):i.text,n=i.width?"auto"==i.width?"auto":Math.max(i.width,this.style.text.minWidth):this.style.text.minWidth,s=this._lineHeight;if(o&&"auto"==n){var h=this.measureText(this.cleanText(o,!1),n);n=h.w,s=h.h}else this._text="";this.points=[{x:i.x,y:i.y},{x:i.x+n,y:i.y},{x:i.x+n,y:i.y+s},{x:i.x,y:i.y+s}],i.showEmpty||o?(this.editMode=!0,t.disconnect(this._postRenderCon),this._postRenderCon=null,this.connect(this,"render",this,"onRender",!0),i.showEmpty?(this._text=o||"",this.edit()):o&&i.editMode?(this._text="",this.edit()):o&&this.render(o),setTimeout(t.hitch(this,function(){this.editMode=!1}),100)):this.render()}else this.connectMouse(),this._postRenderCon=t.connect(this,"render",this,"_onPostRender")},{draws:!0,baseRender:!1,type:"dojox.drawing.tools.TextBlock",_caretStart:0,_caretEnd:0,_blockExec:!1,selectOnExec:!0,showEmpty:!1,onDrag:function(e){this.parentNode||this.showParent(e);var i=this._startdrag,o=e.page;this._box.left=i.x<o.x?i.x:o.x,this._box.top=i.y,this._box.width=(i.x<o.x?o.x-i.x:i.x-o.x)+this.style.text.pad,t.style(this.parentNode,this._box.toPx())},onUp:function(e){if(this._downOnCanvas){this._downOnCanvas=!1;var i=t.connect(this,"render",this,function(){t.disconnect(i),this.onRender(this)});this.editMode=!0,this.showParent(e),this.created=!0,this.createTextField(),this.connectTextField()}},showParent:function(e){if(!this.parentNode){var i=e.pageX||10,o=e.pageY||10;this.parentNode=t.doc.createElement("div"),this.parentNode.id=this.id;var n=this.style.textMode.create;this._box={left:i,top:o,width:e.width||1,height:e.height&&e.height>8?e.height:this._lineHeight,border:n.width+"px "+n.style+" "+n.color,position:"absolute",zIndex:500,toPx:function(){var t={};for(var e in this)t[e]="number"==typeof this[e]&&"zIndex"!=e?this[e]+"px":this[e];return t}},t.style(this.parentNode,this._box),document.body.appendChild(this.parentNode)}},createTextField:function(e){var i=this.style.textMode.edit;return this._box.border=i.width+"px "+i.style+" "+i.color,this._box.height="auto",this._box.width=Math.max(this._box.width,this.style.text.minWidth*this.mouse.zoom),t.style(this.parentNode,this._box.toPx()),this.parentNode.appendChild(s),t.style(s,{height:e?"auto":this._lineHeight+"px",fontSize:this.textSize/this.mouse.zoom+"px",fontFamily:this.style.text.family}),s.innerHTML=e||"",s},connectTextField:function(){if(!this._textConnected){var i=e.byId("greekPalette"),o=void 0==i?!1:!0;o&&t.mixin(i,{_pushChangeTo:s,_textBlock:this}),this._textConnected=!0,this._dropMode=!1,this.mouse.setEventMode("TEXT"),this.keys.editMode(!0);var n,h,r,a,c=this,d=!1,l=function(){c._dropMode||(t.forEach([n,h,r,a],function(e){t.disconnect(e)}),c._textConnected=!1,c.keys.editMode(!1),c.mouse.setEventMode(),c.execText())};n=t.connect(s,"keyup",this,function(e){t.trim(s.innerHTML)&&!d?(t.style(s,"height","auto"),d=!0):t.trim(s.innerHTML).length<2&&d&&(t.style(s,"height",this._lineHeight+"px"),d=!1),this._blockExec?e.keyCode==t.keys.SPACE&&(t.stopEvent(e),o&&i.onCancel()):(13==e.keyCode||27==e.keyCode)&&(t.stopEvent(e),l())}),h=t.connect(s,"keydown",this,function(e){if((13==e.keyCode||27==e.keyCode)&&t.stopEvent(e),220==e.keyCode){if(!o)return;t.stopEvent(e),this.getSelection(s),this.insertText(s,"\\"),this._dropMode=!0,this._blockExec=!0,i.show({around:this.parentNode,orient:{BL:"TL"}})}if(this._dropMode)switch(e.keyCode){case t.keys.UP_ARROW:case t.keys.DOWN_ARROW:case t.keys.LEFT_ARROW:case t.keys.RIGHT_ARROW:t.stopEvent(e),i._navigateByArrow(e);break;case t.keys.ENTER:t.stopEvent(e),i._onCellClick(e);break;case t.keys.BACKSPACE:case t.keys.DELETE:t.stopEvent(e),i.onCancel()}else this._blockExec=!1}),r=t.connect(document,"mouseup",this,function(e){this._onAnchor||"conEdit"==e.target.id?"conEdit"==e.target.id&&""==s.innerHTML&&(s.blur(),setTimeout(function(){s.focus()},200)):(t.stopEvent(e),l())}),this.createAnchors(),a=t.connect(this.mouse,"setZoom",this,function(t){l()}),s.focus(),this.onDown=function(){},this.onDrag=function(){},setTimeout(t.hitch(this,function(){s.focus(),this.onUp=function(){!c._onAnchor&&this.parentNode&&(c.disconnectMouse(),l(),c.onUp=function(){})}}),500)}},execText:function(){var e=t.marginBox(this.parentNode),i=Math.max(e.w,this.style.text.minWidth),o=this.cleanText(s.innerHTML,!0);s.innerHTML="",s.blur(),this.destroyAnchors(),o=this.typesetter(o);var n=this.measureText(o,i),h=this.mouse.scrollOffset(),r=this.mouse.origin,a=this._box.left+h.left-r.x,c=this._box.top+h.top-r.y;a*=this.mouse.zoom,c*=this.mouse.zoom,i*=this.mouse.zoom,n.h*=this.mouse.zoom,this.points=[{x:a,y:c},{x:a+i,y:c},{x:a+i,y:c+n.h},{x:a,y:c+n.h}],this.editMode=!1,n.text||(this._text="",this._textArray=[]),this.render(n.text),this.onChangeText(this.getText())},edit:function(){this.editMode=!0;var t=this.getText()||"";if(!this.parentNode&&this.points){var e=this.pointsToData(),i=this.mouse.scrollOffset(),o=this.mouse.origin,n={pageX:e.x/this.mouse.zoom-i.left+o.x,pageY:e.y/this.mouse.zoom-i.top+o.y,width:e.width/this.mouse.zoom,height:e.height/this.mouse.zoom};this.remove(this.shape,this.hit),this.showParent(n),this.createTextField(t.replace("/n"," ")),this.connectTextField(),t&&this.setSelection(s,"end")}},cleanText:function(e,i){var o=function(t){var e={"&lt;":"<","&gt;":">","&amp;":"&"};for(var i in e)t=t.replace(new RegExp(i,"gi"),e[i]);return t};return i&&t.forEach(["<br>","<br/>","<br />","\\n","\\r"],function(t){e=e.replace(new RegExp(t,"gi")," ")}),e=e.replace(/&nbsp;/g," "),e=o(e),e=t.trim(e),e=e.replace(/\s{2,}/g," ")},measureText:function(e,i){var o="(<br\\s*/*>)|(\\n)|(\\r)";this.showParent({width:i||"auto",height:"auto"}),this.createTextField(e);var n="",h=s;h.innerHTML="X";var r=t.marginBox(h).h;if(h.innerHTML=e,!i||new RegExp(o,"gi").test(e))n=e.replace(new RegExp(o,"gi"),"\n"),h.innerHTML=e.replace(new RegExp(o,"gi"),"<br/>");else if(t.marginBox(h).h==r)n=e;else{var a=e.split(" "),c=[[]],d=0;for(h.innerHTML="";a.length;){var l=a.shift();h.innerHTML+=l+" ",t.marginBox(h).h>r&&(d++,c[d]=[],h.innerHTML=l+" "),c[d].push(l)}t.forEach(c,function(t,e){c[e]=t.join(" ")}),n=c.join("\n"),h.innerHTML=n.replace("\n","<br/>")}var x=t.marginBox(h);return s.parentNode.removeChild(s),t.destroy(this.parentNode),this.parentNode=null,{h:x.h,w:x.w,text:n}},_downOnCanvas:!1,onDown:function(e){this._startdrag={x:e.pageX,y:e.pageY},t.disconnect(this._postRenderCon),this._postRenderCon=null,this._downOnCanvas=!0},createAnchors:function(){this._anchors={};var e=this,i=this.style.anchors,o=i.width,n=i.size-2*o,h=i.size-2*o,r=i.size/2*-1+"px",a={position:"absolute",width:n+"px",height:h+"px",backgroundColor:i.fill,border:o+"px "+i.style+" "+i.color};t.isIE&&(a.paddingLeft=n+"px",a.fontSize=n+"px");for(var c=[{top:r,left:r},{top:r,right:r},{bottom:r,right:r},{bottom:r,left:r}],d=0;4>d;d++){var l=0==d||3==d,x=this.util.uid(l?"left_anchor":"right_anchor"),p=t.create("div",{id:x},this.parentNode);t.style(p,t.mixin(t.clone(a),c[d]));var u,g,f,u=t.connect(p,"mousedown",this,function(i){l=i.target.id.indexOf("left")>-1,e._onAnchor=!0;var o=i.pageX,n=this._box.width;t.stopEvent(i),g=t.connect(document,"mousemove",this,function(e){var i=e.pageX;l?(this._box.left=i,this._box.width=n+o-i):this._box.width=i+n-o,t.style(this.parentNode,this._box.toPx())}),f=t.connect(document,"mouseup",this,function(i){o=this._box.left,n=this._box.width,t.disconnect(g),t.disconnect(f),e._onAnchor=!1,s.focus(),t.stopEvent(i)})});this._anchors[x]={a:p,cons:[u]}}},destroyAnchors:function(){for(var e in this._anchors)t.forEach(this._anchors[e].con,t.disconnect,t),t.destroy(this._anchors[e].a)},setSavedCaret:function(t){this._caretStart=this._caretEnd=t},getSavedCaret:function(){return{start:this._caretStart,end:this._caretEnd}},insertText:function(t,e){var i,o=t.innerHTML,n=this.getSavedCaret();o=o.replace(/&nbsp;/g," "),i=o.substr(0,n.start)+e+o.substr(n.end),i=this.cleanText(i,!0),this.setSavedCaret(Math.min(i.length,n.end+e.length)),t.innerHTML=i,this.setSelection(t,"stored")},getSelection:function(e){var i,o;if(t.doc.selection){var n=t.doc.selection.createRange(),s=t.body().createTextRange();s.moveToElementText(e);var h=s.duplicate();s.moveToBookmark(n.getBookmark()),h.setEndPoint("EndToStart",s),i=this._caretStart=h.text.length,o=this._caretEnd=h.text.length+n.text.length}else this._caretStart=t.global.getSelection().getRangeAt(e).startOffset,this._caretEnd=t.global.getSelection().getRangeAt(e).endOffset},setSelection:function(e,i){if(t.doc.selection){var o=t.body().createTextRange();switch(o.moveToElementText(e),i){case"end":o.collapse(!1);break;case"beg":o.collapse();break;case"all":o.collapse(),o.moveStart("character",0),o.moveEnd("character",e.text.length);break;case"stored":o.collapse();var n=this._caretStart-this._caretEnd;o.moveStart("character",this._caretStart),o.moveEnd("character",n)}o.select()}else{var s=function(t,e){e=e||[];for(var i=0;i<t.childNodes.length;i++){var o=t.childNodes[i];3==o.nodeType?e.push(o):o.tagName&&"img"==o.tagName.toLowerCase()&&e.push(o),o.childNodes&&o.childNodes.length&&s(o,e)}return e};e.focus();var h=t.global.getSelection();h.removeAllRanges();var r=t.doc.createRange(),a=s(e);switch(i){case"end":r.setStart(a[a.length-1],a[a.length-1].textContent.length),r.setEnd(a[a.length-1],a[a.length-1].textContent.length);break;case"beg":r.setStart(a[0],0),r.setEnd(a[0],0);break;case"all":r.setStart(a[0],0),r.setEnd(a[a.length-1],a[a.length-1].textContent.length);break;case"stored":r.setStart(a[0],this._caretStart),r.setEnd(a[0],this._caretEnd)}h.addRange(r)}}});return t.setObject("dojox.drawing.tools.TextBlock",h),h.setup={name:"dojox.drawing.tools.TextBlock",tooltip:"Text Tool",iconClass:"iconText"},o.register(h.setup,"tool"),h});
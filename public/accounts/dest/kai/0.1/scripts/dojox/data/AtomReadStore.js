define("dojox/data/AtomReadStore",["dojo","dojox","dojo/data/util/filter","dojo/data/util/simpleFetch","dojo/date/stamp"],function(t,e){t.experimental("dojox.data.AtomReadStore");var r=t.declare("dojox.data.AtomReadStore",null,{constructor:function(t){if(t&&(this.url=t.url,this.rewriteUrl=t.rewriteUrl,this.label=t.label||this.label,this.sendQuery=t.sendQuery||t.sendquery||this.sendQuery,this.unescapeHTML=t.unescapeHTML,"urlPreventCache"in t&&(this.urlPreventCache=t.urlPreventCache?!0:!1)),!this.url)throw new Error("AtomReadStore: a URL must be specified when creating the data store")},url:"",label:"title",sendQuery:!1,unescapeHTML:!1,urlPreventCache:!1,getValue:function(e,r,i){this._assertIsItem(e),this._assertIsAttribute(r),this._initItem(e),r=r.toLowerCase(),e._attribs[r]||e._parsed||(this._parseItem(e),e._parsed=!0);var a=e._attribs[r];if(!a&&"summary"==r){var s=this.getValue(e,"content"),n=new RegExp("/(<([^>]+)>)/g","i"),u=s.text.replace(n,"");a={text:u.substring(0,Math.min(400,u.length)),type:"text"},e._attribs[r]=a}return a&&this.unescapeHTML&&("content"!=r&&"summary"!=r&&"subtitle"!=r||e["_"+r+"Escaped"]||(a.text=this._unescapeHTML(a.text),e["_"+r+"Escaped"]=!0)),a?t.isArray(a)?a[0]:a:i},getValues:function(t,e){this._assertIsItem(t),this._assertIsAttribute(e),this._initItem(t),e=e.toLowerCase(),t._attribs[e]||this._parseItem(t);var r=t._attribs[e];return r?void 0!==r.length&&"string"!=typeof r?r:[r]:void 0},getAttributes:function(t){this._assertIsItem(t),t._attribs||(this._initItem(t),this._parseItem(t));var e=[];for(var r in t._attribs)e.push(r);return e},hasAttribute:function(t,e){return void 0!==this.getValue(t,e)},containsValue:function(t,e,r){for(var i=this.getValues(t,e),a=0;a<i.length;a++)if("string"==typeof r){if(i[a].toString&&i[a].toString()===r)return!0}else if(i[a]===r)return!0;return!1},isItem:function(t){return t&&t.element&&t.store&&t.store===this?!0:!1},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(t){},getFeatures:function(){var t={"dojo.data.api.Read":!0};return t},getLabel:function(t){if(""!==this.label&&this.isItem(t)){var e=this.getValue(t,this.label);return e&&e.text?e.text:e?e.toString():void 0}},getLabelAttributes:function(t){return""!==this.label?[this.label]:null},getFeedValue:function(e,r){var i=this.getFeedValues(e,r);return t.isArray(i)?i[0]:i},getFeedValues:function(t,e){return this.doc?(this._feedMetaData||(this._feedMetaData={element:this.doc.getElementsByTagName("feed")[0],store:this,_attribs:{}},this._parseItem(this._feedMetaData)),this._feedMetaData._attribs[t]||e):e},_initItem:function(t){t._attribs||(t._attribs={})},_fetchItems:function(e,r,i){var a=this._getFetchUrl(e);if(!a)return void i(new Error("No URL specified."));var s=this.sendQuery?null:e,n=this,u=function(i){n.doc=i;var a=n._getItems(i,s),u=e.query;u&&(u.id?a=t.filter(a,function(t){return n.getValue(t,"id")==u.id}):u.category&&(a=t.filter(a,function(e){var r=n.getValues(e,"category");return r?t.some(r,"return item.term=='"+u.category+"'"):!1}))),a&&a.length>0?r(a,e):r([],e)};if(this.doc)u(this.doc);else{var o={url:a,handleAs:"xml",preventCache:this.urlPreventCache},l=t.xhrGet(o);l.addCallback(u),l.addErrback(function(t){i(t,e)})}},_getFetchUrl:function(e){if(!this.sendQuery)return this.url;var r=e.query;if(!r)return this.url;if(t.isString(r))return this.url+r;var i="";for(var a in r){var s=r[a];s&&(i&&(i+="&"),i+=a+"="+s)}if(!i)return this.url;var n=this.url;return n+=n.indexOf("?")<0?"?":"&",n+i},_getItems:function(e,r){if(this._items)return this._items;var i=[],a=[];if(e.childNodes.length<1)return this._items=i,i;var s=t.filter(e.childNodes,"return item.tagName && item.tagName.toLowerCase() == 'feed'");r.query;if(!s||1!=s.length)return i;a=t.filter(s[0].childNodes,"return item.tagName && item.tagName.toLowerCase() == 'entry'"),r.onBegin&&r.onBegin(a.length,this.sendQuery?r:{});for(var n=0;n<a.length;n++){var u=a[n];1==u.nodeType&&i.push(this._getItem(u))}return this._items=i,i},close:function(t){},_getItem:function(t){return{element:t,store:this}},_parseItem:function(e){function r(t){var e=t.textContent||t.innerHTML||t.innerXML;if(!e&&t.childNodes[0]){var r=t.childNodes[0];!r||3!=r.nodeType&&4!=r.nodeType||(e=t.childNodes[0].nodeValue)}return e}function i(t){return{text:r(t),type:t.getAttribute("type")}}var a=e._attribs;t.forEach(e.element.childNodes,function(e){var s=e.tagName?e.tagName.toLowerCase():"";switch(s){case"title":a[s]={text:r(e),type:e.getAttribute("type")};break;case"subtitle":case"summary":case"content":a[s]=i(e);break;case"author":var n,u;t.forEach(e.childNodes,function(t){if(t.tagName)switch(t.tagName.toLowerCase()){case"name":n=t;break;case"uri":u=t}});var o={};n&&1==n.length&&(o.name=r(n[0])),u&&1==u.length&&(o.uri=r(u[0])),a[s]=o;break;case"id":a[s]=r(e);break;case"updated":a[s]=t.date.stamp.fromISOString(r(e));break;case"published":a[s]=t.date.stamp.fromISOString(r(e));break;case"category":a[s]||(a[s]=[]),a[s].push({scheme:e.getAttribute("scheme"),term:e.getAttribute("term")});break;case"link":a[s]||(a[s]=[]);var l={rel:e.getAttribute("rel"),href:e.getAttribute("href"),type:e.getAttribute("type")};a[s].push(l),"alternate"==l.rel&&(a.alternate=l)}})},_unescapeHTML:function(t){return t=t.replace(/&#8217;/m,"'").replace(/&#8243;/m,'"').replace(/&#60;/m,">").replace(/&#62;/m,"<").replace(/&#38;/m,"&")},_assertIsItem:function(t){if(!this.isItem(t))throw new Error("dojox.data.AtomReadStore: Invalid item argument.")},_assertIsAttribute:function(t){if("string"!=typeof t)throw new Error("dojox.data.AtomReadStore: Invalid attribute argument.")}});return t.extend(r,t.data.util.simpleFetch),r});
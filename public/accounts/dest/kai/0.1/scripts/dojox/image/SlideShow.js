//
// dojox.image.SlideShow courtesy Shane O Sullivan, licensed under a Dojo CLA
// For a sample usage, see http://www.skynet.ie/~sos/photos.php
//
//
//	TODO: more cleanups
//

define("dojox/image/SlideShow",["dojo","dijit","dojox","dojo/require!dojo/string,dojo/fx,dijit/_Widget,dijit/_Templated"],function(t,i,e){t.provide("dojox.image.SlideShow"),t.require("dojo.string"),t.require("dojo.fx"),t.require("dijit._Widget"),t.require("dijit._Templated"),t.declare("dojox.image.SlideShow",[i._Widget,i._Templated],{imageHeight:375,imageWidth:500,title:"",titleTemplate:'${title} <span class="slideShowCounterText">(${current} of ${total})</span>',noLink:!1,loop:!0,hasNav:!0,images:[],pageSize:20,autoLoad:!0,autoStart:!1,fixedHeight:!1,imageStore:null,linkAttr:"link",imageLargeAttr:"imageUrl",titleAttr:"title",slideshowInterval:3,templateString:t.cache("dojox.image","resources/SlideShow.html",'<div dojoAttachPoint="outerNode" class="slideShowWrapper">\n	<div style="position:relative;" dojoAttachPoint="innerWrapper">\n		<div class="slideShowNav" dojoAttachEvent="onclick: _handleClick">\n			<div class="dijitInline slideShowTitle" dojoAttachPoint="titleNode">${title}</div>\n		</div>\n		<div dojoAttachPoint="navNode" class="slideShowCtrl" dojoAttachEvent="onclick: _handleClick">\n			<span dojoAttachPoint="navPrev" class="slideShowCtrlPrev"></span>\n			<span dojoAttachPoint="navPlay" class="slideShowCtrlPlay"></span>\n			<span dojoAttachPoint="navNext" class="slideShowCtrlNext"></span>\n		</div>\n		<div dojoAttachPoint="largeNode" class="slideShowImageWrapper"></div>		\n		<div dojoAttachPoint="hiddenNode" class="slideShowHidden"></div>\n	</div>\n</div>'),_imageCounter:0,_tmpImage:null,_request:null,postCreate:function(){this.inherited(arguments);var i=document.createElement("img");i.setAttribute("width",this.imageWidth),i.setAttribute("height",this.imageHeight),this.hasNav&&(t.connect(this.outerNode,"onmouseover",this,function(t){try{this._showNav()}catch(i){}}),t.connect(this.outerNode,"onmouseout",this,function(t){try{this._hideNav(t)}catch(i){}})),this.outerNode.style.width=this.imageWidth+"px",i.setAttribute("src",this._blankGif);this.largeNode.appendChild(i),this._tmpImage=this._currentImage=i,this._fitSize(!0),this._loadImage(0,t.hitch(this,"showImage",0)),this._calcNavDimensions(),t.style(this.navNode,"opacity",0)},setDataStore:function(i,e,s){this.reset();var a=this;this._request={query:{},start:e.start||0,count:e.count||this.pageSize,onBegin:function(t,i){a.maxPhotos=t}},e.query&&t.mixin(this._request.query,e.query),s&&t.forEach(["imageLargeAttr","linkAttr","titleAttr"],function(t){s[t]&&(this[t]=s[t])},this);var n=function(t){a.maxPhotos=t.length,a._request.onComplete=null,a.autoStart?(a.imageIndex=-1,a.toggleSlideShow()):a.showImage(0)};this.imageStore=i,this._request.onComplete=n,this._request.start=0,this.imageStore.fetch(this._request)},reset:function(){t.query("> *",this.largeNode).orphan(),this.largeNode.appendChild(this._tmpImage),t.query("> *",this.hiddenNode).orphan(),t.forEach(this.images,function(t){t&&t.parentNode&&t.parentNode.removeChild(t)}),this.images=[],this.isInitialized=!1,this._imageCounter=0},isImageLoaded:function(t){return this.images&&this.images.length>t&&this.images[t]},moveImageLoadingPointer:function(t){this._imageCounter=t},destroy:function(){this._slideId&&this._stop(),this.inherited(arguments)},showNextImage:function(i,e){if(i&&this._timerCancelled)return!1;if(this.imageIndex+1>=this.maxPhotos){if(!i||!this.loop&&!e)return this._slideId&&this._stop(),!1;this.imageIndex=-1}return this.showImage(this.imageIndex+1,t.hitch(this,function(){i&&this._startTimer()})),!0},toggleSlideShow:function(){if(this._slideId)this._stop();else{t.toggleClass(this.domNode,"slideShowPaused"),this._timerCancelled=!1;var i=this.imageIndex;if(0>i||this.images[i]&&this.images[i]._img.complete){var e=this.showNextImage(!0,!0);e||this._stop()}else{var s=t.subscribe(this.getShowTopicName(),t.hitch(this,function(e){setTimeout(t.hitch(this,function(){if(e.index==i){var a=this.showNextImage(!0,!0);a||this._stop(),t.unsubscribe(s)}}),1e3*this.slideshowInterval)}));t.publish(this.getShowTopicName(),[{index:i,title:"",url:""}])}}},getShowTopicName:function(){return(this.widgetId||this.id)+"/imageShow"},getLoadTopicName:function(){return(this.widgetId?this.widgetId:this.id)+"/imageLoad"},showImage:function(i,e){!e&&this._slideId&&this.toggleSlideShow();var s=this,a=this.largeNode.getElementsByTagName("div");this.imageIndex=i;var n=function(){if(s.images[i]){for(;s.largeNode.firstChild;)s.largeNode.removeChild(s.largeNode.firstChild);t.style(s.images[i],"opacity",0),s.largeNode.appendChild(s.images[i]),s._currentImage=s.images[i]._img,s._fitSize();var a=function(a,n,o){var h=s.images[i].firstChild;"img"!=h.tagName.toLowerCase()&&(h=h.firstChild);var d=h.getAttribute("title")||"";s._navShowing&&s._showNav(!0),t.publish(s.getShowTopicName(),[{index:i,title:d,url:h.getAttribute("src")}]),e&&e(a,n,o),s._setTitle(d)};t.fadeIn({node:s.images[i],duration:300,onEnd:a}).play()}else s._loadImage(i,function(){s.showImage(i,e)})};a&&a.length>0?t.fadeOut({node:a[0],duration:300,onEnd:function(){s.hiddenNode.appendChild(a[0]),n()}}).play():n()},_fitSize:function(i){if(!this.fixedHeight||i){var e=this._currentImage.height+(this.hasNav?20:0);return void t.style(this.innerWrapper,"height",e+"px")}t.style(this.largeNode,"paddingTop",this._getTopPadding()+"px")},_getTopPadding:function(){return this.fixedHeight?(this.imageHeight-this._currentImage.height)/2:0},_loadNextImage:function(){if(this.autoLoad){for(;this.images.length>=this._imageCounter&&this.images[this._imageCounter];)this._imageCounter++;this._loadImage(this._imageCounter)}},_loadImage:function(i,e){if(!this.images[i]&&this._request){var s=i-i%(this._request.count||this.pageSize);this._request.start=s,this._request.onComplete=function(t){var e=i-s;t&&t.length>e&&o(t[e])};var a=this,n=this.imageStore,o=function(s){var o=a.imageStore.getValue(s,a.imageLargeAttr),h=new Image,d=t.create("div",{id:a.id+"_imageDiv"+i});d._img=h;var r=a.imageStore.getValue(s,a.linkAttr);if(!r||a.noLink)d.appendChild(h);else{var l=t.create("a",{href:r,target:"_blank"},d);l.appendChild(h)}t.connect(h,"onload",function(){n==a.imageStore&&(a._fitImage(h),t.attr(d,{width:a.imageWidth,height:a.imageHeight}),t.publish(a.getLoadTopicName(),[i]),setTimeout(function(){a._loadNextImage()},1),e&&e())}),a.hiddenNode.appendChild(d);t.create("div",{className:"slideShowTitle"},d);a.images[i]=d,t.attr(h,"src",o);var g=a.imageStore.getValue(s,a.titleAttr);g&&t.attr(h,"title",g)};this.imageStore.fetch(this._request)}},_stop:function(){this._slideId&&clearTimeout(this._slideId),this._slideId=null,this._timerCancelled=!0,t.removeClass(this.domNode,"slideShowPaused")},_prev:function(){this.imageIndex<1||this.showImage(this.imageIndex-1)},_next:function(){this.showNextImage()},_startTimer:function(){var t=this.id;this._slideId=setTimeout(function(){i.byId(t).showNextImage(!0)},1e3*this.slideshowInterval)},_calcNavDimensions:function(){t.style(this.navNode,"position","absolute"),t.style(this.navNode,"top","-10000px"),t.style(this.navPlay,"marginLeft",0),this.navPlay._size=t.marginBox(this.navPlay),this.navPrev._size=t.marginBox(this.navPrev),this.navNext._size=t.marginBox(this.navNext),t.style(this.navNode,{position:"",top:""})},_setTitle:function(i){this.titleNode.innerHTML=t.string.substitute(this.titleTemplate,{title:i,current:1+this.imageIndex,total:this.maxPhotos||""})},_fitImage:function(t){var i=t.width,e=t.height;i>this.imageWidth&&(e=Math.floor(e*(this.imageWidth/i)),t.height=e,t.width=i=this.imageWidth),e>this.imageHeight&&(i=Math.floor(i*(this.imageHeight/e)),t.height=this.imageHeight,t.width=i)},_handleClick:function(t){switch(t.target){case this.navNext:this._next();break;case this.navPrev:this._prev();break;case this.navPlay:this.toggleSlideShow()}},_showNav:function(i){if(!this._navShowing||i){this._calcNavDimensions(),t.style(this.navNode,"marginTop","0px");var e=t.style(this.navNode,"width")/2-this.navPlay._size.w/2-this.navPrev._size.w;t.style(this.navPlay,"marginLeft",e+"px");var s=(t.marginBox(this.outerNode),this._currentImage.height-this.navPlay._size.h-10+this._getTopPadding());s>this._currentImage.height&&(s+=10),t[this.imageIndex<1?"addClass":"removeClass"](this.navPrev,"slideShowCtrlHide"),t[this.imageIndex+1>=this.maxPhotos?"addClass":"removeClass"](this.navNext,"slideShowCtrlHide");var a=this;this._navAnim&&this._navAnim.stop(),this._navShowing||(this._navAnim=t.fadeIn({node:this.navNode,duration:300,onEnd:function(){a._navAnim=null}}),this._navAnim.play(),this._navShowing=!0)}},_hideNav:function(i){if(!i||!this._overElement(this.outerNode,i)){var e=this;this._navAnim&&this._navAnim.stop(),this._navAnim=t.fadeOut({node:this.navNode,duration:300,onEnd:function(){e._navAnim=null}}),this._navAnim.play(),this._navShowing=!1}},_overElement:function(i,e){if("undefined"==typeof t)return!1;i=t.byId(i);var s={x:e.pageX,y:e.pageY},a=t.position(i,!0);return s.x>=a.x&&s.x<=a.x+a.w&&s.y>=a.y&&s.y<=top+a.h}})});
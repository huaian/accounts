//
// dojox.image.ThumbnailPicker courtesy Shane O Sullivan, licensed under a Dojo CLA
//
// For a sample usage, see http://www.skynet.ie/~sos/photos.php
//
//	document topics.

define("dojox/image/ThumbnailPicker",["dojo","dijit","dojox","dojo/require!dojox/fx/scroll,dojo/fx/easing,dojo/fx,dijit/_Widget,dijit/_Templated"],function(t,i,s){t.provide("dojox.image.ThumbnailPicker"),t.experimental("dojox.image.ThumbnailPicker"),t.require("dojox.fx.scroll"),t.require("dojo.fx.easing"),t.require("dojo.fx"),t.require("dijit._Widget"),t.require("dijit._Templated"),t.declare("dojox.image.ThumbnailPicker",[i._Widget,i._Templated],{imageStore:null,request:null,size:500,thumbHeight:75,thumbWidth:100,useLoadNotifier:!1,useHyperlink:!1,hyperlinkTarget:"new",isClickable:!0,isScrollable:!0,isHorizontal:!0,autoLoad:!0,linkAttr:"link",imageThumbAttr:"imageUrlThumb",imageLargeAttr:"imageUrl",pageSize:20,titleAttr:"title",templateString:t.cache("dojox.image","resources/ThumbnailPicker.html",'<div dojoAttachPoint="outerNode" class="thumbOuter">\n	<div dojoAttachPoint="navPrev" class="thumbNav thumbClickable">\n	  <img src="" dojoAttachPoint="navPrevImg"/>    \n	</div>\n	<div dojoAttachPoint="thumbScroller" class="thumbScroller">\n	  <div dojoAttachPoint="thumbsNode" class="thumbWrapper"></div>\n	</div>\n	<div dojoAttachPoint="navNext" class="thumbNav thumbClickable">\n	  <img src="" dojoAttachPoint="navNextImg"/>  \n	</div>\n</div>'),_thumbs:[],_thumbIndex:0,_maxPhotos:0,_loadedImages:{},baseClass:"ThumbnailPicker",cellClass:"Thumbnail",postCreate:function(){this.inherited(arguments),this.pageSize=Number(this.pageSize),this._scrollerSize=this.size-102;var i=this._sizeProperty=this.isHorizontal?"width":"height";t.style(this.outerNode,"textAlign","center"),t.style(this.outerNode,i,this.size+"px"),t.style(this.thumbScroller,i,this._scrollerSize+"px"),this.useHyperlink&&t.subscribe(this.getClickTopicName(),this,function(t){var i=(t.index,this.imageStore.getValue(t.data,this.linkAttr));i&&("new"==this.hyperlinkTarget?window.open(i):window.location=i)}),this.isClickable&&t.addClass(this.thumbsNode,"thumbClickable"),this._totalSize=0;var s=this.isHorizontal?"Horiz":"Vert";t.addClass(this.navPrev,"prev"+s),t.addClass(this.navNext,"next"+s),t.addClass(this.thumbsNode,"thumb"+s),t.addClass(this.outerNode,"thumb"+s),t.attr(this.navNextImg,"src",this._blankGif),t.attr(this.navPrevImg,"src",this._blankGif),this.connect(this.navPrev,"onclick","_prev"),this.connect(this.navNext,"onclick","_next"),this.isHorizontal?(this._sizeAttr="offsetWidth",this._scrollAttr="scrollLeft"):(this._sizeAttr="offsetHeight",this._scrollAttr="scrollTop"),this._updateNavControls(),this.init()},init:function(){return this.isInitialized?!1:(this.isInitialized=!0,this.imageStore&&this.request&&this._loadNextPage(),!0)},getClickTopicName:function(){return this.id+"/select"},getShowTopicName:function(){return this.id+"/show"},setDataStore:function(i,s,e){this.reset(),this.request={query:{},start:s.start||0,count:s.count||10,onBegin:t.hitch(this,function(t){this._maxPhotos=t})},s.query&&t.mixin(this.request.query,s.query),e&&t.forEach(["imageThumbAttr","imageLargeAttr","linkAttr","titleAttr"],function(t){e[t]&&(this[t]=e[t])},this),this.request.start=0,this.request.count=this.pageSize,this.imageStore=i,this._loadInProgress=!1,this.init()||this._loadNextPage()},reset:function(){this._loadedImages={},t.forEach(this._thumbs,function(i){i&&i.parentNode&&t.destroy(i)}),this._thumbs=[],this.isInitialized=!1,this._noImages=!0},isVisible:function(t){var i=this._thumbs[t];if(!i)return!1;var s=this.isHorizontal?"offsetLeft":"offsetTop",e=this.isHorizontal?"offsetWidth":"offsetHeight",h=this.isHorizontal?"scrollLeft":"scrollTop",o=i[s]-this.thumbsNode[s];return o>=this.thumbScroller[h]&&o+i[e]<=this.thumbScroller[h]+this._scrollerSize},resize:function(i){var s=this.isHorizontal?"w":"h",e=0;this._thumbs.length>0&&0==t.marginBox(this._thumbs[0]).w||(t.forEach(this._thumbs,t.hitch(this,function(i){var h=t.marginBox(i.firstChild),o=h[s];e+=Number(o)+10,this.useLoadNotifier&&h.w>0&&t.style(i.lastChild,"width",h.w-4+"px"),t.style(i,"width",h.w+"px")})),t.style(this.thumbsNode,this._sizeProperty,e+"px"),this._updateNavControls())},_next:function(){for(var t,i=this.isHorizontal?"offsetLeft":"offsetTop",s=this.isHorizontal?"offsetWidth":"offsetHeight",e=this.thumbsNode[i],h=this._thumbs[this._thumbIndex],o=h[i]-e,r=this._thumbIndex+1;r<this._thumbs.length;r++)if(t=this._thumbs[r],t[i]-e+t[s]-o>this._scrollerSize)return void this._showThumbs(r)},_prev:function(){if(0!=this.thumbScroller[this.isHorizontal?"scrollLeft":"scrollTop"]){for(var t,i=this.isHorizontal?"offsetLeft":"offsetTop",s=(this.isHorizontal?"offsetWidth":"offsetHeight",this._thumbs[this._thumbIndex]),e=s[i]-this.thumbsNode[i],h=this._thumbIndex-1;h>-1;h--)if(t=this._thumbs[h],e-t[i]>this._scrollerSize)return void this._showThumbs(h+1);this._showThumbs(0)}},_checkLoad:function(i,s){t.publish(this.getShowTopicName(),[{index:s}]),this._updateNavControls(),this._loadingImages={},this._thumbIndex=s,this.thumbsNode.offsetWidth-i.offsetLeft<2*this._scrollerSize&&this._loadNextPage()},_showThumbs:function(i){if(i=Math.min(Math.max(i,0),this._maxPhotos),!(i>=this._maxPhotos)){var e=this._thumbs[i];if(e){var h=e.offsetLeft-this.thumbsNode.offsetLeft,o=e.offsetTop-this.thumbsNode.offsetTop,r=this.isHorizontal?h:o;if(!(r>=this.thumbScroller[this._scrollAttr]&&r+e[this._sizeAttr]<=this.thumbScroller[this._scrollAttr]+this._scrollerSize))if(this.isScrollable){var a=this.isHorizontal?{x:h,y:0}:{x:0,y:o};s.fx.smoothScroll({target:a,win:this.thumbScroller,duration:300,easing:t.fx.easing.easeOut,onEnd:t.hitch(this,"_checkLoad",e,i)}).play(10)}else this.isHorizontal?this.thumbScroller.scrollLeft=h:this.thumbScroller.scrollTop=o,this._checkLoad(e,i)}}},markImageLoaded:function(i){var s=t.byId("loadingDiv_"+this.id+"_"+i);s&&this._setThumbClass(s,"thumbLoaded"),this._loadedImages[i]=!0},_setThumbClass:function(i,s){this.autoLoad&&t.addClass(i,s)},_loadNextPage:function(){if(!this._loadInProgress){this._loadInProgress=!0;for(var i=this.request.start+(this._noImages?0:this.pageSize),s=i;s<this._thumbs.length&&this._thumbs[s];)s++;var e=this.imageStore,h=function(i,h){if(e==this.imageStore)if(i&&i.length){var o=0,r=t.hitch(this,function(){if(o>=i.length)return void(this._loadInProgress=!1);var t=o++;this._loadImage(i[t],s+t,r)});r(),this._updateNavControls()}else this._loadInProgress=!1},o=function(){this._loadInProgress=!1};this.request.onComplete=t.hitch(this,h),this.request.onError=t.hitch(this,o),this.request.start=i,this._noImages=!1,this.imageStore.fetch(this.request)}},_loadImage:function(i,s,e){var h=this.imageStore,o=h.getValue(i,this.imageThumbAttr),r=t.create("div",{id:"img_"+this.id+"_"+s,"class":this.cellClass}),a=t.create("img",{},r);a._index=s,a._data=i,this._thumbs[s]=r;var l;this.useLoadNotifier&&(l=t.create("div",{id:"loadingDiv_"+this.id+"_"+s},r),this._setThumbClass(l,this._loadedImages[s]?"thumbLoaded":"thumbNotifier"));var n,u,d=t.marginBox(this.thumbsNode);this.isHorizontal?(n=this.thumbWidth,u="w"):(n=this.thumbHeight,u="h"),d=d[u];var c=this.thumbScroller.scrollLeft,m=this.thumbScroller.scrollTop;t.style(this.thumbsNode,this._sizeProperty,d+n+20+"px"),this.thumbScroller.scrollLeft=c,this.thumbScroller.scrollTop=m,this.thumbsNode.appendChild(r),t.connect(a,"onload",this,t.hitch(this,function(){return h!=this.imageStore?!1:(this.resize(),setTimeout(e,0),!1)})),t.connect(a,"onclick",this,function(s){return t.publish(this.getClickTopicName(),[{index:s.target._index,data:s.target._data,url:a.getAttribute("src"),largeUrl:this.imageStore.getValue(i,this.imageLargeAttr),title:this.imageStore.getValue(i,this.titleAttr),link:this.imageStore.getValue(i,this.linkAttr)}]),t.query("."+this.cellClass,this.thumbsNode).removeClass(this.cellClass+"Selected"),t.addClass(s.target.parentNode,this.cellClass+"Selected"),!1}),t.addClass(a,"imageGalleryThumb"),a.setAttribute("src",o);var f=this.imageStore.getValue(i,this.titleAttr);f&&a.setAttribute("title",f),this._updateNavControls()},_updateNavControls:function(){var i=function(i,s){var e=s?"addClass":"removeClass";t[e](i,"enabled"),t[e](i,"thumbClickable")},s=this.isHorizontal?"scrollLeft":"scrollTop",e=this.isHorizontal?"offsetWidth":"offsetHeight";i(this.navPrev,this.thumbScroller[s]>0);var h=this.thumbScroller[s]+this._scrollerSize<this.thumbsNode[e];i(this.navNext,h)}})});
define("dojox/storage/GearsStorageProvider",["dojo","dijit","dojox","dojo/require!dojo/gears,dojox/storage/Provider,dojox/storage/manager,dojox/sql"],function(e,t,i){e.provide("dojox.storage.GearsStorageProvider"),e.require("dojo.gears"),e.require("dojox.storage.Provider"),e.require("dojox.storage.manager"),e.require("dojox.sql"),e.gears.available&&!function(){e.declare("dojox.storage.GearsStorageProvider",i.storage.Provider,{constructor:function(){},TABLE_NAME:"__DOJO_STORAGE",initialized:!1,_available:null,_storageReady:!1,initialize:function(){1!=e.config.disableGearsStorage&&(this.TABLE_NAME="__DOJO_STORAGE",this.initialized=!0,i.storage.manager.loaded())},isAvailable:function(){return this._available=e.gears.available},put:function(t,r,s,a){if(this._initStorage(),!this.isValidKey(t))throw new Error("Invalid key given: "+t);if(a=a||this.DEFAULT_NAMESPACE,!this.isValidKey(a))throw new Error("Invalid namespace given: "+t);r=e.isString(r)?"string:"+r:e.toJson(r);try{i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",a,t),i.sql("INSERT INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)",a,t,r)}catch(n){return void s(this.FAILED,t,n.toString(),a)}s&&s(i.storage.SUCCESS,t,null,a)},get:function(t,r){if(this._initStorage(),!this.isValidKey(t))throw new Error("Invalid key given: "+t);if(r=r||this.DEFAULT_NAMESPACE,!this.isValidKey(r))throw new Error("Invalid namespace given: "+t);var s=i.sql("SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND  key = ?",r,t);return s.length?(s=s[0].value,s=e.isString(s)&&/^string:/.test(s)?s.substring("string:".length):e.fromJson(s)):null},getNamespaces:function(){this._initStorage();for(var e=[i.storage.DEFAULT_NAMESPACE],t=i.sql("SELECT namespace FROM "+this.TABLE_NAME+" DESC GROUP BY namespace"),r=0;r<t.length;r++)t[r].namespace!=i.storage.DEFAULT_NAMESPACE&&e.push(t[r].namespace);return e},getKeys:function(e){if(this._initStorage(),e=e||this.DEFAULT_NAMESPACE,!this.isValidKey(e))throw new Error("Invalid namespace given: "+e);for(var t=i.sql("SELECT key FROM "+this.TABLE_NAME+" WHERE namespace = ?",e),r=[],s=0;s<t.length;s++)r.push(t[s].key);return r},clear:function(e){if(this._initStorage(),e=e||this.DEFAULT_NAMESPACE,!this.isValidKey(e))throw new Error("Invalid namespace given: "+e);i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ?",e)},remove:function(e,t){if(this._initStorage(),!this.isValidKey(e))throw new Error("Invalid key given: "+e);if(t=t||this.DEFAULT_NAMESPACE,!this.isValidKey(t))throw new Error("Invalid namespace given: "+e);i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",t,e)},putMultiple:function(t,r,s,a){if(this._initStorage(),!this.isValidKeyArray(t)||!r instanceof Array||t.length!=r.length)throw new Error("Invalid arguments: keys = ["+t+"], values = ["+r+"]");if((null==a||"undefined"==typeof a)&&(a=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(a))throw new Error("Invalid namespace given: "+a);this._statusHandler=s;try{i.sql.open(),i.sql.db.execute("BEGIN TRANSACTION");for(var n="REPLACE INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)",o=0;o<t.length;o++){var E=r[o];E=e.isString(E)?"string:"+E:e.toJson(E),i.sql.db.execute(n,[a,t[o],E])}i.sql.db.execute("COMMIT TRANSACTION"),i.sql.close()}catch(l){return void(s&&s(this.FAILED,t,l.toString(),a))}s&&s(i.storage.SUCCESS,t,null,a)},getMultiple:function(t,r){if(this._initStorage(),!this.isValidKeyArray(t))throw new("Invalid key array given: "+t);if((null==r||"undefined"==typeof r)&&(r=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(r))throw new Error("Invalid namespace given: "+r);for(var s="SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND  key = ?",a=[],n=0;n<t.length;n++){var o=i.sql(s,r,t[n]);o.length?(o=o[0].value,e.isString(o)&&/^string:/.test(o)?a[n]=o.substring("string:".length):a[n]=e.fromJson(o)):a[n]=null}return a},removeMultiple:function(e,t){if(this._initStorage(),!this.isValidKeyArray(e))throw new Error("Invalid arguments: keys = ["+e+"]");if((null==t||"undefined"==typeof t)&&(t=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(t))throw new Error("Invalid namespace given: "+t);i.sql.open(),i.sql.db.execute("BEGIN TRANSACTION");for(var r="DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",s=0;s<e.length;s++)i.sql.db.execute(r,[t,e[s]]);i.sql.db.execute("COMMIT TRANSACTION"),i.sql.close()},isPermanent:function(){return!0},getMaximumSize:function(){return this.SIZE_NO_LIMIT},hasSettingsUI:function(){return!1},showSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface")},hideSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface")},_initStorage:function(){if(!this._storageReady){if(!google.gears.factory.hasPermission){var e=null,t=null,r="This site would like to use Google Gears to enable enhanced functionality.",s=google.gears.factory.getPermission(e,t,r);if(!s)throw new Error("You must give permission to use Gears in order to store data")}try{i.sql("CREATE TABLE IF NOT EXISTS "+this.TABLE_NAME+"(  namespace TEXT,  key TEXT,  value TEXT )"),i.sql("CREATE UNIQUE INDEX IF NOT EXISTS namespace_key_index ON "+this.TABLE_NAME+" (namespace, key)")}catch(a){throw new Error("Unable to create storage tables for Gears in Dojo Storage")}this._storageReady=!0}}}),i.storage.manager.register("dojox.storage.GearsStorageProvider",new i.storage.GearsStorageProvider)}()});
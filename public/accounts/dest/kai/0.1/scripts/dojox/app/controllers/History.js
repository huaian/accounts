define("dojox/app/controllers/History",["dojo/_base/lang","dojo/_base/declare","dojo/on","../Controller","../utils/hash","dojo/topic"],function(t,i,o,e,a,n){return i("dojox.app.controllers.History",e,{_currentPosition:0,currentState:{},constructor:function(){this.events={"app-domNode":this.onDomNodeChange},this.app.domNode&&this.onDomNodeChange({oldNode:null,newNode:this.app.domNode}),this.bind(window,"popstate",t.hitch(this,this.onPopState))},onDomNodeChange:function(i){null!=i.oldNode&&this.unbind(i.oldNode,"startTransition"),this.bind(i.newNode,"startTransition",t.hitch(this,this.onStartTransition))},onStartTransition:function(i){var o=window.location.hash,e=a.getTarget(o,this.app.defaultView),s=a.getParams(o),r=t.clone(i.detail);r.target=r.title=e,r.url=o,r.params=s,r.id=this._currentPosition,1==history.length&&history.pushState(r,r.href,o),r.bwdTransition=r.transition,t.mixin(this.currentState,r),history.replaceState(this.currentState,this.currentState.href,o),this._currentPosition+=1,i.detail.id=this._currentPosition;var h=i.detail.url||"#"+i.detail.target;i.detail.params&&(h=a.buildWithParams(h,i.detail.params)),i.detail.fwdTransition=i.detail.transition,history.pushState(i.detail,i.detail.href,h),this.currentState=t.clone(i.detail),n.publish("/app/history/pushState",i.detail.target)},onPopState:function(i){if(this.app.getStatus()===this.app.lifecycle.STARTED&&i.state){var o=i.state.id<this._currentPosition;o?this._currentPosition-=1:this._currentPosition+=1;var e=t.mixin({reverse:o?!0:!1},i.state);e.transition=o?e.bwdTransition:e.fwdTransition,this.app.emit("app-transition",{viewId:i.state.target,opts:e}),n.publish("/app/history/popState",i.state.target)}}})});
define("dojox/calendar/StoreManager",["dojo/_base/declare","dojo/_base/array","dojo/_base/html","dojo/_base/lang","dojo/dom-class","dojo/Stateful","dojo/Evented","dojo/when"],function(t,e,i,r,s,n,o,a){return t("dojox.calendar.StoreManager",[n,o],{owner:null,store:null,_ownerItemsProperty:null,_getParentStoreManager:function(){return this.owner&&this.owner.owner?this.owner.owner.get("storeManager"):null},_initItems:function(t){return this.set("items",t),t},_itemsSetter:function(t){this.items=t,this.emit("dataLoaded",t)},_computeVisibleItems:function(t){var i=t.startTime,r=t.endTime,s=null,n=this.owner[this._ownerItemsProperty];return n&&(s=e.filter(n,function(e){return this.owner.isOverlapping(t,e.startTime,e.endTime,i,r)},this)),s},_updateItems:function(t,e,i){var s=!0,n=null,o=this.owner.itemToRenderItem(t,this.store);if(o._item=t,this.items=this.owner[this._ownerItemsProperty],-1!==e)if(i!==e)this.items.splice(e,1),this.owner.setItemSelected&&this.owner.isItemSelected(o)&&(this.owner.setItemSelected(o,!1),this.owner.dispatchChange(o,this.get("selectedItem"),null,null));else{n=this.items[e];var a=this.owner.dateModule;s=0!==a.compare(o.startTime,n.startTime)||0!==a.compare(o.endTime,n.endTime),r.mixin(n,o)}else if(-1!==i){var m,h,d=t.temporaryId;if(d){for(m=this.items?this.items.length:0,h=m-1;h>=0;h--)if(this.items[h].id===d){this.items[h]=o;break}var l=this._getItemStoreStateObj({id:d});this._cleanItemStoreState(d),this._setItemStoreState(o,l?l.state:null)}var S=this._getItemStoreStateObj(o);if(S&&"storing"===S.state){if(this.items&&this.items[i]&&this.items[i].id!==o.id){for(m=this.items.length,h=m-1;h>=0;h--)if(this.items[h].id===o.id){this.items.splice(h,1);break}this.items.splice(i,0,o)}r.mixin(S.renderItem,o)}else this.items.splice(i,0,o);this.set("items",this.items)}this._setItemStoreState(o,"stored"),this.owner._isEditing||(s?this.emit("layoutInvalidated"):this.emit("renderersInvalidated",n))},_storeSetter:function(t){var e,i=this.owner;if(this._observeHandler&&(this._observeHandler.remove(),this._observeHandler=null),t){var s=t.query(i.query,i.queryOptions);s.observe&&(this._observeHandler=s.observe(r.hitch(this,this._updateItems),!0)),s=s.map(r.hitch(this,function(e){var r=i.itemToRenderItem(e,t);return r._item=e,r})),e=a(s,r.hitch(this,this._initItems))}else e=this._initItems([]);return this.store=t,e},_getItemStoreStateObj:function(t){var e=this._getParentStoreManager();if(e)return e._getItemStoreStateObj(t);var i=this.get("store");if(null!=i&&null!=this._itemStoreState){var r=void 0===t.id?i.getIdentity(t):t.id;return this._itemStoreState[r]}return null},getItemStoreState:function(t){var e=this._getParentStoreManager();if(e)return e.getItemStoreState(t);if(null==this._itemStoreState)return"stored";var i=this.get("store"),r=void 0===t.id?i.getIdentity(t):t.id,s=this._itemStoreState[r];return null!=i&&void 0!==s?s.state:"stored"},_cleanItemStoreState:function(t){var e=this._getParentStoreManager();if(e)return e._cleanItemStoreState(t);if(this._itemStoreState){var i=this._itemStoreState[t];return i?(delete this._itemStoreState[t],!0):!1}},_setItemStoreState:function(t,e){var i=this._getParentStoreManager();if(i)return void i._setItemStoreState(t,e);void 0===this._itemStoreState&&(this._itemStoreState={});var r=this.get("store"),s=void 0===t.id?r.getIdentity(t):t.id,n=this._itemStoreState[s];return"stored"===e||null==e?void(void 0!==n&&delete this._itemStoreState[s]):void(r&&(this._itemStoreState[s]={id:s,item:t,renderItem:this.owner.itemToRenderItem(t,r),state:e}))}})});
define("dojox/sql/_base",["dojo","dijit","dojox","dojo/require!dojox/sql/_crypto"],function(t,e,i){t.provide("dojox.sql._base"),t.require("dojox.sql._crypto"),t.mixin(i.sql,{dbName:null,debug:t.exists("dojox.sql.debug")?i.sql.debug:!1,open:function(t){if(!this._dbOpen||t&&t!=this.dbName){this.dbName||(this.dbName="dot_store_"+window.location.href.replace(/[^0-9A-Za-z_]/g,"_"),this.dbName.length>63&&(this.dbName=this.dbName.substring(0,63))),t||(t=this.dbName);try{this._initDb(),this.db.open(t),this._dbOpen=!0}catch(e){throw e.message||e}}},close:function(e){if(!t.isIE&&(this._dbOpen||e&&e!=this.dbName)){e||(e=this.dbName);try{this.db.close(e),this._dbOpen=!1}catch(i){throw i.message||i}}},_exec:function(e){try{this._initDb(),this._dbOpen||(this.open(),this._autoClose=!0);var s=null,n=null,r=null,o=t._toArray(e);s=o.splice(0,1)[0],(this._needsEncrypt(s)||this._needsDecrypt(s))&&(n=o.splice(o.length-1,1)[0],r=o.splice(o.length-1,1)[0]),this.debug&&this._printDebugSQL(s,o);var l;if(this._needsEncrypt(s))return l=new i.sql._SQLCrypto("encrypt",s,r,o,n),null;if(this._needsDecrypt(s))return l=new i.sql._SQLCrypto("decrypt",s,r,o,n),null;var c=this.db.execute(s,o);return c=this._normalizeResults(c),this._autoClose&&this.close(),c}catch(a){if(a=a.message||a,this._autoClose)try{this.close()}catch(h){}throw a}return null},_initDb:function(){if(!this.db)try{this.db=google.gears.factory.create("beta.database","1.0")}catch(e){throw t.setObject("google.gears.denied",!0),i.off&&i.off.onFrameworkEvent("coreOperationFailed"),"Google Gears must be allowed to run"}},_printDebugSQL:function(t,e){for(var i='dojox.sql("'+t+'"',s=0;s<e.length;s++)i+="string"==typeof e[s]?', "'+e[s]+'"':", "+e[s];i+=")"},_normalizeResults:function(t){var e=[];if(!t)return[];for(;t.isValidRow();){for(var i={},s=0;s<t.fieldCount();s++){var n=t.fieldName(s),r=t.field(s);i[n]=r}e.push(i),t.next()}return t.close(),e},_needsEncrypt:function(t){return/encrypt\([^\)]*\)/i.test(t)},_needsDecrypt:function(t){return/decrypt\([^\)]*\)/i.test(t)}}),t.declare("dojox.sql._SQLCrypto",null,{constructor:function(t,e,i,s,n){"encrypt"==t?this._execEncryptSQL(e,i,s,n):this._execDecryptSQL(e,i,s,n)},_execEncryptSQL:function(t,e,s,n){var r=this._stripCryptoSQL(t),o=this._flagEncryptedArgs(t,s),l=this;this._encrypt(r,e,s,o,function(s){var o=!1,c=[],a=null;try{c=i.sql.db.execute(r,s)}catch(h){o=!0,a=h.message||h}if(null!=a){if(i.sql._autoClose)try{i.sql.close()}catch(u){}return void n(null,!0,a.toString())}if(c=i.sql._normalizeResults(c),i.sql._autoClose&&i.sql.close(),i.sql._needsDecrypt(t)){var p=l._determineDecryptedColumns(t);l._decrypt(c,p,e,function(t){n(t,!1,null)})}else n(c,!1,null)})},_execDecryptSQL:function(t,e,s,n){var r=this._stripCryptoSQL(t),o=this._determineDecryptedColumns(t),l=!1,c=[],a=null;try{c=i.sql.db.execute(r,s)}catch(h){l=!0,a=h.message||h}if(null!=a){if(i.sql._autoClose)try{i.sql.close()}catch(u){}return void n(c,!0,a.toString())}c=i.sql._normalizeResults(c),i.sql._autoClose&&i.sql.close(),this._decrypt(c,o,e,function(t){n(t,!1,null)})},_encrypt:function(e,s,n,r,o){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalArgs=n;for(var l=0;l<n.length;l++)if(r[l]){var c=n[l],a=l;this._totalCrypto++,i.sql._crypto.encrypt(c,s,t.hitch(this,function(t){this._finalArgs[a]=t,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&o(this._finalArgs)}))}this._finishedSpawningCrypto=!0},_decrypt:function(t,e,i,s){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalResultSet=t;for(var n=0;n<t.length;n++){var r=t[n];for(var o in r)if("*"==e||e[o]){this._totalCrypto++;var l=r[o];this._decryptSingleColumn(o,l,i,n,function(t){s(t)})}}this._finishedSpawningCrypto=!0},_stripCryptoSQL:function(t){t=t.replace(/DECRYPT\(\*\)/gi,"*");var e=t.match(/ENCRYPT\([^\)]*\)/gi);if(null!=e)for(var i=0;i<e.length;i++){var s=e[i],n=s.match(/ENCRYPT\(([^\)]*)\)/i)[1];t=t.replace(s,n)}if(e=t.match(/DECRYPT\([^\)]*\)/gi),null!=e)for(i=0;i<e.length;i++){var r=e[i],o=r.match(/DECRYPT\(([^\)]*)\)/i)[1];t=t.replace(r,o)}return t},_flagEncryptedArgs:function(t,e){for(var i,s=new RegExp(/([\"][^\"]*\?[^\"]*[\"])|([\'][^\']*\?[^\']*[\'])|(\?)/gi),n=0,r=[];null!=(i=s.exec(t));){var o=RegExp.lastMatch+"";if(!/^[\"\']/.test(o)){var l=!1;/ENCRYPT\([^\)]*$/i.test(RegExp.leftContext)&&(l=!0),r[n]=l,n++}}return r},_determineDecryptedColumns:function(e){var i={};if(/DECRYPT\(\*\)/i.test(e))i="*";else for(var s=/DECRYPT\((?:\s*\w*\s*\,?)*\)/gi,n=s.exec(e);n;){var r=new String(RegExp.lastMatch),o=r.replace(/DECRYPT\(/i,"");o=o.replace(/\)/,""),o=o.split(/\s*,\s*/),t.forEach(o,function(t){/\s*\w* AS (\w*)/i.test(t)&&(t=t.match(/\s*\w* AS (\w*)/i)[1]),i[t]=!0}),n=s.exec(e)}return i},_decryptSingleColumn:function(e,s,n,r,o){i.sql._crypto.decrypt(s,n,t.hitch(this,function(t){this._finalResultSet[r][e]=t,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&o(this._finalResultSet)}))}}),function(){var e=i.sql;i.sql=new Function("return dojox.sql._exec(arguments);"),t.mixin(i.sql,e)}()});
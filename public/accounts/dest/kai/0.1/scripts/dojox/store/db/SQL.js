define("dojox/store/db/SQL",["dojo/_base/declare","dojo/Deferred","dojo/when","dojo/store/util/QueryResults","dojo/_base/lang","dojo/promise/all"],function(e,t,i,r,n,s){function o(e){return e&&n.mixin(e,JSON.parse(e.__extra))}var u=/(.*)\*$/;return e([],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var i=this.indexPrefix=e.indexPrefix||"idx_",r=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var n=[];this.indices=t.stores[r],this.repeatingIndices={};for(var o in this.indices)this.indices[o].multiEntry&&(this.repeatingIndices[o]=!0);if(!t.available){for(var r in t.stores){var u=t.stores[r],a=r.replace(/[^\w]/g,"_"),h=u[this.idProperty],d=["__extra",this.idProperty+" "+(h&&h.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],c=[this.idProperty];for(var o in u)o!=this.idProperty&&d.push(o);n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+a+" ("+d.join(",")+")"));for(var o in u)if(o!=this.idProperty)if(u[o].multiEntry){c.push(o);var l=a+"_repeating_"+o;n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+l+" (id,value)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+l+"_id ON "+l+"(id)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+l+"_value ON "+l+"(value)"))}else n.push(this.executeSql("ALTER TABLE "+a+" ADD "+o).then(null,function(){})),u[o].indexed!==!1&&n.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+i+a+"_"+o+" ON "+a+"("+o+")"))}t.available=s(n)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){return i(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?o(e.rows.item(0)):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e,t){var r=[],n=[],o=[],u={},a=[],h=this;for(var d in e)e.hasOwnProperty(d)&&(d in this.indices||d==this.idProperty?this.repeatingIndices[d]?a.push(function(t){var i=e[d];return s(i.map(function(e){return h.executeSql("INSERT INTO "+h.table+"_repeating_"+d+" (value, id) VALUES (?, ?)",[e,t])}))}):(o.push(d),n.push("?"),r.push(e[d])):u[d]=e[d]);o.push("__extra"),n.push("?"),r.push(JSON.stringify(u));var c=this.idProperty;this.identifyGeneratedKey&&(r.idColumn=c);var l="INSERT INTO "+this.table+" ("+o.join(",")+") VALUES ("+n.join(",")+")";return i(this.executeSql(l,r),function(t){var i=t.insertId;return e[c]=i,s(a.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){t=t||{};var r=t.id||e[this.idProperty],n=t.overwrite;if(void 0===n){var s=this;return this.get(r).then(function(i){return(t.overwrite=!!i)?(t.overwrite=!0,s.put(e,t)):s.add(e,t)})}if(!n)return s.add(e,t);var o="UPDATE "+this.table+" SET ",u=[],a=[],h={};for(var d in e)if(e.hasOwnProperty(d))if(d in this.indices||d==this.idProperty)if(this.repeatingIndices[d]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+d+" WHERE id=?",[r]);for(var c=e[d],l=0;l<c.length;l++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+d+" (value, id) VALUES (?, ?)",[c[l],r])}else a.push(d+"=?"),u.push(e[d]);else h[d]=e[d];return a.push("__extra=?"),u.push(JSON.stringify(h)),o+=a.join(",")+" WHERE "+this.idProperty+"=?",u.push(e[this.idProperty]),i(this.executeSql(o,u),function(e){return r})},query:function(e,t){function i(e){function t(e){var t=e&&e.match&&e.match(u);return t?(c.push(t[1]+"%")," LIKE ?"):(c.push(e),"=?")}var i=[];for(var r in e){var n=e[r];if(n){if(n.contains){var s=h.table+"_repeating_"+r;i.push(n.contains.map(function(e){return h.idProperty+" IN (SELECT id FROM "+s+" WHERE value"+t(e)+")"}).join(" AND "));continue}if("object"==typeof n&&("from"in n||"to"in n)){var o=n.excludeFrom?">":">=",a=n.excludeTo?"<":"<=";"from"in n?(c.push(n.from),"to"in n?(c.push(n.to),i.push("("+d+"."+r+o+"? AND "+d+"."+r+a+"?)")):i.push(d+"."+r+o+"?")):(c.push(n.to),i.push(d+"."+r+a+"?"));continue}}i.push(d+"."+r+t(n))}return i.join(" AND ")}t=t||{};var s,a="FROM "+this.table,h=this,d=this.table,c=[];e.forEach?(s=e.map(i).join(") OR ("),s&&(s="("+s+")")):s=i(e),s&&(s=" WHERE "+s),t.sort&&(s+=" ORDER BY "+t.sort.map(function(e){return d+"."+e.attribute+" "+(e.descending?"desc":"asc")}));var l=s;t.count&&(l+=" LIMIT "+t.count),t.start&&(l+=" OFFSET "+t.start);var p=n.delegate(this.executeSql("SELECT * "+a+l,c).then(function(e){for(var t=[],i=0;i<e.rows.length;i++)t.push(o(e.rows.item(i)));return t})),h=this;return p.total={then:function(e,t){return h.executeSql("SELECT COUNT(*) "+a+s,c).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}},new r(p)},executeSql:function(e,i){var r,n,s=new t;if(this.database.transaction(function(t){t.executeSql(e,i,function(e,t){s.resolve(r=t)},function(e,t){s.reject(n=t)})}),r)return r;if(n)throw n;return s.promise}})});
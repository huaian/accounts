define("dojox/store/priority",["dojo/_base/lang","dojo/Deferred","dojo/when"],function(r,e,t){function n(){for(var r=u.length-1;r>=i;r--){var e=u[r],t=e&&e[e.length-1];if(t){e.pop(),i++;try{t.executor(function(){i--,n()})}catch(o){t.def.reject(o),n()}}}}function o(){var r=new e;return{promise:{total:{then:function(e,t){return r.then(function(r){return r.results.total}).then(e,t)}},forEach:function(e,t){return r.then(function(r){return r.results.forEach(e,t)})},map:function(e,t){return r.then(function(r){return r.results.map(e,t)})},filter:function(e,t){return r.then(function(r){return r.results.filter(e,t)})},then:function(e,n){return r.then(function(r){return t(r.results,e,n)})}},resolve:r.resolve,reject:r.reject}}var u=[],i=0;return function(i,c){c=c||{};var f=r.delegate(i);return["add","put","query","remove","get"].forEach(function(r){var a=i[r];a&&(f[r]=function(f,l){l=l||{};var s,h;if(l.immediate)return a.call(i,f,l);l.immediate=!0,"query"===r?(h=function(r){var e=a.call(i,f,l);s.resolve({results:e}),t(e,r,r)},s=o()):(h=function(r){t(a.call(i,f,l),function(e){s.resolve(e),r()},function(e){s.reject(e),r()})},s=new e);var v=l.priority>-1?l.priority:c.priority>-1?c.priority:4;return(u[v]||(u[v]=[])).push({executor:h,def:s}),n(),s.promise})}),f}});
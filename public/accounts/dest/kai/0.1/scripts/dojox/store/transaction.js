define("dojox/store/transaction",["dojo/store/Memory","dojo/store/Cache","dojo/when","dojo/aspect","dojo/_base/lang"],function(r,t,e,o,n){var i,a={},u=1;return function(d){function c(r){return function t(o,n){var i=this;if(l){var a=f[r](o,n);return e(a,null,function(r){i.errorHandler(r)&&(l=!1,n.error=r,t.call(i,o,n),l=!0)}),a}var u="remove"===r?o:i.getIdentity(o);if(void 0!==u)var d=v.get(u);return e(d,function(t){return e(s.add({objectId:u,method:r,target:o,previous:t,options:n,storeId:m}),function(){return o})})}}d=d||{};var f=d.masterStore,v=d.cachingStore,m=f.id||f.storeName||f.name||(f.id=u++);m&&(a[m]=f);var s=d.transactionLogStore||i||(i=new r),l=!0;return o.before(f,"notify",function(r,t){r?v.put(r):v.remove(t)}),new t(n.delegate(f,{put:c("put"),add:c("add"),remove:c("remove"),errorHandler:function(r){return!0},commit:function(){l=!0;var r=this;return s.query({}).map(function(t){var e,o=t.method,n=a[t.storeId],i=t.target;try{e=n[o](i,t.options)}catch(u){if(e=r.errorHandler(u),e===!0)return u;e===!1&&("add"===o?v.remove(t.objectId):v.put(i),n.notify&&n.notify("add"===o?null:t.previous,"remove"===o?void 0:t.objectId)),e=u}return s.remove(t.id),e})},transaction:function(){l=!1;var r=this;return{commit:function(){return r.commit()}}}}),v,d)}});
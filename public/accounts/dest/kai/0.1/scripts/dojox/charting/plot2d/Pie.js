define("dojox/charting/plot2d/Pie",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","./Base","./_PlotEvents","./common","dojox/gfx","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","dojo/has"],function(t,e,i,s,r,a,l,n,h,o,c){var f=.2;return i("dojox.charting.plot2d.Pie",[s,r],{defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelOffset:20,labelStyle:"default",htmlLabels:!0,radGrad:"native",fanSize:5,startAngle:0},optionalParams:{radius:0,omitLabels:!1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},constructor:function(e,i){this.opt=t.clone(this.defaultParams),o.updateWithObject(this.opt,i),o.updateWithPattern(this.opt,i,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return t.delegate(a.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},render:function(i,s){if(!this.dirty)return this;this.resetEvents(),this.dirty=!1,this._eventSeries={},this.cleanGroup();var r=this.group,a=this.chart.theme;if(!this.run||!this.run.data.length)return this;var o,u,d,p,x,y,b=(i.width-s.l-s.r)/2,g=(i.height-s.t-s.b)/2,m=Math.min(b,g),v="font"in this.opt?this.opt.font:a.series.font,M=n._degToRad(this.opt.startAngle),_=M,P=this.events(),R=e.map(this.run.data,function(t,i){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(i),t.hidden=!1),e.some(this.runFilter,function(t){return t==i})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(m=this.opt.radius,y=m-this.opt.labelOffset);var F={cx:s.l+b,cy:s.t+g,r:m};if(this.opt.shadow||a.shadow){var k=this.opt.shadow||a.shadow,T=t.clone(F);T.cx+=k.dx,T.cy+=k.dy,r.createCircle(T).setFill(k.color).setStroke(k)}if(r.setFilter&&(this.opt.filter||a.filter)&&r.createCircle(F).setFill(a.series.stroke).setFilter(this.opt.filter||a.filter),"number"==typeof R[0]){if(u=h.map(R,"x ? Math.max(x, 0) : 0"),h.every(u,"<= 0"))return r.createCircle(F).setStroke(a.series.stroke),this.dyn=e.map(u,function(){return{}}),this;d=h.map(u,"/this",h.foldl(u,"+",0)),this.opt.labels&&(p=e.map(d,function(t){return t>0?this._getLabel(100*t)+"%":""},this))}else{if(u=h.map(R,"x ? Math.max(x.y, 0) : 0"),h.every(u,"<= 0"))return r.createCircle(F).setStroke(a.series.stroke),this.dyn=e.map(u,function(){return{}}),this;d=h.map(u,"/this",h.foldl(u,"+",0)),this.opt.labels&&(p=e.map(d,function(t,e){if(0>t)return"";var i=R[e];return"text"in i?i.text:this._getLabel(100*t)+"%"},this))}var S=h.map(R,function(t,e){var i=[this.opt,this.run];return null!==t&&"number"!=typeof t&&i.push(t),this.opt.styleFunc&&i.push(this.opt.styleFunc(t)),a.next("slice",i,!0)},this);this.opt.labels&&(o=v?l.normalizedLength(l.splitFontString(v).size):0,x=h.foldl1(h.map(p,function(t,e){var i=S[e].series.font;return l._base._getTextBox(t,{font:i}).w},this),"Math.max(a, b)")/2,this.opt.labelOffset<0&&(m=Math.min(b-2*x,g-o)+this.opt.labelOffset),y=m-this.opt.labelOffset);var L=new Array(d.length);if(e.some(d,function(t,e){if(0>t)return!1;var a,l,h=R[e],o=S[e];if(0==t)return this.dyn.push({fill:o.series.fill,stroke:o.series.stroke}),!1;if(t>=1){a=this._plotFill(o.series.fill,i,s),a=this._shapeFill(a,{x:F.cx-F.r,y:F.cy-F.r,width:2*F.r,height:2*F.r}),a=this._pseudoRadialFill(a,{x:F.cx,y:F.cy},F.r);var c=r.createCircle(F).setFill(a).setStroke(o.series.stroke);return this.dyn.push({fill:a,stroke:o.series.stroke}),P&&(l={element:"slice",index:e,run:this.run,shape:c,x:e,y:"number"==typeof h?h:h.y,cx:F.cx,cy:F.cy,cr:m},this._connectEvents(l),L[e]=l),!1}var u=_+2*t*Math.PI;e+1==d.length&&(u=M+2*Math.PI);var p=u-_,x=F.cx+m*Math.cos(_),y=F.cy+m*Math.sin(_),b=F.cx+m*Math.cos(u),g=F.cy+m*Math.sin(u),v=n._degToRad(this.opt.fanSize);if(o.series.fill&&"radial"===o.series.fill.type&&"fan"===this.opt.radGrad&&p>v){var k=r.createGroup(),T=Math.ceil(p/v),w=p/T;a=this._shapeFill(o.series.fill,{x:F.cx-F.r,y:F.cy-F.r,width:2*F.r,height:2*F.r});for(var j=0;T>j;++j){var I=0==j?x:F.cx+m*Math.cos(_+(j-f)*w),O=0==j?y:F.cy+m*Math.sin(_+(j-f)*w),C=j==T-1?b:F.cx+m*Math.cos(_+(j+1+f)*w),B=j==T-1?g:F.cy+m*Math.sin(_+(j+1+f)*w);k.createPath().moveTo(F.cx,F.cy).lineTo(I,O).arcTo(m,m,0,w>Math.PI,!0,C,B).lineTo(F.cx,F.cy).closePath().setFill(this._pseudoRadialFill(a,{x:F.cx,y:F.cy},m,_+(j+.5)*w,_+(j+.5)*w))}k.createPath().moveTo(F.cx,F.cy).lineTo(x,y).arcTo(m,m,0,p>Math.PI,!0,b,g).lineTo(F.cx,F.cy).closePath().setStroke(o.series.stroke),c=k}else c=r.createPath().moveTo(F.cx,F.cy).lineTo(x,y).arcTo(m,m,0,p>Math.PI,!0,b,g).lineTo(F.cx,F.cy).closePath().setStroke(o.series.stroke),a=o.series.fill,a&&"radial"===a.type?(a=this._shapeFill(a,{x:F.cx-F.r,y:F.cy-F.r,width:2*F.r,height:2*F.r}),"linear"===this.opt.radGrad&&(a=this._pseudoRadialFill(a,{x:F.cx,y:F.cy},m,_,u))):a&&"linear"===a.type&&(a=this._plotFill(a,i,s),a=this._shapeFill(a,c.getBoundingBox())),c.setFill(a);return this.dyn.push({fill:a,stroke:o.series.stroke}),P&&(l={element:"slice",index:e,run:this.run,shape:c,x:e,y:"number"==typeof h?h:h.y,cx:F.cx,cy:F.cy,cr:m},this._connectEvents(l),L[e]=l),_=u,!1},this),this.opt.labels){var w=c("dojo-bidi")&&this.chart.isRightToLeft();if("default"==this.opt.labelStyle)_=M,e.some(d,function(t,e){if(0>=t)return!1;var s=S[e];if(t>=1)return this.renderLabel(r,F.cx,F.cy+o/2,p[e],s,this.opt.labelOffset>0),!0;var a=_+2*t*Math.PI;if(e+1==d.length&&(a=M+2*Math.PI),this.opt.omitLabels&&.001>a-_)return!1;var l=(_+a)/2,n=F.cx+y*Math.cos(l),h=F.cy+y*Math.sin(l)+o/2;return this.renderLabel(r,w?i.width-n:n,h,p[e],s,this.opt.labelOffset>0),_=a,!1},this);else if("columns"==this.opt.labelStyle){_=M;var j=this.opt.omitLabels,I=[];e.forEach(d,function(t,e){var i=_+2*t*Math.PI;e+1==d.length&&(i=M+2*Math.PI);var s=(_+i)/2;I.push({angle:s,left:Math.cos(s)<0,theme:S[e],index:e,omit:j?.001>i-_:!1}),_=i});var O=l._base._getTextBox("a",{font:v}).h;this._getProperLabelRadius(I,O,1.1*F.r),e.forEach(I,function(t,e){if(!t.omit){var s=F.cx-2*F.r,a=F.cx+2*F.r,n=l._base._getTextBox(p[e],{font:t.theme.series.font}).w,h=F.cx+t.labelR*Math.cos(t.angle),o=F.cy+t.labelR*Math.sin(t.angle),c=t.left?s+n:a-n,f=t.left?s:c,u=r.createPath().moveTo(F.cx+F.r*Math.cos(t.angle),F.cy+F.r*Math.sin(t.angle));Math.abs(t.labelR*Math.cos(t.angle))<2*F.r-n&&u.lineTo(h,o),u.lineTo(c,o).setStroke(t.theme.series.labelWiring),this.renderLabel(r,w?i.width-n-f:f,o,p[e],t.theme,!1,"left")}},this)}}var C=0;return this._eventSeries[this.run.name]=h.map(R,function(t){return 0>=t?null:L[C++]}),c("dojo-bidi")&&this._checkOrientation(this.group,i,s),this},_getProperLabelRadius:function(t,e,i){var s,r,a=1,l=1;if(1==t.length)return void(t[0].labelR=i);for(var n=0;n<t.length;n++){var h=Math.abs(Math.sin(t[n].angle));t[n].left?a>=h&&(a=h,s=t[n]):l>=h&&(l=h,r=t[n])}s.labelR=r.labelR=i,this._calculateLabelR(s,t,e),this._calculateLabelR(r,t,e)},_calculateLabelR:function(t,e,i){for(var s,r=t.index,a=e.length,l=t.labelR;!(e[r%a].left^e[(r+1)%a].left);)e[(r+1)%a].omit||(s=(Math.sin(e[r%a].angle)*l+(e[r%a].left?-i:i))/Math.sin(e[(r+1)%a].angle),l=s<t.labelR?t.labelR:s,e[(r+1)%a].labelR=l),r++;r=t.index;for(var n=0==r?a-1:r-1;!(e[r].left^e[n].left);)e[n].omit||(s=(Math.sin(e[r].angle)*l+(e[r].left?i:-i))/Math.sin(e[n].angle),l=s<t.labelR?t.labelR:s,e[n].labelR=l),r--,n--,r=0>r?r+e.length:r,n=0>n?n+e.length:n}})});
define("dojox/grid/enhanced/plugins/Rearrange",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","../../EnhancedGrid","../_Plugin","./_RowMapLayer"],function(e,r,i,o,t,n,a,s){var l=i("dojox.grid.enhanced.plugins.Rearrange",a,{name:"rearrange",constructor:function(e,r){this.grid=e,this.setArgs(r);var i=new s(e);dojox.grid.enhanced.plugins.wrap(e,"_storeLayerFetch",i)},setArgs:function(e){this.args=r.mixin(this.args||{},e||{}),this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(e){return e}},destroy:function(){this.inherited(arguments),this.grid.unwrap("rowmap")},onSetStore:function(e){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(e){var r=this.grid,i=r.store,t=r.layout.cells;return i.getFeatures()["dojo.data.api.Identity"]&&o.some(e,function(e){return i.getIdentityAttributes(r._by_idx[e.r].item)==t[e.c].field})?!0:!1},moveColumns:function(e,r){var i,o,n=this.grid,a=n.layout,s=a.cells,l=0,c=!0,d={},f={};for(e.sort(function(e,r){return e-r}),o=0;o<e.length;++o)d[e[o]]=o,e[o]<r&&++l;var u=0,h=0,m=Math.max(e[e.length-1],r);m==s.length&&--m;var g=Math.min(e[0],r);for(o=g;m>=o;++o){var p=d[o];p>=0?f[o]=r-l+p:r>o?(f[o]=g+u,++u):o>=r&&(f[o]=r+e.length-l+h,++h)}for(l=0,r==s.length&&(--r,c=!1),n._notRefreshSelection=!0,o=0;o<e.length;++o)i=e[o],r>i&&(i-=l),++l,i!=r&&(a.moveColumn(s[i].view.idx,s[r].view.idx,i,r,c),s=a.cells),i>=r&&++r;delete n._notRefreshSelection,t.publish("dojox/grid/rearrange/move/"+n.id,["col",f,e])},moveRows:function(e,i){var n,a,s,l,c,d,f=this.grid,u={},h=[],m=[],g=e.length;for(n=0;g>n&&(a=e[n],!(a>=i));++n)h.push(a);if(m=e.slice(n),l=h,g=l.length)for(c={},o.forEach(l,function(e){c[e]=!0}),u[l[0]]=i-g,s=0,n=l[s]+1,d=n-1;i>n;++n)c[n]?(++s,u[n]=i-g+s):(u[n]=d,++d);if(l=m,g=l.length)for(c={},o.forEach(l,function(e){c[e]=!0}),u[l[g-1]]=i+g-1,s=g-1,n=l[s]-1,d=n+1;n>=i;--n)c[n]?(--s,u[n]=i+s):(u[n]=d,--d);var p=r.clone(u);f.layer("rowmap").setMapping(u),f.forEachLayer(function(e){return"rowmap"!=e.name()?(e.invalidate(),!0):!1},!1),f.selection.selected=[],f._noInternalMapping=!0,f._refresh(),setTimeout(function(){t.publish("dojox/grid/rearrange/move/"+f.id,["row",p,e]),f._noInternalMapping=!1},0)},moveCells:function(e,r){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==r.min.row&&e.min.col==r.min.col)return;var a,s,l,c,d=i.layout.cells,f=(e.max.row-e.min.row+1,[]),u=[];for(a=e.min.row,l=r.min.row;a<=e.max.row;++a,++l)for(s=e.min.col,c=r.min.col;s<=e.max.col;++s,++c){for(;d[s]&&d[s].hidden;)++s;for(;d[c]&&d[c].hidden;)++c;f.push({r:a,c:s}),u.push({r:l,c:c,v:d[s].get(a,i._by_idx[a].item)})}if(this._hasIdentity(f.concat(u)))return;o.forEach(f,function(e){n.setValue(i._by_idx[e.r].item,d[e.c].field,"")}),o.forEach(u,function(e){n.setValue(i._by_idx[e.r].item,d[e.c].field,e.v)}),n.save({onComplete:function(){t.publish("dojox/grid/rearrange/move/"+i.id,["cell",{from:e,to:r}])}})}},copyCells:function(e,r){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==r.min.row&&e.min.col==r.min.col)return;var a,s,l,c,d=i.layout.cells,f=(e.max.row-e.min.row+1,[]);for(a=e.min.row,l=r.min.row;a<=e.max.row;++a,++l)for(s=e.min.col,c=r.min.col;s<=e.max.col;++s,++c){for(;d[s]&&d[s].hidden;)++s;for(;d[c]&&d[c].hidden;)++c;f.push({r:l,c:c,v:d[s].get(a,i._by_idx[a].item)})}if(this._hasIdentity(f))return;o.forEach(f,function(e){n.setValue(i._by_idx[e.r].item,d[e.c].field,e.v)}),n.save({onComplete:function(){setTimeout(function(){t.publish("dojox/grid/rearrange/copy/"+i.id,["cell",{from:e,to:r}])},0)}})}},changeCells:function(e,r,i){var n=this.grid,a=n.store;if(a.getFeatures()["dojo.data.api.Write"]){var s,l,c,d,f=e,u=n.layout.cells,h=f.layout.cells,m=(r.max.row-r.min.row+1,[]);for(s=r.min.row,c=i.min.row;s<=r.max.row;++s,++c)for(l=r.min.col,d=i.min.col;l<=r.max.col;++l,++d){for(;h[l]&&h[l].hidden;)++l;for(;u[d]&&u[d].hidden;)++d;m.push({r:c,c:d,v:h[l].get(s,f._by_idx[s].item)})}if(this._hasIdentity(m))return;o.forEach(m,function(e){a.setValue(n._by_idx[e.r].item,u[e.c].field,e.v)}),a.save({onComplete:function(){t.publish("dojox/grid/rearrange/change/"+n.id,["cell",i])}})}},clearCells:function(e){var r=this.grid,i=r.store;if(i.getFeatures()["dojo.data.api.Write"]){var n,a,s=r.layout.cells,l=(e.max.row-e.min.row+1,[]);for(n=e.min.row;n<=e.max.row;++n)for(a=e.min.col;a<=e.max.col;++a){for(;s[a]&&s[a].hidden;)++a;l.push({r:n,c:a})}if(this._hasIdentity(l))return;o.forEach(l,function(e){i.setValue(r._by_idx[e.r].item,s[e.c].field,"")}),i.save({onComplete:function(){t.publish("dojox/grid/rearrange/change/"+r.id,["cell",e])}})}},insertRows:function(e,i,n){try{var a,s=this.grid,l=s.store,c=s.rowCount,d={},f={idx:0},u=[],h=0>n,m=this,g=i.length;if(h)n=0;else for(a=n;a<s.rowCount;++a)d[a]=a+g;if(l.getFeatures()["dojo.data.api.Write"]){if(e){var p,w,v=e,x=v.store;if(h)w=o.filter(o.map(s.layout.cells,function(e){return e.field}),function(e){return e});else{for(a=0;!p;++a)p=s._by_idx[a];w=l.getAttributes(p.item)}var _=[];o.forEach(i,function(e,r){var i={},t=v._by_idx[e];if(t){o.forEach(w,function(e){i[e]=x.getValue(t.item,e)}),i=m.args.setIdentifierForNewItem(i,l,c+f.idx)||i;try{l.newItem(i),u.push(n+r),d[c+f.idx]=n+r,++f.idx}catch(a){}}else _.push(e)})}else{if(!i.length||!r.isObject(i[0]))return;o.forEach(i,function(e,r){var i=m.args.setIdentifierForNewItem(e,l,c+f.idx)||e;try{l.newItem(i),u.push(n+r),d[c+f.idx]=n+r,++f.idx}catch(o){}})}s.layer("rowmap").setMapping(d),l.save({onComplete:function(){s._refresh(),setTimeout(function(){t.publish("dojox/grid/rearrange/insert/"+s.id,["row",u])},0)}})}}catch(y){}},removeRows:function(e){var r=this.grid,i=r.store;try{o.forEach(o.map(e,function(e){return r._by_idx[e]}),function(e){e&&i.deleteItem(e.item)}),i.save({onComplete:function(){t.publish("dojox/grid/rearrange/remove/"+r.id,["row",e])}})}catch(n){}},_getPageInfo:function(){var e,r,i,t=this.grid.scroller,n=t.page,a=t.page,s=t.firstVisibleRow,l=t.lastVisibleRow,c=t.rowsPerPage,d=t.pageNodes[0],f=[];return o.forEach(d,function(o,t){o&&(i=!1,e=t*c,r=(t+1)*c-1,s>=e&&r>=s&&(n=t,i=!0),l>=e&&r>=l&&(a=t,i=!0),!i&&(e>l||s>r)&&f.push(t))}),{topPage:n,bottomPage:a,invalidPages:f}}});return n.registerPlugin(l),l});
define("dojox/xmpp/TransportSession",["dojo","dijit","dojox","dojo/require!dojox/xmpp/bosh,dojox/xmpp/util,dojox/data/dom"],function(t,e,i){t.provide("dojox.xmpp.TransportSession"),t.require("dojox.xmpp.bosh"),t.require("dojox.xmpp.util"),t.require("dojox.data.dom"),i.xmpp.TransportSession=function(e){this.sendTimeout=1e3*(this.wait+20),e&&t.isObject(e)&&(t.mixin(this,e),this.useScriptSrcTransport&&(this.transportIframes=[]))},t.extend(i.xmpp.TransportSession,{rid:0,hold:1,polling:1e3,secure:!1,wait:60,lang:"en",submitContentType:"text/xml; charset=utf=8",serviceUrl:"/httpbind",defaultResource:"dojoIm",domain:"imserver.com",sendTimeout:0,useScriptSrcTransport:!1,keepAliveTimer:null,state:"NotReady",transmitState:"Idle",protocolPacketQueue:[],outboundQueue:[],outboundRequests:{},inboundQueue:[],deferredRequests:{},matchTypeIdAttribute:{},open:function(){this.status="notReady",this.rid=Math.round(1e9*Math.random()),this.protocolPacketQueue=[],this.outboundQueue=[],this.outboundRequests={},this.inboundQueue=[],this.deferredRequests={},this.matchTypeIdAttribute={},this.keepAliveTimer=setTimeout(t.hitch(this,"_keepAlive"),1e4),this.useScriptSrcTransport?i.xmpp.bosh.initialize({iframes:this.hold+1,load:t.hitch(this,function(){this._sendLogin()})}):this._sendLogin()},_sendLogin:function(){var t=this.rid++,e={content:this.submitContentType,hold:this.hold,rid:t,to:this.domain,secure:this.secure,wait:this.wait,"xml:lang":this.lang,"xmpp:version":"1.0",xmlns:i.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},s=i.xmpp.util.createElement("body",e,!0);this.addToOutboundQueue(s,t)},_sendRestart:function(){var t=this.rid++,e={rid:t,sid:this.sid,to:this.domain,"xmpp:restart":"true","xml:lang":this.lang,xmlns:i.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},s=i.xmpp.util.createElement("body",e,!0);this.addToOutboundQueue(s,t)},processScriptSrc:function(t,e){var s=i.xml.parser.parse(t,"text/xml");s&&this.processDocument(s,e)},_keepAlive:function(){"wait"==this.state||this.isTerminated()||(this._dispatchPacket(),this.keepAliveTimer=setTimeout(t.hitch(this,"_keepAlive"),1e4))},close:function(t){var e=this.rid++,s={sid:this.sid,rid:e,type:"terminate"},o=null;t?(o=new i.string.Builder(i.xmpp.util.createElement("body",s,!1)),o.append(t),o.append("</body>")):o=new i.string.Builder(i.xmpp.util.createElement("body",s,!1)),this.addToOutboundQueue(o.toString(),e),"Terminate"==this.state},dispatchPacket:function(e,i,s,o){e&&this.protocolPacketQueue.push(e);var r=new t.Deferred;return i&&s&&(r.protocolMatchType=i,r.matchId=s,r.matchProperty=o||"id","id"!=r.matchProperty&&(this.matchTypeIdAttribute[i]=r.matchProperty)),this.deferredRequests[r.protocolMatchType+"-"+r.matchId]=r,this.dispatchTimer||(this.dispatchTimer=setTimeout(t.hitch(this,"_dispatchPacket"),600)),r},_dispatchPacket:function(){if(clearTimeout(this.dispatchTimer),delete this.dispatchTimer,this.sid&&this.authId&&!("error"!=this.transmitState&&0==this.protocolPacketQueue.length&&this.outboundQueue.length>0||"wait"==this.state||this.isTerminated())){var e,s={sid:this.sid,xmlns:i.xmpp.xmpp.BODY_NS};if(this.protocolPacketQueue.length>0)s.rid=this.rid++,e=new i.string.Builder(i.xmpp.util.createElement("body",s,!1)),e.append(this.processProtocolPacketQueue()),e.append("</body>"),delete this.lastPollTime;else{if(this.lastPollTime){var o=(new Date).getTime();if(o-this.lastPollTime<this.polling)return void(this.dispatchTimer=setTimeout(t.hitch(this,"_dispatchPacket"),this.polling-(o-this.lastPollTime)+10))}s.rid=this.rid++,this.lastPollTime=(new Date).getTime(),e=new i.string.Builder(i.xmpp.util.createElement("body",s,!0))}this.addToOutboundQueue(e.toString(),s.rid)}},redispatchPacket:function(t){var e=this.outboundRequests[t];this.sendXml(e,t)},addToOutboundQueue:function(t,e){this.outboundQueue.push({msg:t,rid:e}),this.outboundRequests[e]=t,this.sendXml(t,e)},removeFromOutboundQueue:function(t){for(var e=0;e<this.outboundQueue.length;e++)if(t==this.outboundQueue[e].rid){this.outboundQueue.splice(e,1);break}delete this.outboundRequests[t]},processProtocolPacketQueue:function(){for(var t=new i.string.Builder,e=0;e<this.protocolPacketQueue.length;e++)t.append(this.protocolPacketQueue[e]);return this.protocolPacketQueue=[],t.toString()},sendXml:function(e,s){if(this.isTerminated())return!1;this.transmitState="transmitting";var o=null;return o=this.useScriptSrcTransport?i.xmpp.bosh.get({rid:s,url:this.serviceUrl+"?"+encodeURIComponent(e),error:t.hitch(this,function(t,e){return this.setState("Terminate","error"),!1}),timeout:this.sendTimeout}):t.rawXhrPost({contentType:"text/xml",url:this.serviceUrl,postData:e,handleAs:"xml",error:t.hitch(this,function(t,e){return this.processError(e.xhr.responseXML,e.xhr.status,s)}),timeout:this.sendTimeout}),o.addCallback(this,function(t){return this.processDocument(t,s)}),o},processDocument:function(t,e){if(this.isTerminated()||!t.firstChild)return!1;this.transmitState="idle";var i=t.firstChild;if("body"!=i.nodeName,this.outboundQueue.length<1)return!1;var s=this.outboundQueue[0].rid;if(e==s)this.removeFromOutboundQueue(e),this.processResponse(i,e),this.processInboundQueue();else{var o=e-s;o<this.hold+2&&this.addToInboundQueue(t,e)}return t},processInboundQueue:function(){for(;this.inboundQueue.length>0;){var t=this.inboundQueue.shift();this.processDocument(t.doc,t.rid)}},addToInboundQueue:function(t,e){for(var i=0;i<this.inboundQueue.length;i++)e<this.inboundQueue[i].rid||this.inboundQueue.splice(i,0,{doc:t,rid:e})},processResponse:function(e,i){if("terminate"==e.getAttribute("type")){var s=e.firstChild.firstChild,o="";return"conflict"==s.nodeName&&(o="conflict"),void this.setState("Terminate",o)}if("Ready"!=this.state&&"Terminate"!=this.state){var r=e.getAttribute("sid");if(!r)throw new Error("No sid returned during xmpp session startup");this.sid=r,this.authId=e.getAttribute("authid"),""==this.authId&&this.authRetries--<1&&this.terminateSession(),this.wait=e.getAttribute("wait"),e.getAttribute("polling")&&(this.polling=1e3*parseInt(e.getAttribute("polling"))),this.inactivity=e.getAttribute("inactivity"),this.setState("Ready")}t.forEach(e.childNodes,function(t){this.processProtocolResponse(t,i)},this),"idle"==this.transmitState&&this.dispatchPacket()},processProtocolResponse:function(t,e){this.onProcessProtocolResponse(t);var i=t.nodeName+"-"+t.getAttribute("id"),s=this.deferredRequests[i];s&&(s.callback(t),delete this.deferredRequests[i])},setState:function(t,e){this.state!=t&&(this["on"+t]&&this["on"+t](t,this.state,e),this.state=t)},isTerminated:function(){return"Terminate"==this.state},processError:function(e,i,s){if(this.isTerminated())return!1;if(200!=i)return i>=400&&500>i?(this.setState("Terminate",r),!1):(this.removeFromOutboundQueue(s),setTimeout(t.hitch(this,function(){this.dispatchPacket()}),200),!0);if(e&&e.dojoType&&"timeout"==e.dojoType,this.removeFromOutboundQueue(s),e&&e.firstChild&&"terminate"==e.firstChild.getAttribute("type")){var o=e.firstChild.firstChild,r="";return o&&"conflict"==o.nodeName&&(r="conflict"),this.setState("Terminate",r),!1}return this.transmitState="error",setTimeout(t.hitch(this,function(){this.dispatchPacket()}),200),!0},onTerminate:function(t,e,i){},onProcessProtocolResponse:function(t){},onReady:function(t,e){}})});
define("dojox/xmpp/bosh",["dojo","dijit","dojox","dojo/require!dojo/io/script,dojo/io/iframe,dojox/xml/parser"],function(r,e,o){r.provide("dojox.xmpp.bosh"),r.require("dojo.io.script"),r.require("dojo.io.iframe"),r.require("dojox.xml.parser"),o.xmpp.bosh={transportIframes:[],initialize:function(e){this.transportIframes=[];for(var i=o._scopeName+".xmpp.bosh",t=r.connect(r.getObject(i),"_iframeOnload",this,function(o){0==o&&(e.load(),r.disconnect(t))}),a=0;a<e.iframes;a++){var n="xmpp-transport-"+a,d=r.byId("xmpp-transport-"+a);d&&(window[n]&&(window[n]=null),window.frames[n]&&(window.frames[n]=null),r.destroy(d)),d=r.io.iframe.create("xmpp-transport-"+a,i+"._iframeOnload("+a+");"),this.transportIframes.push(d)}},_iframeOnload:function(e){var o=r.io.iframe.doc(r.byId("xmpp-transport-"+e));o.write("<script>var isLoaded=true; var rid=0; var transmiting=false; function _BOSH_(msg) { transmiting=false; parent.dojox.xmpp.bosh.handle(msg, rid); } </script>")},findOpenIframe:function(){for(var r=0;r<this.transportIframes.length;r++){var e=this.transportIframes[r],o=e.contentWindow;if(o.isLoaded&&!o.transmiting)return e}return!1},handle:function(r,e){var i=this["rid"+e],t=o.xml.parser.parse(r,"text/xml");t?i.ioArgs.xmppMessage=t:i.errback(new Error("Received bad document from server: "+r))},get:function(e){var o=this.findOpenIframe(),i=r.io.iframe.doc(o);e.frameDoc=i;var t=this._makeScriptDeferred(e),a=t.ioArgs;return o.contentWindow.rid=a.rid,o.contentWindow.transmiting=!0,r._ioAddQueryToUrl(a),r._ioNotifyStart(t),r.io.script.attach(a.id,a.url,i),r._ioWatch(t,this._validCheck,this._ioCheck,this._resHandle),t},remove:function(e,o){r.destroy(r.byId(e,o)),this[e]&&delete this[e]},_makeScriptDeferred:function(e){var o=r._ioSetArgs(e,this._deferredCancel,this._deferredOk,this._deferredError),i=o.ioArgs;return i.id="rid"+e.rid,i.rid=e.rid,i.canDelete=!0,i.frameDoc=e.frameDoc,this[i.id]=o,o},_deferredCancel:function(r){r.canceled=!0,r.ioArgs.canDelete&&o.xmpp.bosh._addDeadScript(r.ioArgs)},_deferredOk:function(r){var e=r.ioArgs;return e.canDelete&&o.xmpp.bosh._addDeadScript(e),e.xmppMessage||e},_deferredError:function(r,e){return e.ioArgs.canDelete&&("timeout"==r.dojoType?o.xmpp.bosh.remove(e.ioArgs.id,e.ioArgs.frameDoc):o.xmpp.bosh._addDeadScript(e.ioArgs)),r},_deadScripts:[],_addDeadScript:function(r){o.xmpp.bosh._deadScripts.push({id:r.id,frameDoc:r.frameDoc}),r.frameDoc=null},_validCheck:function(r){var e=o.xmpp.bosh,i=e._deadScripts;if(i&&i.length>0){for(var t=0;t<i.length;t++)e.remove(i[t].id,i[t].frameDoc),i[t].frameDoc=null;o.xmpp.bosh._deadScripts=[]}return!0},_ioCheck:function(r){var e=r.ioArgs;return e.xmppMessage?!0:!1},_resHandle:function(r){o.xmpp.bosh._ioCheck(r)?r.callback(r):r.errback(new Error("inconceivable dojox.xmpp.bosh._resHandle error"))}}});
/**
* Mega pixel image rendering library for iOS6 Safari
*
* Fixes iOS6 Safari's image file rendering issue for large size image (over mega-pixel),
* which causes unexpected subsampling when drawing it in canvas.
* By using this library, you can safely render the image with proper stretching.
*
* Copyright (c) 2012 Shinichi Tomita <shinichi.tomita@gmail.com>
* Released under the MIT license
*/

!function(){function t(t){var e=t.naturalWidth,a=t.naturalHeight;if(e*a>1048576){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");return i.drawImage(t,-e+1,0),0===i.getImageData(0,0,1,1).data[3]}return!1}function e(t,e,a){var r=document.createElement("canvas");r.width=1,r.height=a;var i=r.getContext("2d");i.drawImage(t,0,0);for(var n=i.getImageData(0,0,1,a).data,o=0,s=a,c=a;c>o;){var h=n[4*(c-1)+3];0===h?s=c:o=c,c=s+o>>1}var d=c/a;return 0===d?1:d}function a(t,e,a){var i=document.createElement("canvas");return r(t,i,e,a),i.toDataURL("image/jpeg",e.quality||.8)}function r(a,r,n,o){var s=a.naturalWidth,c=a.naturalHeight,h=n.width,d=n.height,g=r.getContext("2d");g.save(),i(r,g,h,d,n.orientation);var l=t(a);l&&(s/=2,c/=2);var u=1024,m=document.createElement("canvas");m.width=m.height=u;for(var w=m.getContext("2d"),f=o?e(a,s,c):1,v=Math.ceil(u*h/s),b=Math.ceil(u*d/c/f),L=0,I=0;c>L;){for(var R=0,U=0;s>R;)w.clearRect(0,0,u,u),w.drawImage(a,-R,-L),g.drawImage(m,0,0,u,u,U,I,v,b),R+=u,U+=v;L+=u,I+=b}g.restore(),m=w=null}function i(t,e,a,r,i){switch(i){case 5:case 6:case 7:case 8:t.width=r,t.height=a;break;default:t.width=a,t.height=r}switch(i){case 2:e.translate(a,0),e.scale(-1,1);break;case 3:e.translate(a,r),e.rotate(Math.PI);break;case 4:e.translate(0,r),e.scale(1,-1);break;case 5:e.rotate(.5*Math.PI),e.scale(1,-1);break;case 6:e.rotate(.5*Math.PI),e.translate(0,-r);break;case 7:e.rotate(.5*Math.PI),e.translate(a,-r),e.scale(-1,1);break;case 8:e.rotate(-.5*Math.PI),e.translate(-a,0)}}function n(t){if(window.Blob&&t instanceof Blob){var e=new Image,a=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!a)throw Error("No createObjectURL function found to create blob url");e.src=a.createObjectURL(t),this.blob=t,t=e}if(!t.naturalWidth&&!t.naturalHeight){var r=this;t.onload=function(){var t=r.imageLoadListeners;if(t){r.imageLoadListeners=null;for(var e=0,a=t.length;a>e;e++)t[e]()}},this.imageLoadListeners=[]}this.srcImage=t}n.prototype.render=function(t,e){if(this.imageLoadListeners){var i=this;return void this.imageLoadListeners.push(function(){i.render(t,e)})}e=e||{};var n=this.srcImage.naturalWidth,o=this.srcImage.naturalHeight,s=e.width,c=e.height,h=e.maxWidth,d=e.maxHeight,g=!this.blob||"image/jpeg"===this.blob.type;s&&!c?c=o*s/n<<0:c&&!s?s=n*c/o<<0:(s=n,c=o),h&&s>h&&(s=h,c=o*s/n<<0),d&&c>d&&(c=d,s=n*c/o<<0);var l={width:s,height:c};for(var u in e)l[u]=e[u];var m=t.tagName.toLowerCase();"img"===m?t.src=a(this.srcImage,l,g):"canvas"===m&&r(this.srcImage,t,l,g),"function"==typeof this.onrender&&this.onrender(t)},"function"==typeof define&&define.amd?define("plugin/custom/MegaPixImage",[],function(){return n}):this.MegaPixImage=n}();
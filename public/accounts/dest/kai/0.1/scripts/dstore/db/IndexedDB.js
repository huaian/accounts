define("dstore/db/IndexedDB",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/promise/all","dstore/Store","dstore/SimpleQuery","dstore/QueryResults"],function(e,t,r,n,o,i,u,a){function c(e){var t=new r;return e.onsuccess=function(e){t.resolve(e.target.result)},e.onerror=function(){e.error.message=e.webkitErrorMessage,t.reject(e.error)},t.promise}function s(e,t,r){if(d||l.length){if(e&&(l.push({cursor:e,priority:t,retry:r}),l.sort(function(e,t){return e.priority>t.priority?1:-1})),d>=h)return;var n=l.pop();e=n&&n.cursor}if(e)try{e["continue"](),d++}catch(o){if("TransactionInactiveError"!==o.name&&0!==o.name||!n)throw o;n.retry()}}function f(){return!0}var l=[],h=1,d=0,v=window.IDBKeyRange||window.webkitIDBKeyRange;return e([i,u],{constructor:function(t){e.safeMixin(this,t);var r=this,n=this.dbConfig;this.indices=n.stores[this.storeName],this.cachedCount={};for(var o in r.indices){var i=r.indices[o];"number"==typeof i&&(r.indices[o]={preference:i})}if(this.db=this.db||n.db,!this.db){var u=n.openRequest;u||(u=n.openRequest=window.indexedDB.open(n.name||"dojo-db",parseInt(n.version,10)),u.onupgradeneeded=function(){var e=r.db=u.result;for(var t in n.stores){var o=n.stores[t];if(e.objectStoreNames.contains(t))a=u.transaction.objectStore(t);else var i=o.idProperty||"id",a=e.createObjectStore(t,{keyPath:i,autoIncrement:o[i]&&o[i].autoIncrement||!1});for(var c in o)a.indexNames.contains(c)||"autoIncrement"===c||o[c].indexed===!1||a.createIndex(c,c,o[c])}},n.db=c(u)),this.db=n.db.then(function(e){return r.db=e})}},idProperty:"id",storeName:"",indices:{},transaction:function(){var e=this;return this._currentTransaction=null,{abort:function(){e._currentTransaction.abort()},commit:function(){e._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){!this.db,this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var e=this;this._currentTransaction.oncomplete=function(){e._currentTransaction=null},this._currentTransaction.onerror=function(e){}}return this._currentTransaction},_callOnStore:function(e,t,r,o){var i=this;return n(this.db,function u(n){i.db.then&&(i.db=n);var a=i._currentTransaction;if(a)var s=!0;else a=i._getTransaction();var f,l;if(s)try{l=a.objectStore(i.storeName),r&&(l=l.index(r)),f=l[e].apply(l,t)}catch(h){if("TransactionInactiveError"===h.name||"InvalidStateError"===h.name)return i._currentTransaction=null,u();throw h}else l=a.objectStore(i.storeName),r&&(l=l.index(r)),f=l[e].apply(l,t);return o?f:c(f)})},get:function(e){var t=this;return this._callOnStore("get",[e]).then(function(e){return t._restore(e)})},getIdentity:function(e){return e[this.idProperty]},put:function(e,t){t=t||{},this.cachedCount={};var r=this;return this._callOnStore(t.overwrite===!1?"add":"put",[e]).then(function(e){return r._restore(e)})},add:function(e,t){return t=t||{},t.overwrite=!1,this.put(e,t)},remove:function(e){return this.cachedCount={},this._callOnStore("delete",[e])},fetch:function(){return this._fetch(f)},fetchRange:function(e){return this._fetch(f,e)},forEach:function(e,t){return this._fetch(function(r,n){e.call(t,r,n)})},_union:function(e,t,r){r=r||{};var i,u,c=r.start||0,s=r.end||1/0,f=e.sort,l=e.select,h=e.filter;f?(u={sort:f},i=this._createSortQuerier(u)):i=function(e){return e};var d,v=[],p=0,y=0,m=0,g=[],_={},b=[],w=this;return new a(n(h).then(function(r){return o(r.map(function(r,n){function o(e){u.push(e);for(var r=[],n=[];g.every(function(e){if(e.length>0){var t=e[0];return t&&n.push(t),r.push(t)}});){if(m>=s||0===n.length)return void(d=!0);var o=i(n)[0];if(g[r.indexOf(o)].shift(),m++>=c&&(b.push(o),!t(o)))return void(d=!0);r=[],n=[]}return!0}var u=g[n]=[],a=w._query({filterFunction:e.filterFunction,filter:r,sort:f},function(e){if(!d){var t=w.getIdentity(e);return y++,t in _?!0:(p++,_[t]=!0,o(e))}});return v[n]=a.totalLength,a.then(function(e){return o(null),e})}))}).then(function(){return l?l.querier(b):b}),{totalLength:{then:function(){return o(v).then(function(e){return e.reduce(function(e,t){return e+t})*p/(y||1)}).then.apply(this,arguments)}}})},_normalizeQuery:function(){function e(n){n.forEach(function o(n){if(i)throw new Error("Can not process conditions after a union, rearrange the query with the union last");var u=n.type,a=[].slice.call(n.args,0),c=a[0],l=a[1];if(l&&l.fetch&&!l.data)return void f.push(l.fetch().then(function(e){l.data=e,o(n)},function(e){}));if("or"===u)t(a);else if("and"===u)e(a);else if("eq"===u)r(c,l);else if("gt"===u||"gte"===u){var h=s[c]||(s[c]={});h.from=l,h.excludeFrom="gt"===u,r(c,h)}else if("lt"===u||"lte"===u){var h=s[c]||(s[c]={});h.to=l,h.excludeTo="lt"===u,r(c,h)}else if("in"===u)t((l.data||l).map(function(e){return{type:"eq",args:[c,e]}}));else if("contains"===u){var h=s[c]||(s[c]={});h.contains=l.data?l.data:l instanceof Array?l:[l],r(c,h)}else{if("match"!==u)throw new Error('Unsupported filter type "'+u+'"');if(l=l.source,"^"!==l[0]||l.match(/[\{\}\(\)\[\]\.\,\$\*]/))throw new Error("The match filter only supports simple prefix matching like /^starts with/");var h=s[c]||(s[c]={});l=l.slice(1),h.from=l,h.to=l+"~",r(c,h)}})}function t(t){i=t.map(function(t){return s={},e([t]),s})}function r(e,t){var r=!1;"boolean"!=typeof t&&(t&&(t.from||t.to?(r=!0,function(e,r){t.test=function(t){return!e||t>=e&&(!r||r>=t)},t.keyRange=e?r?v.bound(e,r,t.excludeFrom,t.excludeTo):v.lowerBound(e,t.excludeFrom):v.upperBound(r,t.excludeTo)}(t.from,t.to)):"object"==typeof t&&t.contains&&!function(e){var r,n=e[0];if("object"==typeof n&&"match"===n.type){if("^"===n.args[1].source[0]){var o=n.args[1].source.slice(1);r=v.bound(o,o+"~")}}else r=v.only(n);t.test=function(t){return e.every(function(e){if("object"==typeof e&&"match"===e.type){var r=e.args[1];return t.some(function(e){return!!r.test(e)})}return t&&t.indexOf(e)>-1})},t.keyRange=r}(t.contains)),s[e]=t)}var n,i,u,a,c,s={},f=[];return this.queryLog.forEach(function(t){var r=t.type,o=t.normalizedArguments;if("filter"===r){u=o;var i=n;n=i?function(e){return t.querier(i(e))}:t.querier,e(o,!0)}else"sort"===r?(a=o[0],a.querier=t.querier):"select"===r&&(c=t)}),n=n||function(e){return e},{filter:f.length>0?o(f).then(function(){return i}):i||s,filterFunction:n,filterOperator:u||null,sort:a,select:c}},_fetch:function(e,t){var r=this._normalizeQuery(),n=r.filter,o=this;return n instanceof Array||n.then?this._union(r,function(t){return e(o._restore(t)),!0},t):this._query(r,function(t){return e(o._restore(t)),!0},t)},_query:function(e,o,i){function u(e,t,r){x++;var n=g.indices[e];return n&&n.indexed!==!1&&(t=t||n.preference*(r||1)||.001,t>w)?(w=t,y=e,!0):void x++}function c(){function e(e){d--,O.reject(e),s()}n(g._callOnStore("openCursor",P,y,!0),function(t){d++,t.onsuccess=function(e){d--;var r=e.target.result;if(r){if(p)return r.advance(p),d++,void(p=!1);B.preFilterOffset++;try{var u=r.value;return i.join&&(u=i.join(u)),n(u,function(e){return T([e]).length>0&&(B.offset++,B.offset>=_&&(Q.push(e),!o(e,B.offset-_)||B.offset>=b-1))?(t.lastCursor=r,O.resolve(Q),void s()):s(r,i.priority,function(){p=B.preFilterOffset,c()})})}catch(a){O.reject(a)}}else(!_||B.offset>=_)&&(B.finished=!0),O.resolve(Q);s()},t.onerror=e},e)}i=i||{};var l,h,p,y,m,g=this,_=i.start||0,b=i.end||1/0,w=0,x=0,O=new r,j=O.promise,T=e.filterFunction,q=e.filter,S=e.sort,I=e.select;for(var F in q){var E=q[F];u(F,null,E&&(E.from||E.to)?.1:1)}var R,C=JSON.stringify(e.filterOperator)+"-"+JSON.stringify(S);if(S){var N=S[0];if(N.property===y||u(N.property,1))R=N.descending;else{var k=!0;_=0,b=1/0}}var P;y?(y in q?(m=q[y],l=m&&m.keyRange?m.keyRange:v.only(m),h=y):l=null,P=[l,R?"prev":"next"]):P=[];var B=g.cachedPosition;B&&B.queryId===C&&B.offset<_&&x>1?(p=B.preFilterOffset+1,g.cachedPosition=B=t.mixin({},B)):(B=g.cachedPosition={offset:-1,preFilterOffset:-1,queryId:C},2>x&&(B.offset=B.preFilterOffset=(p=_)-1));var D={then:function(e,t){function n(e){return g.cachedCount[C]=e,Math.round((B.offset+1.01)/(B.preFilterOffset+1.01)*e)}var o=g.cachedCount[C];if(o)return e(n(o));if(B.finished){var i=new r;return i.resolve(B.offset+1),i.then(e)}var u=l?g._callOnStore("count",[l],y):g._callOnStore("count");return u.then(n).then(e,t)}},Q=[];if(c(),k){var L=o;o=f;var j=j.then(function(e){var t=i.start||0,r=i.end||1/0,n=S.querier(e).slice(t,r);return n.forEach(L),n})}return I&&(j=j.then(function(e){return I.querier(e)})),new a(j,{totalLength:D})}})});
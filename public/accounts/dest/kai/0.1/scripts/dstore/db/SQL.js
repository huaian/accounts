define("dstore/db/SQL",["dojo/_base/declare","dojo/Deferred","dojo/when","dstore/QueryResults","dstore/Store","dstore/SimpleQuery","dojo/_base/lang","dojo/promise/all"],function(e,t,r,i,n,s,a,o){function u(e){if(e.match(/[^\w_\.]/))throw new URIError("Illegal column name "+e);return e}function h(e,t){for(var r=t.split("."),i=r.length,n=0;i>n;n++)e=e&&e[r[n]];return e}function c(e){return e.replace(/\./g,"_dot_")}function l(e){return e&&e.__extra?a.mixin(e,JSON.parse(e.__extra)):e}var d={and:" AND ",or:" OR ",eq:"=",ne:"!=",lte:"<=",gte:">=",lt:"<",gt:">"};return e([n,s],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var r=this.indexPrefix=e.indexPrefix||"idx_",i=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var n=[];this.indices=t.stores[i],this.repeatingIndices={};for(var s in this.indices)this.indices[s].multiEntry&&(this.repeatingIndices[s]=!0);if(!t.available){for(var i in t.stores){var a=t.stores[i],u=i.replace(/[^\w]/g,"_"),h=a[this.idProperty],l=["__extra",this.idProperty+" "+(h&&h.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],d=[this.idProperty];for(var s in a)s!=this.idProperty&&l.push(c(s));n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+u+" ("+l.join(",")+")"));for(var s in a)if(s!=this.idProperty)if(a[s].multiEntry){d.push(s);var f=u+"_repeating_"+c(s);n.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+f+" (id,value)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+f+"_id ON "+f+"(id)")),n.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+f+"_value ON "+f+"(value)"))}else n.push(this.executeSql("ALTER TABLE "+u+" ADD "+c(s)).then(null,function(){})),a[s].indexed!==!1&&n.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+r+u+"_"+c(s)+" ON "+u+"("+c(s)+")"))}t.available=o(n)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){var t=this;return r(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?t._restore(l(e.rows.item(0))):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e){function t(e,t,r){l.repeatingIndices[r||e]?u.push(function(r){return o(t.map(function(t){return l.executeSql("INSERT INTO "+l.table+"_repeating_"+e+" (value, id) VALUES (?, ?)",[t,r])}))}):(s.push(e),n.push("?"),i.push(t))}var i=[],n=[],s=[],a={},u=[],l=this;for(var d in e)e.hasOwnProperty(d)&&(d in this.indices||d==this.idProperty?t(d,e[d]):a[d]=e[d]);for(var d in this.indices)d.indexOf(".")>-1&&t(c(d),h(e,d),d);s.push("__extra"),n.push("?"),i.push(JSON.stringify(a));var f=this.idProperty;this.identifyGeneratedKey&&(i.idColumn=f);var p="INSERT INTO "+this.table+" ("+s.join(",")+") VALUES ("+n.join(",")+")";return r(this.executeSql(p,i),function(t){var r=l.indices[f];if(r&&r.autoIncrement){var i=t.insertId;e[f]=i}else i=e[f];return o(u.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){function i(e,t,r){if(a.repeatingIndices[r||e]){a.executeSql("DELETE FROM "+a.table+"_repeating_"+e+" WHERE id=?",[n]);for(var i=0;i<t.length;i++)a.executeSql("INSERT INTO "+a.table+"_repeating_"+e+" (value, id) VALUES (?, ?)",[t[i],n])}else l.push(e+"=?"),u.push(t)}t=t||{};var n=t.id||e[this.idProperty],s=t.overwrite;if(void 0===s){var a=this;return this.get(n).then(function(r){return(t.overwrite=!!r)?(t.overwrite=!0,a.put(e,t)):a.add(e,t)})}if(!s)return a.add(e,t);var o="UPDATE "+this.table+" SET ",u=[],l=[],d={},a=this;for(var f in e)e.hasOwnProperty(f)&&(f in this.indices||f==this.idProperty?i(f,e[f]):d[f]=e[f]);for(var f in this.indices)f.indexOf(".")>-1&&i(c(f),h(e,f),f);return l.push("__extra=?"),u.push(JSON.stringify(d)),o+=l.join(",")+" WHERE "+this.idProperty+"=?",u.push(e[this.idProperty]),r(this.executeSql(o,u),function(){return n})},fetchRange:function(e){return this.fetch(e)},generateSql:function(){function e(e){return u(e),h+"."+c(e)}function t(r){var i=r.args,n=i[0],s=i[1];switch(r.type){case"eq":case"ne":case"lt":case"lte":case"gt":case"gte":return l.push(s),[e(n),d[r.type]+"?"];case"and":case"or":for(var a=[],u=0;u<i.length;u++)a.push(t(i[u]).join(""));return["(",a.join(d[r.type]),")"];case"in":if(0===s.length)return"0=1";if(s.generateSql){var c=s.generateSql();return l.push.apply(l,c.params),[e(n)," IN ("+c.select+c.from+")"]}return[e(n)," IN ("+i[1].map(function(e){return l.push(e),"?"}).join(",")+")"];case"contains":var f=h+"_repeating_"+n;return["(",s.map(function(r){var i;return r&&r.type?i="value "+t(r).slice(1).join(""):(l.push(r),i="value=?"),e(o.idProperty)+" IN (SELECT id FROM "+f+" WHERE "+i+")"}).join(" AND "),")"];case"match":if(s=s.source,"^"!==s[0]||s.match(/[\{\}\(\)\[\]\.\,\$\*]/))throw new Error("The match filter only supports simple prefix matching like /^starts with/");return[h+"."+n," LIKE '"+s.slice(1).replace(/'/g,"''")+"%'"];default:throw new URIError("Invalid query syntax, "+r.type+" not implemented")}}var r,i="FROM "+this.table,n="",s="",a="*",o=this,h=this.table,l=[];return this.queryLog.forEach(function(i){if("filter"===i.type)n=(n?" AND ":"")+t(i.normalizedArguments[0]).join("");else if("sort"===i.type)s=" ORDER BY "+i.normalizedArguments[0].map(function(t){return e(t.property)+" "+(t.descending?"desc":"asc")}).join(",");else if("select"===i.type){var u=i.normalizedArguments[0];if(u instanceof Array){for(var h=0;h<u.length;h++)if(!(u[h]in o.indices))return void(r=i);a=u.map(e).join(", ")}else u in o.indices&&(a=e(u)),r=i}}),n&&(n=" WHERE "+n),{select:"SELECT "+a+" ",from:i+n+s,params:l,querier:r&&r.querier}},fetch:function(e){e=e||{};var t=this.generateSql(),r=t.select,n=t.from,s=t.params,o=t.querier,u=r+" "+n;e.end&&(u+=" LIMIT "+(e.end-(e.start||0))),e.start&&(u+=" OFFSET "+e.start);var h=this,c=a.delegate(this.executeSql(u,s).then(function(e){for(var t=[],r=0;r<e.rows.length;r++)t.push(h._restore(l(e.rows.item(r))));return o&&(t=o(t)),t})),h=this;return new i(c,{totalLength:{then:function(e,t){return h.executeSql("SELECT COUNT(*) "+n,s).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}}})},executeSql:function(e,r){var i,n,s=new t;if(this.database.transaction(function(t){t.executeSql(e,r,function(e,t){s.resolve(i=t)},function(e,t){s.reject(n=t)})}),i)return i;if(n)throw n;return s.promise}})});
define("dstore/Cache",["dojo/_base/array","dojo/when","dojo/_base/declare","dojo/_base/lang","./Store","./Memory","./QueryResults"],function(t,e,n,i,r,c,a){function h(t){return function(){var e=this.inherited(arguments),n=this.cachingCollection||this.cachingStore;return e.cachingCollection=n[t].apply(n,arguments),e.isValidFetchCache=this.canCacheQuery===!0||this.canCacheQuery(t,arguments),e}}function o(t){t.cachingStore||(t.cachingStore=new c),t.cachingStore.Model=t.Model,t.cachingStore.idProperty=t.idProperty}var u={cachingStore:null,constructor:function(){o(this)},canCacheQuery:function(t,e){return!1},isAvailableInCache:function(){return this.isValidFetchCache&&(this.allLoaded||this.fetchRequest)||this._parent&&this._parent.isAvailableInCache()},fetch:function(){return this._fetch(arguments)},fetchRange:function(){return this._fetch(arguments,!0)},_fetch:function(n,i){var r=this.cachingStore,c=this.cachingCollection||r,h=this,o=this.isAvailableInCache();if(o)return new a(e(o,function(){return h.isAvailableInCache()?i?c.fetchRange(n[0]):c.fetch():h.inherited(n)}));var u=this.fetchRequest=this.inherited(n);return e(u,function(e){var n=!i;return h.fetchRequest=null,t.forEach(e,function(t){!h.isLoaded||h.isLoaded(t)?r.put(t):n=!1}),n&&(h.allLoaded=!0),e}),u},isValidFetchCache:!1,get:function(t,n){var i=this.cachingStore,r=this.getInherited(arguments),c=this;return e(this.fetchRequest,function(){return e(i.get(t),function(a){return void 0!==a?a:r?e(r.call(c,t,n),function(e){return e&&i.put(e,{id:t}),e}):void 0})})},add:function(t,n){var i=this.cachingStore;return e(this.inherited(arguments),function(e){var r=i.put(t&&"object"==typeof e?e:t,n);return e||r})},put:function(t,n){var i=this.cachingStore;return i.remove(n&&n.id||this.getIdentity(t)),e(this.inherited(arguments),function(e){var r=i.put(t&&"object"==typeof e?e:t,n);return e||r})},remove:function(t,n){var i=this.cachingStore;return e(this.inherited(arguments),function(r){return e(i.remove(t,n),function(){return r})})},evict:function(t){return this.allLoaded=!1,this.cachingStore.remove(t)},invalidate:function(){this.allLoaded=!1},_createSubCollection:function(){var t=this.inherited(arguments);return t._parent=this,t},sort:h("sort"),filter:h("filter"),_getQuerierFactory:function(t){var e=this.cachingStore;return this.inherited(arguments)||i.hitch(e,e._getQuerierFactory(t))}},s=n(null,u);return s.create=function(t,e){return t=n.safeMixin(i.delegate(t),u),n.safeMixin(t,e),o(t),t},s});
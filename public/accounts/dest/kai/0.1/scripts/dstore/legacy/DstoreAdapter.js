define("dstore/legacy/DstoreAdapter",["dojo/_base/declare","dojo/_base/array","dojo/store/util/QueryResults"],function(t,e,r){function n(t){return t}var o=null,i={store:null,constructor:function(t){this.store=t,(t._getQuerierFactory("filter")||t._getQuerierFactory("sort"))&&(this.queryEngine=function(r,o){o=o||{};var i=t._getQuerierFactory("filter"),a=i?i(r):n,u=t._getQuerierFactory("sort"),c=n;u&&(c=u(e.map(o.sort,function(t){return{property:t.attribute,descending:t.descending}})));var d=n;return isNaN(o.start)&&isNaN(o.count)||(d=function(t){var e=o.start||0,r=o.count||1/0,n=t.slice(e,e+r);return n.total=t.length,n}),function(t){return d(c(a(t)))}});var r=this;t.on("add,update,delete",function(e){var n=e.type,o=e.target;r.notify("add"===n||"update"===n?o:void 0,"delete"===n||"update"===n?"id"in e?e.id:t.getIdentity(o):void 0)})},query:function(t,e){e=e||{};var n,o,i,a=this.store.filter(t),u=e.sort;if(u)if("[object Array]"===Object.prototype.toString.call(u))for(var c;c=u.pop();)a=a.sort(c.attribute,c.descending);else a=a.sort(u);if(a.track&&!a.tracking&&(a=a.track(),o=!0),"start"in e){var d=e.start||0;n=a[a.fetchRangeSync?"fetchRangeSync":"fetchRange"]({start:d,end:e.count?d+e.count:1/0})}return n=n||a[a.fetchSync?"fetchSync":"fetch"](),i=n.totalLength,n=new r(n),n.total=i,n.observe=function(t,e){function r(t){return void 0===t&&o?-1:t}var n=a.on("add",function(e){t(e.target,-1,r(e.index))}),i=a.on("update",function(n){(e||n.previousIndex!==n.index||!isFinite(n.index))&&t(n.target,r(n.previousIndex),r(n.index))}),u=a.on("delete",function(e){t(e.target,r(e.previousIndex),-1)}),c={remove:function(){n.remove(),i.remove(),u.remove()}};return c.cancel=c.remove,c},n},notify:function(){}},a=["get","put","add","remove","getIdentity"];return e.forEach(a,function(t){i[t]=function(){var e=this.store;return(e[t+"Sync"]||e[t]).apply(e,arguments)}}),t(o,i)});
define("dstore/Request",["dojo/request","dojo/_base/lang","dojo/_base/array","dojo/json","dojo/_base/declare","./Store","./QueryResults"],function(e,r,t,n,a,s,i){var o=[].push;return a(s,{constructor:function(){this.headers||(this.headers={}),this._targetContainsQueryString=this.target.lastIndexOf("?")>=0},headers:{},parse:n.parse,target:"",ascendingPrefix:"+",descendingPrefix:"-",accepts:"application/json",fetch:function(e){var r=this._request(e);return new i(r.data,{response:r.response})},fetchRange:function(e){var t=e.start,n=e.end,a={};this.useRangeHeaders?a.headers=r.mixin(this._renderRangeHeaders(t,n),e.headers):(a.queryParams=this._renderRangeParams(t,n),e.headers&&(a.headers=e.headers));var s=this._request(a);return new i(s.data,{totalLength:s.total,response:s.response})},_request:function(t){t=t||{};var n=r.delegate(this.headers,{Accept:this.accepts});"headers"in t&&r.mixin(n,t.headers);var a=this._renderUrl(t.queryParams),s=e(a,{method:"GET",headers:n}),i=this,o=s.then(function(e){return i.parse(e)});return{data:o.then(function(e){for(var r=e.items||e,t=0,n=r.length;n>t;t++)r[t]=i._restore(r[t],!0);return r}),total:o.then(function(e){var r=e.total;return r>-1?r:s.response.then(function(e){var r=e.getHeader("Content-Range");return r&&(r=r.match(/\/(.*)/))&&+r[1]})}),response:s.response}},_renderFilterParams:function(e){var r=e.type,n=e.args;if(!r)return[""];if("string"===r)return[n[0]];if("and"===r||"or"===r)return[t.map(e.args,function(e){var t=this._renderFilterParams(e);return"and"!==e.type&&"or"!==e.type||e.type===r?t:"("+t+")"},this).join("and"===r?"&":"|")];var a=n[1];return a&&(a._renderUrl?a="("+a._renderUrl()+")":a instanceof Array&&(a="("+a+")")),[encodeURIComponent(n[0])+"="+("eq"===r?"":r+"=")+encodeURIComponent(a)]},_renderSortParams:function(e){var r=t.map(e,function(e){var r=e.descending?this.descendingPrefix:this.ascendingPrefix;return r+encodeURIComponent(e.property)},this),n=[];return r&&n.push(this.sortParam?encodeURIComponent(this.sortParam)+"="+r:"sort("+r+")"),n},_renderRangeParams:function(e,r){var t=[];return this.rangeStartParam?t.push(this.rangeStartParam+"="+e,this.rangeCountParam+"="+(r-e)):t.push("limit("+(r-e)+(e?","+e:"")+")"),t},_renderSelectParams:function(e){var r=[];return this.selectParam?r.push(this.selectParam+"="+e):r.push("select("+e+")"),r},_renderQueryParams:function(){var e=[];return t.forEach(this.queryLog,function(r){var t=r.type,n="_render"+t[0].toUpperCase()+t.substr(1)+"Params";this[n]&&o.apply(e,this[n].apply(this,r.normalizedArguments))},this),e},_renderUrl:function(e){var r=this._renderQueryParams(),t=this.target;return e&&o.apply(r,e),r.length>0&&(t+=(this._targetContainsQueryString?"&":"?")+r.join("&")),t},_renderRangeHeaders:function(e,r){var t="items="+e+"-"+(r-1);return{Range:t,"X-Range":t}}})});
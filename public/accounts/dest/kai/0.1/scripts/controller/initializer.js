define("controller/initializer",["dojo/io-query","3rdlibs/backbone","cutil/c.util.kai","3rdlibs/state-machine","module","dojo/Deferred"],function(e,i,t,a,n,o){var r={Routers:{Main:null},routers:null,viewCollection:[],isH5:!0,env:"",viewCollectionData:[],ViewCollection:null,ViewModel:null};r.ViewStateModel=i.Model.extend({defauts:{viewName:null,current:null},idAttribute:"viewName"}),r.ViewStateCollection=i.Collection.extend({model:r.ViewModel,comparator:"lastVisitTime",modelId:function(e){return e.viewName}}),r.ViewModel=i.Model.extend({defauts:{hidden:!0,createTime:new Date,lastVisitTime:new Date},idAttribute:"viewName",hideChildren:function(){var e=this;_.each(r.viewCollection.models,function(i){_.contains(e.childViewNames,i.get("viewName"))&&i.set("hidden",!0)})},initialize:function(){this.childViewNames=_.pluck(_.where(r.viewCollectionData,{parent:this.get("viewName")}),"id"),this.on("change:hidden",function(){this.get("hidden")?(this.get("viewInstance")&&this.get("viewInstance").hide(),this.hideChildren()):this.get("viewInstance")&&this.get("viewInstance").show()})}}),r.ViewCollection=i.Collection.extend({model:r.ViewModel,comparator:"lastVisitTime",modelId:function(e){return e.viewName}}),r.viewStateCollection=new r.ViewStateCollection,r.viewCollection=new r.ViewCollection,r.viewCollection.loadingViews=[];var l="new",d=[{name:"startInitializing",from:"new",to:"initializing"},{name:"finishInitializing",from:"initializing",to:"initialized"},{name:"startPreheating",from:"initialized",to:"preheating"},{name:"finishPreheating",from:"preheating",to:"preheated"},{name:"startShowing",from:"preheated",to:"showing"},{name:"finishShowing",from:"showing",to:"shown"},{name:"startAsyncRendering",from:"shown",to:"dataPreparing"},{name:"finishAsyncRendering",from:"dataPreparing",to:"dataPrepared"},{name:"startParsing",from:"dataPrepared",to:"templateParsing"},{name:"finishParsing",from:"templateParsing",to:"templateParsed"},{name:"startParsing",from:"templateParsed",to:"templateParsing"},{name:"startDojoParsing",from:"templateParsed",to:"dojoParsing"},{name:"finishDojoParsing",from:"dojoParsing",to:"dojoParsed"},{name:"startStartuping",from:"shown",to:"loading"},{name:"startStartuping",from:"dojoParsed",to:"loading"},{name:"finishStartuping",from:"loading",to:"loaded"},{name:"startParsing",from:"loaded",to:"templateParsing"},{name:"startShowing",from:"loaded",to:"showing"},{name:"destroy",from:"initializing",to:"new"},{name:"destroy",from:"initialized",to:"new"},{name:"destroy",from:"preheating",to:"new"},{name:"destroy",from:"preheated",to:"new"},{name:"destroy",from:"dataPreparing",to:"new"},{name:"destroy",from:"dataPrepared",to:"new"},{name:"destroy",from:"templateParsing",to:"new"},{name:"destroy",from:"templateParsed",to:"new"},{name:"destroy",from:"dojoParsing",to:"new"},{name:"destroy",from:"dojoParsed",to:"new"},{name:"destroy",from:"loading",to:"new"},{name:"destroy",from:"loaded",to:"new"},{name:"destroy",from:"dataPreparing",to:"new"},{name:"destroy",from:"dataPrepared",to:"new"},{name:"destroy",from:"new",to:"new"},{name:"reload",from:"initializing",to:"initialized"},{name:"reload",from:"initialized",to:"initialized"},{name:"reload",from:"preheating",to:"initialized"},{name:"reload",from:"preheated",to:"initialized"},{name:"reload",from:"dataPreparing",to:"initialized"},{name:"reload",from:"dataPrepared",to:"initialized"},{name:"reload",from:"templateParsing",to:"initialized"},{name:"reload",from:"templateParsed",to:"initialized"},{name:"reload",from:"dojoParsing",to:"initialized"},{name:"reload",from:"dojoParsed",to:"initialized"},{name:"reload",from:"loading",to:"initialized"},{name:"reload",from:"loaded",to:"initialized"},{name:"reload",from:"new",to:"initialized"},{name:"reload",from:"dataPreparing",to:"initialized"},{name:"reload",from:"dataPrepared",to:"initialized"},{name:"dojoParse",from:"loaded",to:"dojoParsing"}],s={lastView:null,lastViewModel:null,create:function(e,i){var a=new Date;if($('[data-viewname="'+e+'"]').length>0){var n=$('[data-viewname="'+e+'"]');return n.needReplaceTemplate=!1,n.parsed=!1,n.isEmbeded=!0,n.isViewDataAsync=!0,n.isViewDataAsync=!0,n.createTime=a,n}if(i.isSubViewInitialize||!t.isH5&&!t.enableRoute&&e.indexOf("index")<0&&location.hash.indexOf(e)<0&&e.indexOf("login")<0)return!1;var o="sub_viewport_"+a.valueOf(),r=$("<div>",{"class":"sub_viewport","data-subView_port_Id":o,"data-viewname":e,"data-subview_url":location.href,id:o,"data-createtime":a});return r.createTime=a,$(".main-viewport").prepend(r),r},set:function(e,i){this.attr=i},get:function(e){return this[e]},getViewportNodeByName:function(e){return $('[data-viewname="'+e+'"]')}},m=["SpringGreen","Tan","Teal"],w=function(e,i){var a=e.id,n=e.get("viewInstance");if(_.isObject(n)&&i&&_.isObject(i)&&i.modelObj&&(n.modelObj=i.modelObj),!(e&&e.get("fsm")&&e.get("fsm").can("startShowing"))){e.get("viewInstance");return e.get("viewInstance")&&(e.get("viewInstance").hideLoading(),i&&i.forceNewCreate?(e.get("viewInstance").destroy(),t.forward(e.get("viewName"),i)):(e.get("viewInstance").destroySubViews(),e.get("viewInstance").reload())),!1}e.set("lastVisitTime",-new Date),r.lastView=a,r.lastViewModel=e,i&&_.isBoolean(i.isReload)?n.reload():(e.unset("hidden",{silent:!0}),e.set("hidden",!1))},c=function(e,i){r.viewCollection.loadingViews.push(e);var t,n,o=_.findWhere(r.viewCollectionData,{id:e});t=i.requireViewName||e,o.useModule?(n=t+"/template/template",t+="/view"):n=o.templatePath||t.replace("view","template");var m=[];m=o.hasTemplate!==!1||o.templatePath?[t,"dojo/text!"+n+".html"]:[t],require(m,function(t,n){var m=s.create(e,i);if(!m)return r.viewCollection.loadingViews.pop(e),!1;var w=!0,c=!1,u=!1,f=!0,g=m.createTime,v=_.where(r.viewCollectionData,{parent:e}),h={};_.isObject(i.currentViewAttributes)&&i.currentViewAttributes.parent&&(h=_.findWhere(r.viewCollectionData,{id:i.currentViewAttributes.parent}));var p=a.create({initial:l,events:d});if(m.needReplaceTemplate===!1&&(w=!1),m.isEmbeded===!0&&(c=!0),_.isBoolean(m.parsed)&&(u=m.parsed),_.isBoolean(m.isViewDataAsync)&&(f=m.isViewDataAsync),!_.isFunction(t))return!1;try{var V=new t(_.extend({el:m,viewName:e,templateString:n,isH5:r.isH5,needReplaceTemplate:w,isEmbeded:c,isViewDataAsync:f,parsed:u,logColor:i.logColor,childViewItems:v,parentViewItem:h,viewItem:o,siblingViewNames:i.siblingViewNames,fsm:p,modelObj:i&&i.modelObj},i||{}))}catch(C){r.viewCollection.loadingViews=_.reject(r.viewCollection.loadingViews,function(i){return i==e})}var P=new r.ViewModel(_.extend({viewName:e,viewInstance:V,isH5:r.isH5,hidden:!1,childViews:[],childViewItems:v,createTime:g,lastVisitTime:-new Date,fsm:p},i||{}));return r.viewCollection.add(P),r.viewCollection.loadingViews=_.reject(r.viewCollection.loadingViews,function(i){return i==e}),r.lastViewModel=P,r.lastView=e,!0})},u=function(i,t){var a=_.sample(m,1)+"",n=null,o=null,l=r.routers&&r.routers.routes[i];if(!_.isString(l))return!1;var d=_.find(r.viewCollectionData,function(e){return e.id==l?!0:void 0});if(!_.isObject(d))return!1;var s=_.pluck(_.where(r.viewCollectionData,{parent:d.parent}),"id");return s=_.reject(s,function(e){return e==l}),_.each(r.viewCollection.models,function(e){_.contains(s,e.get("viewName"))&&(e.unset("hidden",{silent:!0}),e.set("hidden",!0))}),d.redirectView&&(o=d.redirectView),n=r.viewCollection.findWhere({viewName:l}),_.isObject(r.lastViewModel)?_.contains(r.lastViewModel.get("childViews"),l)&&_.noop:_.noop,_.contains(r.viewCollection.loadingViews||[],l)?!1:_.isObject(n)?(w(n,t),!0):(_.isString(t)&&(t=e.queryToObject(t)),c(l,_.extend(t||{},{requireViewName:o,logColor:a,currentViewAttributes:d,siblingViewNames:s,modelObj:t&&t.modelObj})),!0)};t.forward=function(e,i){var t=new o,i=i||{};return i.keepURL?u(e,i):r.routers.navigate(e,{trigger:i.trigger||!0,replace:i.replace||!1}),t},t.views=r.viewCollection,t._store.setData(t.views),t.viewStates=r.viewStateCollection,t.viewportManager=s;var f={start:function(e,a){var o=function(e){_.each(e,function(e){var i=new r.ViewModel(_.extend({viewName:e.id,current:null},{}));r.viewStateCollection.add(i)})};if(r.viewCollectionData=a.viewCollectionData,o(r.viewCollectionData),t.viewCollectionData=r.viewCollectionData,t._store.setData(r.viewCollectionData),r.Routers.Main=i.Router.extend({routes:e,execute:function(e,i,t){i.unshift(t),e&&e.apply(this,i)}}),r.routers=new r.Routers.Main,t=_.extend(t,n.config()),t.isH5||t.enableRoute)for(var l in r.routers.routes)r.routers.route(l,l,u);else r.routers.route("","",u);i.history.start({pushState:!1,silent:!1}),$("#loading-hint").hide(),$('link[rel~="icon"]').attr("href","./app/"+t.projectName+"/favicon.ico")}};return f});
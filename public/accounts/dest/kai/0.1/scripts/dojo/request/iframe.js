define("dojo/request/iframe",["module","require","./watch","./util","./handlers","../_base/lang","../io-query","../query","../has","../dom","../dom-construct","../_base/window","../NodeList-dom"],function(e,t,r,o,n,a,i,l,d,u,c,m){function s(e,r,o){if(m.global[e])return m.global[e];if(m.global.frames[e])return m.global.frames[e];o||(d("config-useXDomain")&&!d("config-dojoBlankHtmlUrl"),o=d("config-dojoBlankHtmlUrl")||t.toUrl("dojo/resources/blank.html"));var n=c.place('<iframe id="'+e+'" name="'+e+'" src="'+o+'" onload="'+r+'" style="position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden">',m.body());return m.global[e]=n,n}function f(e,t,r){var o=m.global.frames[e.name];o.contentWindow&&(o=o.contentWindow);try{r?o.location.replace(t):o.location=t}catch(n){}}function h(e){if(e.contentDocument)return e.contentDocument;var t=e.name;if(t){var r=m.doc.getElementsByTagName("iframe");if(e.document&&r[t].contentWindow&&r[t].contentWindow.document)return r[t].contentWindow.document;if(m.doc.frames[t]&&m.doc.frames[t].document)return m.doc.frames[t].document}return null}function _(){return c.create("form",{name:N+"_form",style:{position:"absolute",top:"-1000px",left:"-1000px"}},m.body())}function g(){var e;try{if(x._currentDfd||!x._dfdQueue.length)return;do e=x._currentDfd=x._dfdQueue.shift();while(e&&(e.canceled||e.isCanceled&&e.isCanceled())&&x._dfdQueue.length);if(!e||e.canceled||e.isCanceled&&e.isCanceled())return void(x._currentDfd=null);var t,r=e.response,n=r.options,l=e._contentToClean=[],d=u.byId(n.form),s=o.notify,f=n.data||null;if(e._legacy||"POST"!==n.method||d?"GET"===n.method&&d&&r.url.indexOf("?")>-1&&(t=r.url.slice(r.url.indexOf("?")+1),f=a.mixin(i.queryToObject(t),f)):d=e._tmpForm=_(),d){if(!e._legacy){var h=d;do h=h.parentNode;while(h&&h!==m.doc.documentElement);h||(d.style.position="absolute",d.style.left="-1000px",d.style.top="-1000px",m.body().appendChild(d)),d.name||(d.name=N+"_form")}if(f){var g=function(e,t){c.create("input",{type:"hidden",name:e,value:t},d),l.push(e)};for(var p in f){var v=f[p];if(a.isArray(v)&&v.length>1)for(var b=0;b<v.length;b++)g(p,v[b]);else d[p]?d[p].value=v:g(p,v)}}var y=d.getAttributeNode("action"),T=d.getAttributeNode("method"),A=d.getAttributeNode("target");r.url&&(e._originalAction=y?y.value:null,y?y.value=r.url:d.setAttribute("action",r.url)),e._legacy?T&&T.value||(T?T.value=n.method:d.setAttribute("method",n.method)):(e._originalMethod=T?T.value:null,T?T.value=n.method:d.setAttribute("method",n.method)),e._originalTarget=A?A.value:null,A?A.value=x._iframeName:d.setAttribute("target",x._iframeName),d.target=x._iframeName,s&&s.emit("send",r,e.promise.cancel),x._notifyStart(r),d.submit()}else{var w="";r.options.data&&(w=r.options.data,"string"!=typeof w&&(w=i.objectToQuery(w)));var q=r.url+(r.url.indexOf("?")>-1?"&":"?")+w;s&&s.emit("send",r,e.promise.cancel),x._notifyStart(r),x.setSrc(x._frame,q,!0)}}catch(j){e.reject(j)}}function p(e){return!this.isFulfilled()}function v(e){return!!this._finished}function b(e,t){if(!t)try{var r=e.options,o=x.doc(x._frame),i=r.handleAs;if("html"!==i){if("xml"===i)if("html"===o.documentElement.tagName.toLowerCase()){l("a",o.documentElement).orphan();var d=o.documentElement.innerText;d=d.replace(/>\s+</g,"><"),e.text=a.trim(d)}else e.data=o;else e.text=o.getElementsByTagName("textarea")[0].value;n(e)}else e.data=o}catch(u){t=u}t?this.reject(t):this._finished?this.resolve(e):this.reject(new Error("Invalid dojo/request/iframe request state"))}function y(e){this._callNext()}function x(e,t,n){var a=o.parseArgs(e,o.deepCreate(A,t),!0);if(e=a.url,t=a.options,"GET"!==t.method&&"POST"!==t.method)throw new Error(t.method+" not supported by dojo/request/iframe");x._frame||(x._frame=x.create(x._iframeName,T+"();"));var i=o.deferred(a,null,p,v,b,y);return i._callNext=function(){this._calledNext||(this._calledNext=!0,x._currentDfd=null,x._fireNextRequest())},i._legacy=n,x._dfdQueue.push(i),x._fireNextRequest(),r(i),n?i:i.promise}var N=e.id.replace(/[\/\.\-]/g,"_"),T=N+"_onload";m.global[T]||(m.global[T]=function(){var e=x._currentDfd;if(!e)return void x._fireNextRequest();var t=e.response,r=t.options,o=u.byId(r.form)||e._tmpForm;if(o){for(var n=e._contentToClean,a=0;a<n.length;a++)for(var i=n[a],l=0;l<o.childNodes.length;l++){var d=o.childNodes[l];if(d.name===i){c.destroy(d);break}}e._originalAction&&o.setAttribute("action",e._originalAction),e._originalMethod&&(o.setAttribute("method",e._originalMethod),o.method=e._originalMethod),e._originalTarget&&(o.setAttribute("target",e._originalTarget),o.target=e._originalTarget)}e._tmpForm&&(c.destroy(e._tmpForm),delete e._tmpForm),e._finished=!0});var A={method:"POST"};return x.create=s,x.doc=h,x.setSrc=f,x._iframeName=N+"_IoIframe",x._notifyStart=function(){},x._dfdQueue=[],x._currentDfd=null,x._fireNextRequest=g,o.addCommonMethods(x,["GET","POST"]),x});
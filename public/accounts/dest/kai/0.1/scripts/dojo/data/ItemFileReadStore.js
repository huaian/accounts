define("dojo/data/ItemFileReadStore",["../_base/kernel","../_base/lang","../_base/declare","../_base/array","../_base/xhr","../Evented","./util/filter","./util/simpleFetch","../date/stamp"],function(t,e,r,s,i,a,l,n,o){var h=r("dojo.data.ItemFileReadStore",[a],{constructor:function(t){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=t.url,this._ccUrl=t.url,this.url=t.url,this._jsonData=t.data,this.data=null,this._datatypeMap=t.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(t){return o.fromISOString(t)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._reverseRefMap="_RRM",this._loadInProgress=!1,this._queuedFetches=[],void 0!==t.urlPreventCache&&(this.urlPreventCache=t.urlPreventCache?!0:!1),void 0!==t.hierarchical&&(this.hierarchical=t.hierarchical?!0:!1),t.clearOnClose&&(this.clearOnClose=!0),"failOk"in t&&(this.failOk=t.failOk?!0:!1)},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(t){if(!this.isItem(t))throw new Error(this.declaredClass+": Invalid item argument.")},_assertIsAttribute:function(t){if("string"!=typeof t)throw new Error(this.declaredClass+": Invalid attribute argument.")},getValue:function(t,e,r){var s=this.getValues(t,e);return s.length>0?s[0]:r},getValues:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),(t[e]||[]).slice(0)},getAttributes:function(t){this._assertIsItem(t);var e=[];for(var r in t)r!==this._storeRefPropName&&r!==this._itemNumPropName&&r!==this._rootItemPropName&&r!==this._reverseRefMap&&e.push(r);return e},hasAttribute:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),e in t},containsValue:function(t,e,r){var s=void 0;return"string"==typeof r&&(s=l.patternToRegExp(r,!1)),this._containsValue(t,e,r,s)},_containsValue:function(t,r,i,a){return s.some(this.getValues(t,r),function(t){if(null!==t&&!e.isObject(t)&&a){if(t.toString().match(a))return!0}else if(i===t)return!0})},isItem:function(t){return t&&t[this._storeRefPropName]===this&&this._arrayOfAllItems[t[this._itemNumPropName]]===t?!0:!1},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(t){this._assertIsItem(t.item)},getFeatures:function(){return this._features},getLabel:function(t){return this._labelAttr&&this.isItem(t)?this.getValue(t,this._labelAttr):void 0},getLabelAttributes:function(t){return this._labelAttr?[this._labelAttr]:null},filter:function(t,e,r){var s,i,a=[];if(t.query){var n,o=t.queryOptions?t.queryOptions.ignoreCase:!1,h={};for(i in t.query)n=t.query[i],"string"==typeof n?h[i]=l.patternToRegExp(n,o):n instanceof RegExp&&(h[i]=n);for(s=0;s<e.length;++s){var d=!0,u=e[s];if(null===u)d=!1;else for(i in t.query)n=t.query[i],this._containsValue(u,i,n,h[i])||(d=!1);d&&a.push(u)}r(a,t)}else{for(s=0;s<e.length;++s){var _=e[s];null!==_&&a.push(_)}r(a,t)}},_fetchItems:function(r,s,a){var l=this;if(this._loadFinished)this.filter(r,this._getItemsArray(r.queryOptions),s);else if(this._jsonFileUrl!==this._ccUrl?(t.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:r,filter:e.hitch(l,"filter"),findCallback:e.hitch(l,s)});else{this._loadInProgress=!0;var n={url:l._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},o=i.get(n);o.addCallback(function(t){try{l._getItemsFromLoadedData(t),l._loadFinished=!0,l._loadInProgress=!1,l.filter(r,l._getItemsArray(r.queryOptions),s),l._handleQueuedFetches()}catch(e){l._loadFinished=!0,l._loadInProgress=!1,a(e,r)}}),o.addErrback(function(t){l._loadInProgress=!1,a(t,r)});var h=null;r.abort&&(h=r.abort),r.abort=function(){var t=o;t&&-1===t.fired&&(t.cancel(),t=null),h&&h.call(r)}}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,l.filter(r,this._getItemsArray(r.queryOptions),s)}catch(d){a(d,r)}else a(new Error(this.declaredClass+": No JSON source data was provided as either URL or a nested Javascript object."),r)},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var t=0;t<this._queuedFetches.length;t++){var e=this._queuedFetches[t],r=e.args,s=e.filter,i=e.findCallback;s?s(r,this._getItemsArray(r.queryOptions),i):this.fetchItemByIdentity(r)}this._queuedFetches=[]}},_getItemsArray:function(t){return t&&t.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(t){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&(!(""!=this._jsonFileUrl&&null!=this._jsonFileUrl||""!=this.url&&null!=this.url||null!=this.data),this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(t){function r(t){return null!==t&&"object"==typeof t&&(!e.isArray(t)||i)&&!e.isFunction(t)&&(t.constructor==Object||e.isArray(t))&&"undefined"==typeof t._reference&&"undefined"==typeof t._type&&"undefined"==typeof t._value&&a.hierarchical}function s(t){a._arrayOfAllItems.push(t);for(var i in t){var l=t[i];if(l)if(e.isArray(l))for(var n=l,o=0;o<n.length;++o){var h=n[o];r(h)&&s(h)}else r(l)&&s(l)}}var i=!1,a=this;this._labelAttr=t.label;var l,n;for(this._arrayOfAllItems=[],this._arrayOfTopLevelItems=t.items,l=0;l<this._arrayOfTopLevelItems.length;++l)n=this._arrayOfTopLevelItems[l],e.isArray(n)&&(i=!0),s(n),n[this._rootItemPropName]=!0;var o,h={};for(l=0;l<this._arrayOfAllItems.length;++l){n=this._arrayOfAllItems[l];for(o in n){if(o!==this._rootItemPropName){var d=n[o];null!==d?e.isArray(d)||(n[o]=[d]):n[o]=[null]}h[o]=o}}for(;h[this._storeRefPropName];)this._storeRefPropName+="_";for(;h[this._itemNumPropName];)this._itemNumPropName+="_";for(;h[this._reverseRefMap];)this._reverseRefMap+="_";var u,_=t.identifier;if(_)for(this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=_,l=0;l<this._arrayOfAllItems.length;++l){n=this._arrayOfAllItems[l],u=n[_];var c=u[0];if(Object.hasOwnProperty.call(this._itemsByIdentity,c)){if(this._jsonFileUrl)throw new Error(this.declaredClass+":  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+_+"].  Value collided: ["+c+"]");if(this._jsonData)throw new Error(this.declaredClass+":  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+_+"].  Value collided: ["+c+"]")}else this._itemsByIdentity[c]=n}else this._features["dojo.data.api.Identity"]=Number;for(l=0;l<this._arrayOfAllItems.length;++l)n=this._arrayOfAllItems[l],n[this._storeRefPropName]=this,n[this._itemNumPropName]=l;for(l=0;l<this._arrayOfAllItems.length;++l){n=this._arrayOfAllItems[l];for(o in n){u=n[o];for(var f=0;f<u.length;++f)if(d=u[f],null!==d&&"object"==typeof d){if("_type"in d&&"_value"in d){var m=d._type,p=this._datatypeMap[m];if(!p)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+m+"'");if(e.isFunction(p))u[f]=new p(d._value);else{if(!e.isFunction(p.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");u[f]=p.deserialize(d._value)}}if(d._reference){var y=d._reference;if(e.isObject(y))for(var I=0;I<this._arrayOfAllItems.length;++I){var g=this._arrayOfAllItems[I],v=!0;for(var j in y)g[j]!=y[j]&&(v=!1);v&&(u[f]=g)}else u[f]=this._getItemByIdentity(y);if(this.referenceIntegrity){var F=u[f];this.isItem(F)&&this._addReferenceToMap(F,n,o)}}else this.isItem(d)&&this.referenceIntegrity&&this._addReferenceToMap(d,n,o)}}}},_addReferenceToMap:function(t,e,r){},getIdentity:function(t){var e=this._features["dojo.data.api.Identity"];if(e===Number)return t[this._itemNumPropName];var r=t[e];return r?r[0]:null},fetchItemByIdentity:function(e){var r,s;if(this._loadFinished)r=this._getItemByIdentity(e.identity),e.onItem&&(s=e.scope?e.scope:t.global,e.onItem.call(s,r));else{var a=this;if(this._jsonFileUrl!==this._ccUrl?(t.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&null==this._jsonData&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:e});else{this._loadInProgress=!0;var l={url:a._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk},n=i.get(l);n.addCallback(function(s){var i=e.scope?e.scope:t.global;try{a._getItemsFromLoadedData(s),a._loadFinished=!0,a._loadInProgress=!1,r=a._getItemByIdentity(e.identity),e.onItem&&e.onItem.call(i,r),a._handleQueuedFetches()}catch(l){a._loadInProgress=!1,e.onError&&e.onError.call(i,l)}}),n.addErrback(function(r){if(a._loadInProgress=!1,e.onError){var s=e.scope?e.scope:t.global;e.onError.call(s,r)}})}else this._jsonData&&(a._getItemsFromLoadedData(a._jsonData),a._jsonData=null,a._loadFinished=!0,r=a._getItemByIdentity(e.identity),e.onItem&&(s=e.scope?e.scope:t.global,e.onItem.call(s,r)))}},_getItemByIdentity:function(t){var e=null;return this._itemsByIdentity?Object.hasOwnProperty.call(this._itemsByIdentity,t)&&(e=this._itemsByIdentity[t]):Object.hasOwnProperty.call(this._arrayOfAllItems,t)&&(e=this._arrayOfAllItems[t]),void 0===e&&(e=null),e},getIdentityAttributes:function(t){var e=this._features["dojo.data.api.Identity"];return e===Number?null:[e]},_forceLoad:function(){var e=this;if(this._jsonFileUrl!==this._ccUrl?(t.deprecated(this.declaredClass+": ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this._ccUrl=this._jsonFileUrl,this.url=this._jsonFileUrl):this.url!==this._ccUrl&&(this._jsonFileUrl=this.url,this._ccUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl){var r={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0},s=i.get(r);s.addCallback(function(t){try{if(e._loadInProgress===!0||e._loadFinished){if(e._loadInProgress)throw new Error(this.declaredClass+":  Unable to perform a synchronous load, an async load is in progress.")}else e._getItemsFromLoadedData(t),e._loadFinished=!0}catch(r){throw r}}),s.addErrback(function(t){throw t})}else this._jsonData&&(e._getItemsFromLoadedData(e._jsonData),e._jsonData=null,e._loadFinished=!0)}});return e.extend(h,n),h});
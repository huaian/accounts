define("kaiView/pc/view/index",["../viewUtils/index","dijit/Tree","data/store/c.common.store","dojo/store/Memory","dijit/tree/ObjectStoreModel","../widget/dijit/views_states_dialog","../widget/dijit/change_password_dialog","page/viewFactory","dijit/registry","dojo/topic","../events/index","dojo/on","dijit/Tree","dijit/layout/TabContainer","dijit/layout/BorderContainer","dijit/layout/AccordionContainer","dojox/layout/ExpandoPane","dijit/Toolbar","dojo/domReady!","dojox/validate/web","dijit/form/ValidationTextBox"],function(e,t,i,o,a,r,n,s,d,l,c,u){"use strict";var w=s.create("appBaseView"),p=i.UserStore.getInstance(),h={createNavigationTree:function(e){var i=this,e=i.authRequired&&!i.useLocalMenuTree?p.getAttr("menuTree"):e;return i.store.setAttr("navigationItems",e),e&&_.isArray(e)?(_.map(e,function(e){e.parent||(e.parent="root")}),e.push({id:"root",name:"root"}),i.treeStore=new o({data:e,getChildren:function(e){return this.query({parent:e.id})}}),i.treeModel=new a({store:i.treeStore,query:{id:"root"},mayHaveChildren:function(e){return!e.leaf}}),i.navTree=new t({id:"rootlessTree"+i.contextPostfix,model:i.treeModel,showRoot:!1,openOnClick:!0,autoExpand:!0}),i.navTree.placeAt(i.$el.find("#navigation")[0]),void i.navTree.startup()):(Kai.forward(Kai.loginUrl),!1)},showChangePasswordDialog:function(){var e=this;e.change_password_dialog=new n({widgetData:{},view:e,force:!!p.getAttr("needChangePassword"),requireMD5Encrypt:e.requireMD5Encrypt}),e.change_password_dialog.startup(),e.change_password_dialog.show()},forwardToChildView:function(e,t,i){var o=this;return _.isString(t)?(t.indexOf("pc/view")<0&&(t=t.replace("pc/","pc/view/")),void $.proxy(h.selectChildWidget,o)(t)):!1},selectChildWidget:function(e){var t=this;if(!_.isString(e)||_.isEmpty(e))return!1;var i=function(){t.els.topTabs.domNode.style.display="block"},o=function(){_.contains(t.els.topTabs.getChildren(),a)?t.hideLoading():t.els.topTabs.addChild(a),t.els.topTabs.selectChild(t.registry.byId(e))};i();var a=t.registry.byId(e);a?a.isRecreated?(t.model.set("currentChildViewName",e,{silent:!0}),o(),Kai.forward(e,{keepURL:!0})):(u(a,"close",function(e,i){var o=Kai.views.findWhere({viewName:t.removeContextPostfix(i.id)});if(o){var a=o.get("viewInstance");a&&a.destroy()}t.model.unset("currentChildViewName",{silent:!0})}),t.model.set("currentChildViewName",e,{silent:!0}),o(),Kai.forward(e,{keepURL:!0})):(t.reparse(t.viewData,{templateFunctionId:e,clear:!1,needDojoParse:!0,callback:function(){}}),_.defer(function(){a=t.registry.byId(e),a&&(a.isRecreated=!0,u(a,"close",function(e,i){var o=Kai.views.findWhere({viewName:t.removeContextPostfix(i.id)});if(o&&_.isObject(o)){var a=o.get("viewInstance");a&&a.destroy&&a.destroy()}t.model.unset("currentChildViewName",{silent:!0})}),a.isLoaded?(t.model.set("currentChildViewName",e,{silent:!0}),Kai.forward(e,{keepURL:!0})):u(a,"load",function(){t.model.set("currentChildViewName",e,{silent:!0}),Kai.forward(e,{keepURL:!0})}),o())}))},showUserInfo:function(){var e=this,t=p.getAttr("user");_.isObject(t)&&(e.$el.find("#username_login").html("登录名:"+(t.chinesename||"")),e.$el.find("#position_login").html("职位:"+(t.stationname||"")))}},g=w.extend({els:{main_container:{selector:"pc/index"},topTabs:{selector:"pc_index_main_tab_container"},rootlessNavTree:{selector:"rootlessTree"},logoutButton:{selector:"pc/index_logout"},changePassButton:{selector:"pc/change_password"},restartButton:{selector:"pc/index_restart"},refresh:{selector:"pc/index_refresh"},showCode:{selector:"pc/show_code"},reload:{selector:"pc/index_reload"},viewStatesButton:{selector:"pc/index_button_view-states"},interfacesStatesButton:{selector:"pc/index_button_interfaces-states"},navigation:{selector:"navigation"},headerLogo:{type:"jquery",selector:".header-logo"},closeAllTabsButton:{selector:"pc/index_close-all-tabs"},userInfo:{selector:"#userInfo",type:"jquery"}},triggerCreateCheck:function(){var e=this;return e.authRequired&&!e.isLogin()?(e.triggerCreate=!1,e.forward(Kai.loginUrl,{keepURL:!0}),!1):!0},onCreate:function(){var e=this;$.proxy(h.createNavigationTree,e)(e.menuTree)},prepareEvents:function(){var e=this;e.event=c},prepareViewData:function(){var e=this;e.turnOn()},listenToModel:function(){var t=this;t.model.on({"change:currentChildViewName":$.proxy(h.forwardToChildView,t),"change:need_showViewsStatesDialog":$.proxy(e.showViewsStatesDialog,t),"change:need_showInterfacesStatesDialog":$.proxy(e.showInterfacesStatesDialog,t),"change:need_showChangePasswordDialog":$.proxy(h.showChangePasswordDialog,t)})},getVueData:function(){var e=this;return{user:p.getAttr("user"),version:dojo.config.cacheBust.match(/_v=(\w{0,}).{0,1}\w{0,}_k/)[1],headerTitle:e.headerTitle}},afterShow:function(){},onShow:function(){var e=this;e.isFirstLoad||(window.onbeforeunload=null,Kai.restart()),p.getAttr("needChangePassword")&&(e.model.set("need_showChangePasswordDialog",!0),e.model.unset("need_showChangePasswordDialog",{silent:!0})),$.proxy(h.showUserInfo,e)(),Kai.hideLoading()},prepareViewUtils:function(){var t=this;t.viewUtils=e},parseTempate:function(){var e=this,t=_.template("<%_.each(indexLevelViewList,function(viewItem){%><script type='text/template' style='display: none;' data-templateFunctionid='<%=viewItem.id%>' data-dojo-id='<%=viewItem.id%>' class='kai_widget' data-parseonload='false' data-dojo-avoidreparse='true' data-avoidreparse='true'> <div> <a data-dojo-type='dijit/layout/LinkPane' id='<%=viewItem.id%>' data-viewname='<%=viewItem.id%>' data-dojo-props=\"preload:true,parseOnLoad:false,doLayout:false,style:'display:none;',closable:true, title:'<%=viewItem.title || viewItem.nodeName%>'\"></a> </div></script><%});%>"),i=_.filter(Kai.viewCollectionData,{indexLevel:!0}),o=t({indexLevelViewList:i});e.$el.find(".viewContainer").append(o)},onHide:function(){var e=this;e.hideLoading()}});return g});
define("kaiView/h5/view/login/viewUtils/login",["appConfig/const","cutil/c.util.common","cutil/c.util.validate","data/restStore/factory"],function(e,t,o,r){"use strict";var a={hasValidFormData:function(e){var t=this,e=e||{},o=JSON.parse(JSON.stringify(t.vm.$data.formData));return t.memoryStore.setAttr("memory.formData",o),t.vm.$data.formData[t.viewData.idNameAttribute]?t.vm.$data.formData[t.viewData.passwordNameAttribute]?e.captchaRequired&&t.needSupermarket&&!t.vm.$data.formData[t.viewData.storeNameAttribute]?(t.showErrorTip({tipMessage:"请选择驻点商超"}),!1):e.captchaRequired&&!t.vm.$data.formData[t.viewData.captchaNameAttribute]?(t.showErrorTip({tipMessage:"请输入验证码"}),!1):o:(t.showErrorTip({tipMessage:"请输入密码"}),!1):(t.showErrorTip({tipMessage:"请输入用户名"}),!1)},sendLoginRequest:function(e){var t=this;t._loginComm.add(_.extend(e||{},{url:Kai.getUrlWithoutHash()})).then(function(o){t.isSucceedResponse(o)?(t.setUserStore(o.body.userInfo||o.body),t.setBeeSignatureStore?(t.setBeeSignatureStore&&t.setBeeSignatureStore(o.body.beeSignature),t.model.trigger("beeSignature",o.body.beeSignature,{successCallback:function(o){t.hideLoading(),t.needLoginInfo&&t.parentStore.setAttr("loginInfo",{storeName:o.body.storeName,storeCode:o.body.storeCode,userId:e.userId||e.loginId}),t.showToast({text:"登录成功！",callback:function(){t.forward(t.successUrl?t.successUrl:"h5/view/mobile_index")}})},errorCallback:function(e){e.errorCode;t.forward("h5/view/mobile_index")}})):(t.needLoginInfo&&t.parentStore.setAttr("loginInfo",{storeName:o.body.storeName,storeCode:o.body.storeCode,userId:e.userId||e.loginId}),t.showToast({text:"登录成功！",callback:function(){t.forward(t.successUrl?t.successUrl:"h5/view/mobile_index")}}))):t.showResponseError(o)},function(e){t.showResponseError(e)})},login:function(e){var t=this,o=null;return e&&$(e.target).hasClass("disabled")?!1:void((o=$.proxy(a.hasValidFormData,t)({captchaRequired:t.captchaRequired}))&&(t.showLoading({datamodel:{style:"toast",data:{text:"正在登录,请耐心等待……"}}}),t.needSupermarket&&(o.storeName=(t.els.js_select_store.find("option:selected").text()||"").trim(),o.latitude="",o.longitude=""),alert("try to sign with url: "+Kai.getUrlWithoutHash()),t.needPositionInfo?t.getPosition(function(e){alert("latitude: "+e.coords.latitude),alert("longitude: "+e.coords.longitude),t.model.trigger("sendLoginRequest",_.extend(o,{longitude:e.coords.longitude,latitude:e.coords.latitude}))},function(){t.model.trigger("sendLoginRequest",o)},t.positionTimeout||2e4):t.model.trigger("sendLoginRequest",o)))},enableSendVerifyCodeButton:function(){var e=this;e.countDownTimeHandler&&clearTimeout(e.countDownTimeHandler),e.els.sendVerifyCodeButton.html("发送验证码").removeClass("disabled")},countDown:function(e,t){var o=this;return t.html(e+"秒后可重新获取").addClass("disabled"),--e>0?void(o.countDownTimeHandler=setTimeout(function(){a.countDown(e,t)},1e3)):void t.html("发送验证码").removeClass("disabled")},sendVerifyCode:function(e){var t=this,o=null;return e&&$(e.target).hasClass("disabled")?!1:(o=$.proxy(a.hasValidFormData,t)({}))?($.proxy(t.viewUtils.countDown,t)(60,t.els.sendVerifyCodeButton),void t._getVerificationCodeComm.add(o).then(function(e){if(t.isSucceedResponse(e)){var o=e.body.obj?e.body.obj.mobile:e.body.phone?e.body.phone:"";t.showToast({text:"我们已向您的["+o+"]手机发送了验证码，有效期为5分钟"})}else t.showResponseError(e),$.proxy(a.enableSendVerifyCodeButton,t)()},function(e){return t.showResponseError(e),$.proxy(a.enableSendVerifyCodeButton,t)(),!1})):!1},supermarketDictionary:function(){var e=this;e.viewData.dictData=e.viewData.dictData||{};var t={id:e.supermarketCode},o=[t];_.each(o,function(t){e.viewData.dictData[t.id]=[],r.createDictStore(t.id).get("").then(function(o){e.viewData.dictData[t.id]=o})})}};return a});
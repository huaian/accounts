define("dojox/grid/enhanced/plugins/CellMerge",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/html","../_Plugin","../../EnhancedGrid"],function(e,t,r,i,o,n){var s=e("dojox.grid.enhanced.plugins.CellMerge",o,{name:"cellMerge",constructor:function(e,t){this.grid=e,this._records=[],this._merged={},t&&r.isObject(t)&&this._setupConfig(t.mergedCells),this._initEvents(),this._mixinGrid()},mergeCells:function(e,t,r,i){var o=this._createRecord({row:e,start:t,end:r,major:i});return o&&this._updateRows(o),o},unmergeCells:function(e){var r;e&&(r=t.indexOf(this._records,e))>=0&&(this._records.splice(r,1),this._updateRows(e))},getMergedCells:function(){var e=[];for(var t in this._merged)e=e.concat(this._merged[t]);return e},getMergedCellsByRow:function(e){return this._merged[e]||[]},_setupConfig:function(e){t.forEach(e,this._createRecord,this)},_initEvents:function(){t.forEach(this.grid.views.views,function(e){this.connect(e,"onAfterRow",r.hitch(this,"_onAfterRow",e.index))},this)},_mixinGrid:function(){var e=this.grid;e.mergeCells=r.hitch(this,"mergeCells"),e.unmergeCells=r.hitch(this,"unmergeCells"),e.getMergedCells=r.hitch(this,"getMergedCells"),e.getMergedCellsByRow=r.hitch(this,"getMergedCellsByRow")},_getWidth:function(e){var t=this.grid.layout.cells[e].getHeaderNode();return i.position(t).w},_onAfterRow:function(e,r,o){try{if(0>r)return;var n,s,d=[],a=this._records.length,h=this.grid.layout.cells;for(n=0;a>n;++n){var l=this._records[n],c=this.grid._by_idx[r];if(l.view==e&&l.row(r,c&&c.item,this.grid.store)){var g={record:l,hiddenCells:[],totalWidth:0,majorNode:h[l.major].getNode(r),majorHeaderNode:h[l.major].getHeaderNode()};for(s=l.start;s<=l.end;++s){var u=this._getWidth(s,r);g.totalWidth+=u,s!=l.major&&g.hiddenCells.push(h[s].getNode(r))}if(1!=o.length||g.totalWidth>0){for(s=d.length-1;s>=0;--s){var f=d[s].record;(f.start>=l.start&&f.start<=l.end||f.end>=l.start&&f.end<=l.end)&&d.splice(s,1)}d.push(g)}}}this._merged[r]=[],t.forEach(d,function(e){t.forEach(e.hiddenCells,function(e){i.style(e,"display","none")});var o=i.marginBox(e.majorHeaderNode).w-i.contentBox(e.majorHeaderNode).w,n=e.totalWidth;i.isWebKit||(n-=o),i.style(e.majorNode,"width",n+"px"),e.majorNode.setAttribute("colspan",e.hiddenCells.length+1),this._merged[r].push({row:r,start:e.record.start,end:e.record.end,major:e.record.major,handle:e.record})},this)}catch(m){}},_createRecord:function(e){if(this._isValid(e)){e={row:e.row,start:e.start,end:e.end,major:e.major};var t=this.grid.layout.cells;if(e.view=t[e.start].view.index,e.major="number"!=typeof e.major||isNaN(e.major)?e.start:e.major,"number"==typeof e.row){var i=e.row;e.row=function(e){return e===i}}else if("string"==typeof e.row){var o=e.row;e.row=function(e,t,r){try{if(r&&t&&r.getFeatures()["dojo.data.api.Identity"])return r.getIdentity(t)==o}catch(i){}return!1}}if(r.isFunction(e.row))return this._records.push(e),e}return null},_isValid:function(e){var t=this.grid.layout.cells,i=t.length;return r.isObject(e)&&"row"in e&&"start"in e&&"end"in e&&e.start>=0&&e.start<i&&e.end>e.start&&e.end<i&&t[e.start].view.index==t[e.end].view.index&&t[e.start].subrow==t[e.end].subrow&&!("number"==typeof e.major&&(e.major<e.start||e.major>e.end))},_updateRows:function(e){for(var t=null,r=0,i=this.grid.rowCount;i>r;++r){var o=this.grid._by_idx[r];o&&e.row(r,o&&o.item,this.grid.store)&&(this.grid.views.updateRow(r),null===t&&(t=r))}t>=0&&this.grid.scroller.rowHeightChanged(t)}});return n.registerPlugin(s),s});
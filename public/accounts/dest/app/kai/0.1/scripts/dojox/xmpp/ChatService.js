define("dojox/xmpp/ChatService",["dojo","dijit","dojox"],function(e,t,s){e.provide("dojox.xmpp.ChatService"),s.xmpp.chat={CHAT_STATE_NS:"http://jabber.org/protocol/chatstates",ACTIVE_STATE:"active",COMPOSING_STATE:"composing",INACTIVE_STATE:"inactive",PAUSED_STATE:"paused",GONE_STATE:"gone"},e.declare("dojox.xmpp.ChatService",null,{state:"",constructor:function(){this.state="",this.chatid=Math.round(1e15*Math.random())},receiveMessage:function(e,t){e&&!t&&this.onNewMessage(e)},setSession:function(e){this.session=e},setState:function(e){this.state!=e&&(this.state=e)},invite:function(e){if(!this.uid){if(!e||""==e)throw new Error("ChatService::invite() contact is NULL");this.uid=e;var t={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},i=new s.string.Builder(s.xmpp.util.createElement("message",t,!1));i.append(s.xmpp.util.createElement("thread",{},!1)),i.append(this.chatid),i.append("</thread>"),i.append(s.xmpp.util.createElement("active",{xmlns:s.xmpp.chat.CHAT_STATE_NS},!0)),i.append("</message>"),this.session.dispatchPacket(i.toString()),this.onInvite(e),this.setState(s.xmpp.chat.CHAT_STATE_NS)}},sendMessage:function(e){if(this.uid&&(e.body&&""!=e.body||e.xhtml)){var t={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},i=new s.string.Builder(s.xmpp.util.createElement("message",t,!1)),n=s.xmpp.util.createElement("html",{xmlns:s.xmpp.xmpp.XHTML_IM_NS},!1),a=s.xmpp.util.createElement("body",{"xml:lang":this.session.lang,xmlns:s.xmpp.xmpp.XHTML_BODY_NS},!1)+e.body+"</body>",p=s.xmpp.util.createElement("body",{},!1)+s.xmpp.util.stripHtml(e.body)+"</body>";i.subject&&""!=i.subject&&(i.append(s.xmpp.util.createElement("subject",{},!1)),i.append(i.subject),i.append("</subject>")),i.append(p),i.append(n),i.append(a),i.append("</html>"),i.append(s.xmpp.util.createElement("thread",{},!1)),i.append(this.chatid),i.append("</thread>"),this.useChatStates&&i.append(s.xmpp.util.createElement("active",{xmlns:s.xmpp.chat.CHAT_STATE_NS},!0)),i.append("</message>"),this.session.dispatchPacket(i.toString())}},sendChatState:function(e){if(this.useChatState&&!this.firstMessage&&e!=this._currentState){var t={xmlns:"jabber:client",to:this.uid,from:this.session.jid+"/"+this.session.resource,type:"chat"},i=new s.string.Builder(s.xmpp.util.createElement("message",t,!1));i.append(s.xmpp.util.createElement(e,{xmlns:s.xmpp.chat.CHAT_STATE_NS},!0)),this._currentState=e,i.append("<thread>"),i.append(this.chatid),i.append("</thread></message>"),this.session.dispatchPacket(i.toString())}},onNewMessage:function(e){},onInvite:function(e){}})});
define("dojox/data/ItemExplorer",["dojo","dijit","dojox","dojo/require!dijit/Tree,dijit/Dialog,dijit/Menu,dijit/form/ValidationTextBox,dijit/form/Textarea,dijit/form/Button,dijit/form/RadioButton,dijit/form/FilteringSelect"],function(e,t,i){e.provide("dojox.data.ItemExplorer"),e.require("dijit.Tree"),e.require("dijit.Dialog"),e.require("dijit.Menu"),e.require("dijit.form.ValidationTextBox"),e.require("dijit.form.Textarea"),e.require("dijit.form.Button"),e.require("dijit.form.RadioButton"),e.require("dijit.form.FilteringSelect"),function(){var i=function(e,t,i){var r=e.getValues(t,i);return r.length<2&&(r=e.getValue(t,i)),r};e.declare("dojox.data.ItemExplorer",t.Tree,{useSelect:!1,refSelectSearchAttr:null,constructor:function(t){e.mixin(this,t);var r=this,o={},a=this.rootModelNode={value:o,id:"root"};this._modelNodeIdMap={},this._modelNodePropMap={};var n=1;this.model={getRoot:function(e){e(a)},mayHaveChildren:function(e){return e.value&&"object"==typeof e.value&&!(e.value instanceof Date)},getChildren:function(e,t,a){function n(){if(u)d=r.store.getAttributes(s),l=s;else if(s&&"object"==typeof s){l=e.value,d=[];for(var o in s)s.hasOwnProperty(o)&&"__id"!=o&&"__clientId"!=o&&d.push(o)}if(d){for(var a,n=0;a=d[n++];)c.push({property:a,value:u?i(r.store,s,a):s[a],parent:l});c.push({addNew:!0,parent:l,parentNode:e})}t(c)}var d,l,s=e.value,c=[];if(s==o)return void t([]);var u=r.store&&r.store.isItem(s,!0);u&&!r.store.isItemLoaded(s)?r.store.loadItem({item:s,onItem:function(e){s=e,n()}}):n()},getIdentity:function(e){if(!e.id&&(e.addNew&&(e.property="--addNew"),e.id=n++,r.store)){if(r.store.isItem(e.value)){var t=r.store.getIdentity(e.value);(r._modelNodeIdMap[t]=r._modelNodeIdMap[t]||[]).push(e)}e.parent&&(t=r.store.getIdentity(e.parent)+"."+e.property,(r._modelNodePropMap[t]=r._modelNodePropMap[t]||[]).push(e))}return e.id},getLabel:function(e){return e===a?"Object Properties":e.addNew?e.parent instanceof Array?"Add new value":"Add new property":e.property+": "+(e.value instanceof Array?"("+e.value.length+" elements)":e.value)},onChildrenChange:function(e){},onChange:function(e){}}},postCreate:function(){this.inherited(arguments),e.connect(this,"onClick",function(e,t){this.lastFocused=t,e.addNew?this._addProperty():this._editProperty()});var i=new t.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});e.connect(i,"_openMyself",this,function(r){var o=t.getEnclosingWidget(r.target);if(o){var a=o.item;this.store.isItem(a.value,!0)&&!a.parent?(e.forEach(i.getChildren(),function(e){e.attr("disabled","Add"!=e.label)}),this.lastFocused=o):!a.value||"object"!=typeof a.value||a.value instanceof Date?a.property&&e.indexOf(this.store.getIdentityAttributes(),a.property)>=0?(this.focusNode(o),alert("Cannot modify an Identifier node.")):a.addNew?this.focusNode(o):(e.forEach(i.getChildren(),function(e){e.attr("disabled","Edit"!=e.label&&"Delete"!=e.label)}),this.lastFocused=o):(e.forEach(i.getChildren(),function(e){e.attr("disabled","Add"!=e.label&&"Delete"!=e.label)}),this.lastFocused=o)}}),i.addChild(new t.MenuItem({label:"Add",onClick:e.hitch(this,"_addProperty")})),i.addChild(new t.MenuItem({label:"Edit",onClick:e.hitch(this,"_editProperty")})),i.addChild(new t.MenuItem({label:"Delete",onClick:e.hitch(this,"_destroyProperty")})),i.startup()},store:null,setStore:function(t){this.store=t;var i=this;this._editDialog&&(this._editDialog.destroyRecursive(),delete this._editDialog),e.connect(t,"onSet",function(e,t,r,o){var a,n,d=i.store.getIdentity(e);if(a=i._modelNodeIdMap[d],a&&(void 0===r||void 0===o||r instanceof Array||o instanceof Array||"object"==typeof r||"object"==typeof o))for(n=0;n<a.length;n++)!function(e){i.model.getChildren(e,function(t){i.model.onChildrenChange(e,t)})}(a[n]);if(a=i._modelNodePropMap[d+"."+t])for(n=0;n<a.length;n++)a[n].value=o,i.model.onChange(a[n])}),this.rootNode.setChildItems([])},setItem:function(e){(this._modelNodeIdMap={})[this.store.getIdentity(e)]=[this.rootModelNode],this._modelNodePropMap={},this.rootModelNode.value=e;var t=this;this.model.getChildren(this.rootModelNode,function(e){t.rootNode.setChildItems(e)})},refreshItem:function(){this.setItem(this.rootModelNode.value)},_createEditDialog:function(){this._editDialog=new t.Dialog({title:"Edit Property",execute:e.hitch(this,"_updateItem"),preload:!0}),this._editDialog.placeAt(e.body()),this._editDialog.startup();var i=e.doc.createElement("div"),r=e.doc.createElement("label");e.attr(r,"for","property"),e.style(r,"fontWeight","bold"),e.attr(r,"innerHTML","Property:"),i.appendChild(r);new t.form.ValidationTextBox({name:"property",value:"",required:!0,disabled:!0}).placeAt(i);i.appendChild(e.doc.createElement("br")),i.appendChild(e.doc.createElement("br"));var o=(new t.form.RadioButton({name:"itemType",value:"value",onClick:e.hitch(this,function(){this._enableFields("value")})}).placeAt(i),e.doc.createElement("label"));e.attr(o,"for","value"),e.attr(o,"innerHTML","Value (JSON):"),i.appendChild(o);var a=e.doc.createElement("div");e.addClass(a,"value");new t.form.Textarea({name:"jsonVal"}).placeAt(a);i.appendChild(a);var n=(new t.form.RadioButton({name:"itemType",value:"reference",onClick:e.hitch(this,function(){this._enableFields("reference")})}).placeAt(i),e.doc.createElement("label"));e.attr(n,"for","_reference"),e.attr(n,"innerHTML","Reference (ID):"),i.appendChild(n),i.appendChild(e.doc.createElement("br"));var d=e.doc.createElement("div");if(e.addClass(d,"reference"),this.useSelect){new t.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:!1,value:null,pageSize:10}).placeAt(d)}else{new t.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",isValid:e.hitch(this,function(e){return!0})}).placeAt(d)}i.appendChild(d),i.appendChild(e.doc.createElement("br")),i.appendChild(e.doc.createElement("br"));var l=document.createElement("div");l.setAttribute("dir","rtl");var s=new t.form.Button({type:"reset",label:"Cancel"}).placeAt(l);s.onClick=e.hitch(this._editDialog,"onCancel");new t.form.Button({type:"submit",label:"OK"}).placeAt(l);i.appendChild(l),this._editDialog.attr("content",i)},_enableFields:function(i){switch(i){case"reference":e.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!0)}),e.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!1)});break;case"value":e.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!1)}),e.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!0)})}},_updateItem:function(t){function r(){try{var e,r=[],s=t.property;if(l){for(;!c.isItem(a.parent,!0);)o=o.getParent(),r.push(a.property),a=o.item;if(0==r.length)c.setValue(a.parent,a.property,n);else{for(d=i(c,a.parent,a.property),d instanceof Array&&(d=d.concat()),e=d;r.length>1;)e=e[r.pop()];e[r]=n,c.setValue(a.parent,a.property,d)}}else if(c.isItem(u,!0))c.isItemLoaded(u)?(u instanceof Array&&(s=u.length),c.setValue(u,s,n)):c.loadItem({item:u,onItem:function(e){e instanceof Array&&(s=e.length),c.setValue(e,s,n)}});else{for(a.value instanceof Array?r.push(a.value.length):r.push(t.property);!c.isItem(a.parent,!0);)o=o.getParent(),r.push(a.property),a=o.item;for(d=i(c,a.parent,a.property),e=d;r.length>1;)e=e[r.pop()];e[r]=n,c.setValue(a.parent,a.property,d)}}catch(h){alert(h)}}var o,a,n,d,l="Edit Property"==this._editDialog.attr("title"),s=this._editDialog,c=this.store;if(s.validate()){o=this.lastFocused,a=o.item;var u=a.value;switch(a.addNew&&(u=o.item.parent,o=o.getParent(),a=o.item),n=null,t.itemType){case"reference":this.store.fetchItemByIdentity({identity:t._reference,onItem:function(e){n=e,r()},onError:function(){alert("The id could not be found")}});break;case"value":var h=t.jsonVal;n=e.fromJson(h),"function"==typeof n&&(n.toString=function(){return h}),r()}}else s.show()},_editProperty:function(){var i=e.mixin({},this.lastFocused.item);this._editDialog?this._editDialog.reset():this._createEditDialog(),e.indexOf(this.store.getIdentityAttributes(),i.property)>=0?alert("Cannot Edit an Identifier!"):(this._editDialog.attr("title","Edit Property"),t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!0),this.store.isItem(i.value,!0)?i.parent&&(i.itemType="reference",this._enableFields(i.itemType),i._reference=this.store.getIdentity(i.value),this._editDialog.attr("value",i),this._editDialog.show()):(!i.value||"object"!=typeof i.value||i.value instanceof Date)&&(i.itemType="value",this._enableFields(i.itemType),i.jsonVal="function"==typeof i.value?i.value.toString():i.value instanceof Date?'new Date("'+i.value+'")':e.toJson(i.value),this._editDialog.attr("value",i),this._editDialog.show()))},_destroyProperty:function(){for(var t=this.lastFocused,r=t.item,o=[];!this.store.isItem(r.parent,!0)||r.parent instanceof Array;)t=t.getParent(),o.push(r.property),r=t.item;if(e.indexOf(this.store.getIdentityAttributes(),r.property)>=0)alert("Cannot Delete an Identifier!");else try{if(o.length>0){var a,n=i(this.store,r.parent,r.property);for(a=n;o.length>1;)a=a[o.pop()];e.isArray(a)?a.splice(o,1):delete a[o],this.store.setValue(r.parent,r.property,n)}else this.store.unsetAttribute(r.parent,r.property)}catch(d){alert(d)}},_addProperty:function(){var i=this.lastFocused.item,r=i.value,o=e.hitch(this,function(){var i=null;this._editDialog?this._editDialog.reset():this._createEditDialog(),r instanceof Array?(i=r.length,t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!0)):t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!1),this._editDialog.attr("title","Add Property"),this._enableFields("value"),this._editDialog.attr("value",{itemType:"value",property:i}),this._editDialog.show()});i.addNew&&(i=this.lastFocused.getParent().item,r=this.lastFocused.item.parent),i.property&&e.indexOf(this.store.getIdentityAttributes(),i.property)>=0?alert("Cannot add properties to an ID node!"):this.store.isItem(r,!0)&&!this.store.isItemLoaded(r)?this.store.loadItem({item:r,onItem:function(e){r=e,o()}}):o()}})}()});